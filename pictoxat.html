<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoJocs & PictoXat</title>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Dancing+Script:wght@400;700&family=Fredoka:wght@400;600&family=Indie+Flower&family=Patrick+Hand&family=Roboto&family=Comic+Neue:wght@400;700&family=Schoolbell&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root{--color-fons:#f0f8ff;--color-principal:#4a90e2;--color-secundari:#f39c12;--color-accio:#27ae60;--mida-font-base:18px;--tipus-font:'Arial',sans-serif;--color-font:#000000;--num-columnes:3;--width-paper:210mm;--height-paper:297mm;--targeta-bg:#ffffff;--targeta-border:#000000;--targeta-text:#000000}
        body{font-family:'Segoe UI',sans-serif;margin:0;padding:20px;background-color:#fdfbf7;background-image:linear-gradient(#e1e1e1 1px,transparent 1px),linear-gradient(90deg,#e1e1e1 1px,transparent 1px);background-size:20px 20px}
        .configuracio{background-color:#fff;padding:20px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);max-width:950px;margin:0 auto 20px;border-left:10px solid var(--color-principal);position:relative}
        .projecte-controls{display:flex;justify-content:flex-end;gap:8px;margin-bottom:5px;align-items:center}
        .btn-nav-app{background:#8e44ad;color:#fff;border:none;padding:5px 10px;font-size:.9em;border-radius:6px;cursor:pointer;font-weight:bold;transition:.2s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
        .btn-nav-app:hover{transform:scale(1.05)}
        .btn-mini{background:#ecf0f1;border:1px solid #bdc3c7;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:.85em;font-weight:bold;color:#333;display:flex;align-items:center;gap:5px;transition:.2s}
        .btn-mini:hover{background:#d5dbdb}
        .header-app{display:flex;align-items:center;justify-content:center;gap:15px;margin-top:25px;margin-bottom:20px;text-align:center}
        .header-app h1{margin:0;color:#2c3e50;font-size:3em;letter-spacing:1px}
        .logo-pictojocs{height:95px;width:auto}
        .fila-flex{display:flex;gap:20px;margin-bottom:15px;align-items:flex-end}
        .columna{flex:1}
        label{display:block;margin-bottom:5px;font-weight:bold;color:#555;font-size:.9em}
        input[type="text"],input[type="email"],select,textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box}
        .input-logo-wrapper{border:2px dashed #ccc;padding:8px;border-radius:8px;text-align:center;cursor:pointer;transition:all .3s;background:#fafafa;font-size:.9em;color:#777;display:flex;align-items:center;justify-content:center;gap:5px}
        .input-logo-wrapper:hover{border-color:var(--color-principal);color:var(--color-principal)}
        .input-logo-wrapper.feteservir{border-style:solid;border-color:var(--color-accio);background-color:#e8f8f5;color:var(--color-accio);font-weight:bold}
        .barra-estils{background:#eef2f7;padding:15px;border-radius:8px;margin-bottom:15px;border:1px solid #d1d9e6;display:flex;gap:15px;align-items:stretch;justify-content:space-between;flex-wrap:wrap}
        .control-estil{display:flex;flex-direction:column;min-width:90px;flex:1}
        .layout-metode-paraules{display:flex;gap:20px;margin-bottom:15px;align-items:stretch}
        .panell-metode{flex:.35;background:#fffcf5;padding:15px;border-radius:12px;border:2px solid var(--color-secundari);display:flex;flex-direction:column;justify-content:center}
        .panell-metode label{color:var(--color-secundari);font-size:1.05em;margin-bottom:10px}
        .panell-metode select{font-size:1.1em;border-color:var(--color-secundari);border-width:2px;cursor:pointer;font-weight:bold;color:#333}
        .panell-paraules{flex:.65;display:flex;flex-direction:column}
        .panell-paraules textarea{flex-grow:1;min-height:80px;resize:vertical}
        .btn-container{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
        button{border:none;padding:12px 25px;font-size:16px;border-radius:50px;cursor:pointer;font-weight:bold;color:#fff;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .1s}
        button:active{transform:scale(.98)}
        .btn-generar{background-color:var(--color-principal);flex:2}
        .btn-imprimir{background-color:var(--color-accio);flex:1}
        .btn-ia{background-color:#f5b041;flex:1}
        .btn-domino{background-color:#c39bd3;flex:2;display:none;animation:popIn .3s ease}
        @keyframes popIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
        .instruccions{background-color:#e8f6f3;border:1px solid #a2d9ce;color:#16a085;padding:8px;border-radius:8px;margin-top:15px;font-size:.9em;text-align:center}
        .avis-impressio{margin-top:15px;padding:10px 15px;background-color:#f8f9fa;border-left:4px solid #6c757d;border-radius:4px;color:#444;font-size:.85em;line-height:1.4}
        .avis-impressio strong{color:#2c3e50;font-size:1em;display:block;margin-bottom:5px}
        .avis-impressio ul{margin:0;padding-left:20px}
        .avis-impressio li{margin-bottom:2px}
        .info-doble-cara{display:none;color:inherit;font-weight:normal}
        #zona-impressio{background-color:#fff;padding:15mm;width:var(--width-paper);min-height:var(--height-paper);margin:0 auto;box-shadow:0 0 10px rgba(0,0,0,.1);box-sizing:border-box}
        .header-print{display:grid;grid-template-columns:120px 1fr 120px;align-items:center;margin-bottom:15px;border-bottom:2px solid #eee;padding-bottom:10px;height:70px;overflow:hidden}
        .logo-escola{height:100%;width:auto;max-height:60px;object-fit:contain;display:none}
        .titol-print-container{text-align:center}
        .titol-print-container h2{margin:0;font-size:1.8em;color:#222}
        .curs-print-wrapper{display:flex;flex-direction:column;align-items:flex-end;justify-content:center}
        .big-logo-print{height:70px;width:auto;opacity:1}
        .curs-print{font-size:1.2em;font-weight:bold;color:#555;text-align:right;margin-top:5px}
        .graella{display:grid;grid-template-columns:repeat(var(--num-columnes),1fr);gap:15px;width:100%}
        .zona-revers{display:none;margin-top:50px;border-top:2px dashed #ccc;padding-top:20px}
        .pictograma{border:4px solid var(--targeta-border);border-radius:15px;background-color:var(--targeta-bg);display:flex;flex-direction:column;align-items:center;justify-content:space-between;aspect-ratio:.85;padding:5px;cursor:grab;break-inside:avoid;page-break-inside:avoid;box-sizing:border-box;position:relative;overflow:hidden}
        .pictograma:hover{box-shadow:0 4px 10px rgba(0,0,0,.2)}
        .pictograma.dragging{opacity:.4;border:3px dashed #999;background:#eee}
        .imatge-box{background-color:#fff;border-radius:10px;width:100%;height:85%;display:flex;align-items:center;justify-content:center;padding:5px;box-sizing:border-box;overflow:hidden;flex-shrink:1;position:relative}
        .imatge-box img, .imatge-box video{width:100%;height:100%;object-fit:contain;pointer-events:none}
        .pictograma p{margin:0;width:100%;text-align:center;font-family:var(--tipus-font);color:var(--targeta-text);font-weight:bold;flex-shrink:0;display:flex;align-items:center;justify-content:center;flex-direction:column;min-height:15%;padding-top:2px;overflow:hidden}
        .mode-targeta-front .pictograma .imatge-box{height:100%}
        .mode-targeta-front .pictograma p{display:none}
        .mode-memory-front .pictograma.nomes-img .imatge-box{height:100%}
        .mode-memory-front .pictograma.nomes-img p{display:none}
        .mode-memory-front .pictograma.nomes-text .imatge-box{display:none}
        .mode-memory-front .pictograma.nomes-text p{height:100%;font-size:1.5em;margin-top:0}
        .contingut-back{width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:5px;box-sizing:border-box;overflow:hidden;color:var(--targeta-text)}
        .contingut-back-logo{background-color:#fff;border-radius:10px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;padding:5px;box-sizing:border-box}
        .contingut-back-logo img{width:90%;height:90%;object-fit:contain}
        .mode-domino .graella{grid-template-columns:repeat(2,1fr) !important}
        .mode-domino .pictograma{flex-direction:row;aspect-ratio:2.5/1;padding:4px;gap:0}
        .mode-domino .imatge-box{width:48%;height:100%;order:1;margin:0;padding:2px}
        .separador-domino{display:none;width:3px;height:100%;background-color:var(--targeta-border);margin:0 10px;flex-shrink:0;order:2}
        .mode-domino .separador-domino{display:block}
        .mode-domino .text-domino{order:3;width:48%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;font-family:var(--tipus-font);font-weight:bold;color:var(--targeta-text);overflow:hidden}
        .mode-domino .pictograma p{display:none}
        .fila-paraula{text-align:center;width:100%;font-family:var(--tipus-font);font-weight:bold;color:inherit;line-height:1.2;margin:2px 0;white-space:nowrap}
        .descripcio-traductor{color:#666;margin:0 auto 25px;font-size:1.1em;text-align:center;max-width:800px}
        #desc-traductor:empty{display:none;margin:0}
        .controls-traductor{display:flex;flex-direction:column;gap:15px;justify-content:center;align-items:center;margin-bottom:20px;background:#eef2f7;padding:20px;border-radius:10px;border:1px solid #d1d9e6;max-width:850px;margin:0 auto 20px}
        .controls-traductor select{padding:10px 15px;border-radius:8px;border:2px solid #ddd;font-size:15px;cursor:pointer;font-weight:bold;color:#333;width:100%;min-width:200px}
        .caixa-escriptura{width:100%;display:flex;flex-direction:column;gap:10px}
        .caixa-escriptura textarea{width:100%;box-sizing:border-box;font-size:1.3em;padding:15px;border:2px solid #ddd;border-radius:10px;min-height:80px;resize:vertical;text-align:center}
        .botons-accio{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
        .btn-mic-trad,.btn-trad{color:#fff;border:none;cursor:pointer;font-weight:bold;display:flex;align-items:center;justify-content:center;gap:10px;transition:.3s;padding:15px 30px;font-size:18px;border-radius:50px}
        .btn-mic-trad{background-color:#e74c3c;flex:1;min-width:200px}
        .btn-trad{background-color:var(--color-principal);flex:1;min-width:200px}
        .btn-mic-trad:active,.btn-trad:active{transform:scale(.98)}
        .btn-mic-trad.escoltant{background-color:#27ae60;animation:pulse 1.5s infinite}
        .traduccio-literal-box{font-size:1.2em;color:#2c3e50;margin:15px auto;padding:15px;background:#e8f8f5;border-radius:10px;border:1px dashed #27ae60;display:none;width:80%;text-align:center}
        .frase-pictos{display:flex;flex-wrap:wrap;gap:15px;justify-content:center;min-height:200px;padding:20px;border-radius:15px;align-items:stretch}
        #view-pictotraductor .pictograma{width:180px;cursor:pointer}
        #view-pictotraductor .imatge-box{height:75%}
        #view-pictotraductor .pictograma p{height:25%; padding-top:2px}
        #view-pictotraductor .pictograma.negat .imatge-box{position:relative}
        #view-pictotraductor .pictograma.negat .imatge-box::after{content:'âœ•';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:3.2em;font-weight:900;color:rgba(231,76,60,.92);text-shadow:0 1px 2px rgba(255,255,255,.75);pointer-events:none}
        .text-traduit{font-weight:bold;text-transform:uppercase;color:#000}
        .text-alumne{color:#666;font-style:italic;margin-top:2px;font-weight:normal;text-transform:none;white-space:nowrap}
        .btn-settings{position:absolute;top:15px;right:15px;background:none;border:none;font-size:28px;cursor:pointer;transition:transform .2s;z-index:100}
        .btn-settings:hover{transform:scale(1.1)}
        .loader{border:4px solid #f3f3f3;border-top:4px solid var(--color-principal);border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:10px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .seccio-suggeriments{margin:40px auto 20px;max-width:850px;text-align:center;background-color:#fff;padding:25px;border-radius:15px;border:2px dashed #4a90e2;box-shadow:0 4px 10px rgba(0,0,0,.05)}
        .seccio-suggeriments h3{margin-top:0;color:#2c3e50}
        .seccio-suggeriments p{color:#666;margin-bottom:15px}
        .btn-contacte{background-color:#333;color:#fff;padding:10px 20px;border-radius:30px;font-weight:bold;display:inline-flex;align-items:center;gap:8px;transition:transform .2s}
        .btn-contacte:hover{transform:scale(1.05);background-color:#000}
        .footer-credits{text-align:center;margin-top:20px;padding:15px;font-size:.85em;color:#444;background-color:rgba(255,255,255,.8);border-radius:10px;max-width:600px;margin-left:auto;margin-right:auto}
        #modal-edicio,#modal-settings,#modal-prompt-ia{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;justify-content:center;align-items:center}
        .modal-contingut{background:#fff;border-radius:12px;width:90%;max-width:650px;display:flex;flex-direction:column;max-height:90vh;overflow:hidden}
        .modal-tabs{display:flex;background:#f1f1f1;border-bottom:2px solid #ddd;overflow-x:auto;flex-shrink:0}
        .tab-btn{flex:1;padding:10px 4px;border:none;background:none;cursor:pointer;font-weight:600;color:#666;border-bottom:3px solid transparent;display:flex;align-items:center;justify-content:center;white-space:nowrap;gap:5px;min-width:auto}
        .tab-btn.actiu{border-bottom:3px solid var(--color-principal);color:var(--color-principal);background:#fff;font-weight:bold}
        .modal-body{padding:25px;overflow-y:auto}
        .grup-titol-modal{margin-bottom:20px;text-align:center}
        .inputs-container-modal{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;justify-content:center}
        .input-text-modal{font-size:1.1em;text-align:center;border:2px solid #ddd;padding:8px;border-radius:6px;box-sizing:border-box}
        .dues-paraules .input-text-modal{width:48%}
        .cinc-paraules .input-text-modal:nth-child(1),.cinc-paraules .input-text-modal:nth-child(2){width:calc(50% - 6px)}
        .cinc-paraules .input-text-modal:nth-child(n+3){width:calc(33.33% - 8px)}
        .color-palette{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;gap:10px}
        .color-btn{width:30px;height:30px;border-radius:50%;border:2px solid #ccc;cursor:pointer;transition:.2s;box-sizing:border-box;padding:0}
        .color-btn:hover{transform:scale(1.1);border-color:#333}
        .cerca-wrapper{display:flex;gap:8px;margin-bottom:15px}
        .btn-cerca-modal{background:var(--color-principal);border-radius:8px;padding:10px 20px;font-size:1em;flex-shrink:0;color:#fff;border:none;cursor:pointer}
        .btn-cerca-trad{background:#8e44ad}
        .resultats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .resultats-grid img{width:100%;height:90px;object-fit:contain;border:1px solid #eee;border-radius:8px;cursor:pointer;padding:5px}
        .resultats-grid img:hover{transform:scale(1.05);border-color:var(--color-principal);background:#f0f8ff}
        .grid-traduccions{display:flex;flex-direction:column;gap:10px;margin-top:15px}
        .item-traduccio{display:flex;justify-content:space-between;align-items:center;background:#f8f9fa;padding:10px;border-radius:8px;border:1px solid #eee;cursor:pointer;transition:.2s}
        .item-traduccio:hover{background:#e8f6f3;border-color:#27ae60}
        .lang-code{font-weight:bold;color:#555;background:#ddd;padding:2px 6px;border-radius:4px;font-size:.8em;margin-right:10px}
        .trad-text-modal{font-size:1.1em;color:#333}
        .copy-hint{font-size:.8em;color:#27ae60;opacity:0;transition:.2s}
        .item-traduccio:hover .copy-hint{opacity:1}
        .toolbar-dibuix{display:flex;gap:8px;margin-bottom:5px;align-items:center;flex-wrap:wrap;justify-content:center}
        @media (min-width:600px){.toolbar-dibuix{flex-wrap:nowrap}}
        .btn-color-dibuix{width:30px;height:30px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.3);cursor:pointer;flex-shrink:0;box-sizing:border-box;padding:0}
        .btn-color-dibuix:hover{transform:scale(1.1)}
        .btn-tool{background:#fff;border:1px solid #ccc;font-size:1.2em;border-radius:5px;padding:5px 10px;cursor:pointer;transition:.2s;flex-shrink:0}
        .btn-tool:hover{background:#f0f8ff;border-color:var(--color-principal)}
        .btn-tool.actiu{background:#e8f8f5;border:2px solid var(--color-accio);box-shadow:0 0 5px rgba(39,174,96,.3)}
        .caixa-idiomes-check{max-height:150px;overflow-y:auto;border:2px solid #eee;padding:10px;border-radius:8px;margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:5px;text-align:left;background:#fafafa}
        .caixa-idiomes-check label{margin:0;font-weight:normal;font-size:.9em;display:flex;align-items:center;gap:5px;cursor:pointer}
        @media print{
            @page{margin:0 !important}
            body{background:#fff;padding:0;margin:0;-webkit-print-color-adjust:exact;background-image:none}
            .configuracio,.no-print,#modal-edicio,#modal-settings,#modal-prompt-ia,.avis-impressio{display:none !important}
            #zona-impressio{margin:0 auto;box-shadow:none;padding:10mm;display:block !important}
            #view-pictotraductor .frase-pictos{display:none !important}
            .graella{gap:5px}
            .pictograma{border:2px solid var(--targeta-border)}
            .zona-revers{padding-top:10mm !important;margin-top:0 !important;border:none !important;page-break-before:always;direction:rtl}
            .mode-domino .pictograma{border:3px solid var(--targeta-border)}
            .separador-domino{-webkit-print-color-adjust:exact;background-color:var(--targeta-border) !important}
            .header-print{height:auto;padding-bottom:5px}
            .big-logo-print{height:70px}
        }
        @media screen and (max-width:850px){
            .configuracio{width:auto;margin:10px;padding:15px}
            .fila-flex{flex-direction:column;align-items:stretch;gap:10px}
            .columna,.control-estil{width:100%;flex:auto !important}
            .barra-estils{flex-direction:column;align-items:stretch}
            .colors-container{border-left:none;padding-left:0;margin-top:10px;border-top:2px solid #ddd;padding-top:15px}
            .layout-metode-paraules{flex-direction:column}
            #zona-impressio{width:100% !important;padding:10px;box-sizing:border-box;height:auto;min-height:50vh}
            body{padding:0;background-color:#f0f8ff}
            .btn-container{flex-direction:column}
            .btn-container button{padding:15px;width:100%;font-size:1.1em}
            .botons-accio button{width:100%;padding:15px;font-size:1.1em}
            .modal-contingut{width:95%;height:90vh;max-height:90vh}
            .projecte-controls{justify-content:center;flex-wrap:wrap}
        }
    </style>
</head>
<body>

    <script>
        const RUTA_LOGO_PICTOJOCS = "https://github.com/rrobles4/pictojocs/blob/main/logo%20PictoJocs.png?raw=true";
    </script>

    <div id="view-pictotraductor" style="display: block;">
        <div class="configuracio no-print">
            <div class="projecte-controls" style="justify-content: flex-start; margin-bottom: 15px; display: flex; gap: 8px;">
                <button class="btn-nav-app" style="background:#f5b041;" onclick="obrirSettings()">ğŸ¤– ConfiguraciÃ³ IA</button>
            </div>
            <div class="controls-traductor">
                <div style="display:flex; gap: 15px; width: 100%; justify-content: center; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px;">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <label id="label-idioma-traductor" style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">El teu idioma:</label>
                        <select id="idioma-input" onchange="canviarIdiomaUI()"></select>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-end;">
                        <button onclick="intercanviarIdiomes()" style="background:#f0f0f0; border:2px solid #ccc; border-radius:50%; width:38px; height:38px; font-size:1.2em; cursor:pointer; line-height:1;" title="Intercanvia idiomes">â‡„</button>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <label id="label-idioma-desti" style="font-size:0.9em; font-weight:bold; margin-bottom:5px;">Tradueix a:</label>
                        <select id="idioma-desti"></select>
                    </div>
                </div>
                
                <div class="caixa-escriptura">
                    <textarea id="text-input" placeholder="Escriu la frase aquÃ­ o utilitza el micrÃ²fon..." onkeyup="if(event.key==='Enter') executarTraduccio()"></textarea>
                    <div class="botons-accio">
                        <button id="btn-mic-trad" class="btn-mic-trad" onclick="activarMicrofon()">ğŸ¤ Parlar</button>
                        <button id="btn-trad" class="btn-trad" onclick="executarTraduccio()">â¡ï¸ Traduir</button>
                    </div>
                </div>
            </div>
            <div id="traduccio-literal-box" class="traduccio-literal-box">
                <strong>TraducciÃ³:</strong> <span id="text-traduit-literal"></span>
            </div>
            <div id="resultat-pictos" class="frase-pictos"></div>
        </div>
    </div>

    <div class="seccio-suggeriments no-print">
        <h3>Tens alguna suggerÃ¨ncia?</h3>
        <p>Vols crear algun altre mena de joc o consultar dubtes? EstarÃ© encantat de respondre't!</p>
        <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
            <div style="display:flex; gap:10px; width:100%;">
                <input type="email" id="sugg-email" placeholder="El teu correu electrÃ²nic" style="flex:1;">
                <input type="text" id="sugg-assumpte" placeholder="Assumpte" style="flex:1;">
            </div>
            <textarea id="sugg-missatge" placeholder="Escriu el teu missatge aquÃ­..." style="width:100%; min-height:80px; resize:vertical; box-sizing:border-box;"></textarea>
            <button onclick="enviarSuggeriment()" class="btn-contacte" style="align-self: center; justify-content:center;">âœ‰ï¸ Envia'm un missatge</button>
        </div>
    </div>
    <div class="footer-credits no-print">
        <p style="margin: 0; font-weight: bold; color: #333;">Â© <span id="any-actual"></span> PictoJocs - Creat per Rafa Robles Fontanet.</p>
        <p style="margin: 2px 0; font-size: 0.9em;">Tots els drets reservats. Prohibida la cÃ²pia o modificaciÃ³ d'aquest software sense permÃ­s.</p>
        <hr style="margin: 10px auto; width: 50%; opacity: 0.3;">
        <p style="margin: 5px 0; font-size: 0.8em; color: #666;">
            Els sÃ­mbols pictogrÃ fics utilitzats sÃ³n propietat del Govern d'AragÃ³ i han estat creats per Sergio Palao per a 
            <a href="http://www.arasaac.org" target="_blank" style="color: #4a90e2; text-decoration: none;">ARASAAC</a>, que els distribueix sota llicÃ¨ncia <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" style="color: #4a90e2;">CC (BY-NC-SA)</a>.
        </p>
    </div>

    <div id="modal-settings">
        <div class="modal-contingut" style="max-width: 500px;">
            <div style="background:#f1f1f1; padding: 15px; font-weight: bold; border-bottom: 2px solid #ddd; text-align:center;">ğŸ¤– Mode IA AvanÃ§at</div>
            <div class="modal-body" style="text-align: left;">
                <p style="font-size: 0.9em; color: #555;">Vols fer llistes de pictogrames segons el tema que demanis? O vols que la traducciÃ³ amb pictogrames sigui perfecta? Doncs enganxa aquÃ­ la teva clau API gratuÃ¯ta de Gemini (Google). Es guardarÃ  nomÃ©s al teu ordinador de forma segura.</p>
                <input type="password" id="gemini-api-key" placeholder="AIzaSy..." style="width:100%; padding:10px; margin-bottom:10px; border:2px solid #ccc; border-radius:5px;">
                <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:15px; text-align:center;">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size: 0.9em; color: var(--color-principal); text-decoration: none; font-weight: bold;">ğŸ‘‰ Com aconseguir una clau d'API gratis?</a>
                    <a href="https://github.com/rrobles4/pictojocs/blob/main/guia%20api.jpg" target="_blank" style="font-size: 0.9em; color: var(--color-principal); text-decoration: none; font-weight: bold;">ğŸ‘‰ Miniguia per aconseguir la clau API</a>
                </div>
            </div>
            <div style="padding:15px; background:#f9f9f9; display:flex; justify-content:center; gap:10px;">
                <button onclick="guardarSettings()" style="background:var(--color-accio); border:none; padding:10px 20px; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">Guardar</button>
                <button onclick="document.getElementById('modal-settings').style.display='none'" style="background:#999; border:none; padding:10px 20px; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">Tancar</button>
            </div>
        </div>
    </div>

    <div id="modal-prompt-ia">
        <div class="modal-contingut" style="max-width: 500px;">
            <div style="background:#f1f1f1; padding: 15px; font-weight: bold; border-bottom: 2px solid #ddd; text-align:center;">ğŸ¤– Generador de Llistes IA</div>
            <div class="modal-body" style="text-align: left;">
                <p style="font-size: 0.9em; color: #555;">Escriu quina llista de paraules vols generar. Com mÃ©s detallat, millor serÃ  la llista!</p>
                <textarea id="ia-prompt-text" placeholder="Ex: Fes una llista de 20 paraules sobre animals vertebrats, en el que surtin 5 mamÃ­fers, 4 aus, 3 rÃ¨ptils, 6 peixos i 2 amfibis" style="width:100%; min-height:100px; padding:10px; border:2px solid #ccc; border-radius:5px; font-size:1.1em;"></textarea>
            </div>
            <div style="padding:15px; background:#f9f9f9; display:flex; justify-content:center; gap:10px;">
                <button id="btn-exec-ia" onclick="generarLlistaIA()" style="background:var(--color-accio); border:none; padding:10px 20px; border-radius:8px; color:white; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px;">âœ… Generar</button>
                <button onclick="document.getElementById('modal-prompt-ia').style.display='none'" style="background:#999; border:none; padding:10px 20px; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">CancelÂ·lar</button>
            </div>
        </div>
    </div>

    <div id="modal-edicio">
        <div class="modal-contingut">
            <div class="modal-tabs">
                <button class="tab-btn actiu" onclick="canviarPestanya('tab-arasaac')">ğŸ§© Pictogrames</button>
                <button id="tab-btn-traductor" class="tab-btn" onclick="canviarPestanya('tab-traductor')">ğŸŒ Traductor</button>
                <button id="tab-btn-pujar" class="tab-btn" onclick="canviarPestanya('tab-pujar')">ğŸ“¤ Pujar</button>
                <button id="tab-btn-ia" class="tab-btn" onclick="canviarPestanya('tab-ia-img')">ğŸ¤– IA</button>
                <button class="tab-btn" onclick="obrirTabEdicio()">ğŸ¨ Editar</button>
            </div>
            <div class="modal-body">
                <div class="grup-titol-modal">
                    <label style="margin-bottom:10px;">Editar Text:</label>
                    <div id="camps-text" class="inputs-container-modal"></div>
                </div>
                
                <div id="tab-arasaac" class="contingut-tab">
                    <div class="cerca-wrapper"><input id="input-arasaac" onkeyup="if(event.key==='Enter') buscarArasaacModal()"><button class="btn-cerca-modal" onclick="buscarArasaacModal()">ğŸ” Cerca</button></div>
                    <div id="resultats-arasaac" class="resultats-grid"></div>
                </div>
                
                <div id="tab-traductor" class="contingut-tab" style="display:none;">
                    <p style="font-size:0.9em; margin-top:0;">Tria els idiomes a traduir per al Text 1:</p>
                    <div class="caixa-idiomes-check">
                        <label><input type="checkbox" value="es" class="check-trad" checked> CastellÃ </label>
                        <label><input type="checkbox" value="en" class="check-trad" checked> AnglÃ¨s</label>
                        <label><input type="checkbox" value="fr" class="check-trad"> FrancÃ¨s</label>
                        <label><input type="checkbox" value="de" class="check-trad"> Alemany</label>
                        <label><input type="checkbox" value="it" class="check-trad"> ItaliÃ </label>
                        <label><input type="checkbox" value="pt" class="check-trad"> PortuguÃ¨s</label>
                        <label><input type="checkbox" value="nl" class="check-trad"> NeerlandÃ¨s</label>
                        <label><input type="checkbox" value="ro" class="check-trad"> RomanÃ¨s</label>
                        <label><input type="checkbox" value="pl" class="check-trad"> PolonÃ¨s</label>
                        <label><input type="checkbox" value="uk" class="check-trad"> UcraÃ¯nÃ¨s</label>
                        <label><input type="checkbox" value="ru" class="check-trad"> Rus</label>
                        <label><input type="checkbox" value="ar" class="check-trad"> Ã€rab</label>
                        <label><input type="checkbox" value="zh" class="check-trad"> XinÃ¨s</label>
                        <label><input type="checkbox" value="ur" class="check-trad"> Urdu</label>
                    </div>
                    <div class="cerca-wrapper"><button class="btn-cerca-modal btn-cerca-trad" onclick="traduirParaula()" style="width:100%">ğŸŒ Traduir text 1</button></div>
                    <div id="resultats-traductor" class="grid-traduccions"></div>
                </div>
                
                <div id="tab-pujar" class="contingut-tab" style="display:none;text-align:center;">
                    <p>Puja una imatge prÃ²pia des del teu ordinador:</p>
                    <input type="file" accept="image/*" onchange="pujarImatge(this)" style="margin-top:10px;">
                </div>

                <div id="tab-ia-img" class="contingut-tab" style="display:none;text-align:center;">
                    <p style="font-size:1.1em; margin-bottom:15px; color:#555;">Genera imatges amb IntelÂ·ligÃ¨ncia Artificial fent servir l'eina externa gratuÃ¯ta de Craiyon.</p>
                    <button onclick="window.open('https://www.craiyon.com/','_blank','width=400,height=600')" style="background:var(--color-accio);color:white;padding:15px 25px;border-radius:30px;font-size:1.1em;border:none;cursor:pointer;font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display:block; margin:0 auto;">ğŸ¨ Obrir generador Craiyon</button>
                    <p style="font-size:0.85em; margin-top:20px; color:#999;">Guarda la imatge al teu ordinador i puja-la a la pestanya "Pujar".</p>
                </div>
                
                <div id="tab-dibuix" class="contingut-tab" style="display:none; text-align:center;">
                    <div style="display:flex; gap: 10px; margin-bottom: 15px; align-items:stretch;">
                        <div style="flex:1; background:#fffcf5; padding:10px; border-radius:10px; border:1px dashed #ccc; display:flex; flex-direction:column; justify-content:center;">
                            <label style="margin-top:0; margin-bottom:5px; font-size:0.85em; font-weight:bold;">ğŸ¨ Fons targeta:</label>
                            <div class="color-palette" style="margin-bottom:0; justify-content:space-around;">
                                <button class="color-btn" style="background:#ffffff; border-color:#333;" onclick="setTargetColor('#ffffff', this)"></button>
                                <button class="color-btn" style="background:#ffe082" onclick="setTargetColor('#ffe082', this)"></button>
                                <button class="color-btn" style="background:#a5d6a7" onclick="setTargetColor('#a5d6a7', this)"></button>
                                <button class="color-btn" style="background:#90caf9" onclick="setTargetColor('#90caf9', this)"></button>
                                <button class="color-btn" style="background:#ffcc80" onclick="setTargetColor('#ffcc80', this)"></button>
                                <button class="color-btn" style="background:#e1bee7" onclick="setTargetColor('#e1bee7', this)"></button>
                            </div>
                        </div>
                        <div style="flex:1; background:#f0f8ff; padding:10px; border-radius:10px; border:1px dashed #ccc; display:flex; flex-direction:column; justify-content:center;">
                            <label style="margin-top:0; margin-bottom:5px; font-size:0.85em; font-weight:bold;">ğŸ–Œï¸ Color d'ediciÃ³:</label>
                            <div class="color-palette" style="margin-bottom:0; justify-content:space-around;">
                                <button class="btn-color-dibuix" style="background:#e74c3c" onclick="setDrawColor('#e74c3c')"></button>
                                <button class="btn-color-dibuix" style="background:#2980b9" onclick="setDrawColor('#2980b9')"></button>
                                <button class="btn-color-dibuix" style="background:#27ae60" onclick="setDrawColor('#27ae60')"></button>
                                <button class="btn-color-dibuix" style="background:#f1c40f" onclick="setDrawColor('#f1c40f')"></button>
                                <button class="btn-color-dibuix" style="background:#000000" onclick="setDrawColor('#000000')"></button>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <div class="toolbar-dibuix">
                            <button id="tool-freehand" class="btn-tool actiu" onclick="setTool('freehand')" title="Dibuix Lliure">ã€°ï¸</button>
                            <button id="tool-rect" class="btn-tool" onclick="setTool('rect')" title="Quadrat">ğŸ”²</button>
                            <button id="tool-circle" class="btn-tool" onclick="setTool('circle')" title="Cercle">â­•</button>
                            <button id="tool-arrow" class="btn-tool" onclick="setTool('arrow')" title="Fletxa">â†—ï¸</button>
                            <button id="tool-cross" class="btn-tool" onclick="setTool('cross')" title="Creu">âŒ</button>
                            <div style="width:2px; height:20px; background:#ccc; margin:0 5px;"></div> 
                            <button style="background:#95a5a6; border:none; padding:5px 15px; border-radius:5px; color:white; cursor:pointer; font-size:1.2em; font-weight:bold;" onclick="undoLastDrawing()" title="Desfer Ãºltim pas">â†©ï¸</button>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; background:#eee; padding:10px; border-radius:10px; width:100%; box-sizing:border-box;">
                            <label style="font-size:0.8em; font-weight:bold;">ğŸ” Mida: <input type="range" id="ed-scale" min="0.5" max="3" step="0.1" value="1" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em; font-weight:bold;">â†”ï¸ X: <input type="range" id="ed-x" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em; font-weight:bold;">â†•ï¸ Y: <input type="range" id="ed-y" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                        </div>
                        <canvas id="canvasEditor" width="300" height="300" style="border:2px dashed #ccc; border-radius:10px; touch-action:none; background:white; cursor:crosshair;"></canvas>
                    </div>
                </div>

            </div>
            <div style="padding:15px;background:#f9f9f9; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <button onclick="eliminarTargeta()" style="background:#e74c3c; color:white; display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ—‘ï¸ Eliminar targeta</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="guardarTancar()" style="background:var(--color-accio);display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; color:white;">âœ… Fet</button>
                    <button onclick="tancarModalSenseGuardar()" style="background:#999;display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; color:white;">CancelÂ·lar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background: #333; color:white; padding: 10px 20px; border-radius: 30px; z-index:2000;">Copiat!</div>

    <script>
        const uiDict = {'ca':["Necessites ajuda i no saps com dir-ho? Tria el teu idioma i ho podrÃ s explicar amb pictogrames!","El teu idioma:","Tradueix a:","Escriu la frase aquÃ­ o utilitza el micrÃ²fon...","ğŸ¤ Parlar","â¡ï¸ Traduir","ğŸ‘‚ Escoltant..."],'es':["Â¿Necesitas ayuda y no sabes cÃ³mo decirlo? Â¡Elige tu idioma y explÃ­calo con pictogramas!","Tu idioma:","Traducir a:","Escribe la frase aquÃ­ o usa el micrÃ³fono...","ğŸ¤ Hablar","â¡ï¸ Traducir","ğŸ‘‚ Escuchando..."],'en':["Need help and don't know how to say it? Choose your language and explain it with pictograms!","Your language:","Translate to:","Type the phrase here or use the microphone...","ğŸ¤ Speak","â¡ï¸ Translate","ğŸ‘‚ Listening..."],'fr':["Besoin d'aide et vous ne savez pas comment le dire ? Choisissez votre langue et expliquez-le avec des pictogrammes !","Votre langue :","Traduire en :","Ã‰crivez la phrase ici ou utilisez le microphone...","ğŸ¤ Parler","â¡ï¸ Traduire","ğŸ‘‚ En Ã©coute..."],'de':["Brauchst du Hilfe und weiÃŸt nicht, wie du es sagen sollst? WÃ¤hle deine Sprache und erklÃ¤re es mit Piktogrammen!","Deine Sprache:","Ãœbersetzen in:","Schreibe den Satz hier oder benutze das Mikrofon...","ğŸ¤ Sprechen","â¡ï¸ Ãœbersetzen","ğŸ‘‚ HÃ¶re zu..."],'it':["Hai bisogno di aiuto e non sai come dirlo? Scegli la tua lingua e spiegalo con i pittogrammi!","La tua lingua:","Traduci in:","Scrivi la frase qui o usa il microfono...","ğŸ¤ Parla","â¡ï¸ Traduci","ğŸ‘‚ Ascoltando..."],'pt':["Precisa de ajuda e nÃ£o sabe como dizer? Escolha o seu idioma e explique com pictogramas!","Seu idioma:","Traduzir para:","Escreva a frase aqui ou use o microfone...","ğŸ¤ Falar","â¡ï¸ Traduzir","ğŸ‘‚ Ouvindo..."],'nl':["Hulp nodig en je weet niet hoe je het moet zeggen? Kies je taal en leg het uit met pictogrammen!","Jouw taal:","Vertaal naar:","Typ hier de zin of gebruik de microfoon...","ğŸ¤ Spreken","â¡ï¸ Vertalen","ğŸ‘‚ Luisteren..."],'ro':["Ai nevoie de ajutor È™i nu È™tii cum sÄƒ spui? Alege limba ta È™i explicÄƒ prin pictograme!","Limba ta:","Traduce Ã®n:","Scrie fraza aici sau foloseÈ™te microfonul...","ğŸ¤ VorbeÈ™te","â¡ï¸ Traduce","ğŸ‘‚ Ascult..."],'pl':["Potrzebujesz pomocy i nie wiesz, jak to powiedzieÄ‡? Wybierz swÃ³j jÄ™zyk i wyjaÅ›nij to za pomocÄ… piktogramÃ³w!","TwÃ³j jÄ™zyk:","PrzetÅ‚umacz na:","Wpisz tu zdanie lub uÅ¼yj mikrofonu...","ğŸ¤ MÃ³w","â¡ï¸ TÅ‚umacz","ğŸ‘‚ SÅ‚ucham..."],'uk':["ĞŸĞ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ° Ñ– Ğ½Ğµ Ğ·Ğ½Ğ°Ñ”Ñ‚Ğµ, ÑĞº Ñ†Ğµ ÑĞºĞ°Ğ·Ğ°Ñ‚Ğ¸? Ğ’Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ¼Ğ¾Ğ²Ñƒ Ñ– Ğ¿Ğ¾ÑÑĞ½Ñ–Ñ‚ÑŒ Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ Ğ¿Ñ–ĞºÑ‚Ğ¾Ğ³Ñ€Ğ°Ğ¼!","Ğ’Ğ°ÑˆĞ° Ğ¼Ğ¾Ğ²Ğ°:","ĞŸĞµÑ€ĞµĞºĞ»Ğ°ÑÑ‚Ğ¸ Ğ½Ğ°:","ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ Ñ„Ñ€Ğ°Ğ·Ñƒ Ñ‚ÑƒÑ‚ Ğ°Ğ±Ğ¾ ÑĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ğ¹Ñ‚ĞµÑÑ Ğ¼Ñ–ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ¾Ğ¼...","ğŸ¤ Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸","â¡ï¸ ĞŸĞµÑ€ĞµĞºĞ»Ğ°ÑÑ‚Ğ¸","ğŸ‘‚ Ğ¡Ğ»ÑƒÑ…Ğ°Ñ..."],'ru':["ĞÑƒĞ¶Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¸ Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚Ğµ, ĞºĞ°Ğº ÑÑ‚Ğ¾ ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ? Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ²Ğ¾Ğ¹ ÑĞ·Ñ‹Ğº Ğ¸ Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸Ñ‚Ğµ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ¿Ğ¸ĞºÑ‚Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼!","Ğ’Ğ°Ñˆ ÑĞ·Ñ‹Ğº:","ĞŸĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸ Ğ½Ğ°:","ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ñ„Ñ€Ğ°Ğ·Ñƒ Ğ·Ğ´ĞµÑÑŒ Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½...","ğŸ¤ Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ","â¡ï¸ ĞŸĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸","ğŸ‘‚ Ğ¡Ğ»ÑƒÑˆĞ°Ñ..."],'bg':["ĞÑƒĞ¶Ğ´Ğ°ĞµÑ‚Ğµ ÑĞµ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ Ğ¸ Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚Ğµ ĞºĞ°Ğº Ğ´Ğ° Ğ³Ğ¾ ĞºĞ°Ğ¶ĞµÑ‚Ğµ? Ğ˜Ğ·Ğ±ĞµÑ€ĞµÑ‚Ğµ ÑĞ²Ğ¾Ñ ĞµĞ·Ğ¸Ğº Ğ¸ Ğ³Ğ¾ Ğ¾Ğ±ÑÑĞ½ĞµÑ‚Ğµ Ñ Ğ¿Ğ¸ĞºÑ‚Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¸!","Ğ’Ğ°ÑˆĞ¸ÑÑ‚ ĞµĞ·Ğ¸Ğº:","ĞŸÑ€ĞµĞ²Ğ¾Ğ´ Ğ½Ğ°:","ĞĞ°Ğ¿Ğ¸ÑˆĞµÑ‚Ğµ Ñ„Ñ€Ğ°Ğ·Ğ°Ñ‚Ğ° Ñ‚ÑƒĞº Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ¿Ğ¾Ğ»Ğ·Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ°...","ğŸ¤ Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸","â¡ï¸ ĞŸÑ€ĞµĞ²ĞµĞ´Ğ¸","ğŸ‘‚ Ğ¡Ğ»ÑƒÑˆĞ°Ğ¼..."],'ar':["Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆÙ„Ø§ ØªØ¹Ø±Ù ÙƒÙŠÙ ØªÙ‚ÙˆÙ„Ù‡Ø§ØŸ Ø§Ø®ØªØ± Ù„ØºØªÙƒ ÙˆØ§Ø´Ø±Ø­Ù‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠØ©!","Ù„ØºØªÙƒ:","ØªØ±Ø¬Ù… Ø¥Ù„Ù‰:","Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†...","ğŸ¤ ØªØ­Ø¯Ø«","â¡ï¸ ØªØ±Ø¬Ù…Ø©","ğŸ‘‚ Ø£Ø³ØªÙ…Ø¹..."],'zh':["éœ€è¦å¸®åŠ©ä¸çŸ¥é“æ€ä¹ˆè¯´ï¼Ÿé€‰æ‹©ä½ çš„è¯­è¨€ï¼Œç”¨å›¾ç”»è§£é‡Šå§ï¼","ä½ çš„è¯­è¨€ï¼š","ç¿»è¯‘æˆï¼š","åœ¨è¿™é‡Œè¾“å…¥å¥å­æˆ–ä½¿ç”¨éº¦å…‹é£...","ğŸ¤ è¯´è¯","â¡ï¸ ç¿»è¯‘","ğŸ‘‚ å¬ç€..."],'fa':["Ú©Ù…Ú© Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒØ¯ Ùˆ Ù†Ù…ÛŒ Ø¯Ø§Ù†ÛŒØ¯ Ú†Ú¯ÙˆÙ†Ù‡ Ø¨Ú¯ÙˆÛŒÛŒØ¯ØŸ Ø²Ø¨Ø§Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ø§ Ù¾ÛŒÚ©ØªÙˆÚ¯Ø±Ø§Ù… ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯!","Ø²Ø¨Ø§Ù† Ø´Ù…Ø§:","ØªØ±Ø¬Ù…Ù‡ Ø¨Ù‡:","Ø¬Ù…Ù„Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯...","ğŸ¤ ØµØ­Ø¨Øª Ú©Ù†","â¡ï¸ ØªØ±Ø¬Ù…Ù‡","ğŸ‘‚ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†..."],'he':["×¦×¨×™×š ×¢×–×¨×” ×•×œ× ×™×•×“×¢ ××™×š ×œ×”×’×™×“ ××ª ×–×”? ×‘×—×¨ ××ª ×”×©×¤×” ×©×œ×š ×•×”×¡×‘×¨ ×‘×××¦×¢×•×ª ×¡××œ×™×!","×”×©×¤×” ×©×œ×š:","×ª×¨×’× ×œ:","×”×§×œ×“ ××ª ×”××©×¤×˜ ×›××Ÿ ××• ×”×©×ª××© ×‘××™×§×¨×•×¤×•×Ÿ...","ğŸ¤ ×“×‘×¨","â¡ï¸ ×ª×¨×’×","ğŸ‘‚ ××§×©×™×‘..."],'el':["Î§ÏÎµÎ¹Î¬Î¶ÎµÏƒÏ„Îµ Î²Î¿Î®Î¸ÎµÎ¹Î± ÎºÎ±Î¹ Î´ÎµÎ½ Î¾Î­ÏÎµÏ„Îµ Ï€ÏÏ‚ Î½Î± Ï„Î¿ Ï€ÎµÎ¯Ï„Îµ; Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î· Î³Î»ÏÏƒÏƒÎ± ÏƒÎ±Ï‚ ÎºÎ±Î¹ ÎµÎ¾Î·Î³Î®ÏƒÏ„Îµ Ï„Î¿ Î¼Îµ ÎµÎ¹ÎºÎ¿Î½Î¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î±!","Î— Î³Î»ÏÏƒÏƒÎ± ÏƒÎ±Ï‚:","ÎœÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ· ÏƒÎµ:","Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î· Ï†ÏÎ¬ÏƒÎ· ÎµÎ´Ï Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿ Î¼Î¹ÎºÏÏŒÏ†Ï‰Î½Î¿...","ğŸ¤ ÎœÎ¹Î»Î®ÏƒÏ„Îµ","â¡ï¸ ÎœÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·","ğŸ‘‚ Î‘ÎºÎ¿ÏÏ‰..."],'eu':["Laguntza behar duzu eta ez dakizu nola esan? Aukeratu zure hizkuntza eta azaldu piktogramekin!","Zure hizkuntza:","Itzuli honetara:","Idatzi esaldia hemen edo erabili mikrofonoa...","ğŸ¤ Hitz egin","â¡ï¸ Itzuli","ğŸ‘‚ Entzuten..."],'gl':["Necesitas axuda e non sabes como dicilo? Elixe o teu idioma e explÃ­cao con pictogramas!","O teu idioma:","Traducir a:","Escribe a frase aquÃ­ ou usa o micrÃ³fono...","ğŸ¤ Falar","â¡ï¸ Traducir","ğŸ‘‚ Escoitando..."],'val':["Necessites ajuda i no saps com dir-ho? Tria el teu idioma i ho podrÃ s explicar amb pictogrames!","El teu idioma:","Tradueix a:","Escriu la frase aquÃ­ o utilitza el micrÃ²fon...","ğŸ¤ Parlar","â¡ï¸ Traduir","ğŸ‘‚ Escoltant..."],'cs':["PotÅ™ebujete pomoci a nevÃ­te, jak to Å™Ã­ct? Vyberte si svÅ¯j jazyk a vysvÄ›tlete to pomocÃ­ piktogramÅ¯!","VÃ¡Å¡ jazyk:","PÅ™eloÅ¾it do:","NapiÅ¡te sem vÄ›tu nebo pouÅ¾ite mikrofon...","ğŸ¤ Mluvit","â¡ï¸ PÅ™eloÅ¾it","ğŸ‘‚ PoslouchÃ¡m..."],'sk':["Potrebujete pomÃ´cÅ¥ a neviete, ako to povedaÅ¥? Vyberte si svoj jazyk a vysvetlite to pomocou piktogramov!","VÃ¡Å¡ jazyk:","PreloÅ¾iÅ¥ do:","NapÃ­Å¡te sem vetu alebo pouÅ¾ite mikrofÃ³n...","ğŸ¤ HovoriÅ¥","â¡ï¸ PreloÅ¾iÅ¥","ğŸ‘‚ PoÄÃºvam..."],'sl':["Potrebujete pomoÄ in ne veste, kako bi to povedali? Izberite svoj jezik in razloÅ¾ite s piktogrami!","VaÅ¡ jezik:","Prevedi v:","Tukaj vnesite frazo ali uporabite mikrofon...","ğŸ¤ Govori","â¡ï¸ Prevedi","ğŸ‘‚ PosluÅ¡am..."],'hr':["Potrebna vam je pomoÄ‡ i ne znate kako to reÄ‡i? Odaberite svoj jezik i objasnite to pomoÄ‡u piktograma!","VaÅ¡ jezik:","Prevedi na:","Ovdje napiÅ¡ite izraz ili upotrijebite mikrofon...","ğŸ¤ Govori","â¡ï¸ Prevedi","ğŸ‘‚ SluÅ¡am..."],'sr':["Treba vam pomoÄ‡ i ne znate kako da to kaÅ¾ete? Izaberite svoj jezik i objasnite pomoÄ‡u piktograma!","Tvoj jezik:","Prevedi na:","NapiÅ¡ite frazu ovde ili koristite mikrofon...","ğŸ¤ Govori","â¡ï¸ Prevedi","ğŸ‘‚ SluÅ¡am..."],'mk':["Ğ˜Ğ¼Ğ°Ñ‚Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ° Ğ¾Ğ´ Ğ¿Ğ¾Ğ¼Ğ¾Ñˆ Ğ¸ Ğ½Ğµ Ğ·Ğ½Ğ°ĞµÑ‚Ğµ ĞºĞ°ĞºĞ¾ Ğ´Ğ° Ğ³Ğ¾ ĞºĞ°Ğ¶ĞµÑ‚Ğµ Ñ‚Ğ¾Ğ°? Ğ˜Ğ·Ğ±ĞµÑ€ĞµÑ‚Ğµ Ğ³Ğ¾ Ğ²Ğ°ÑˆĞ¸Ğ¾Ñ‚ Ñ˜Ğ°Ğ·Ğ¸Ğº Ğ¸ Ğ¾Ğ±Ñ˜Ğ°ÑĞ½ĞµÑ‚Ğµ ÑĞ¾ Ğ¿Ğ¸ĞºÑ‚Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¸!","Ğ’Ğ°ÑˆĞ¸Ğ¾Ñ‚ Ñ˜Ğ°Ğ·Ğ¸Ğº:","ĞŸÑ€ĞµĞ²ĞµĞ´Ğ¸ Ğ½Ğ°:","ĞĞ°Ğ¿Ğ¸ÑˆĞµÑ‚Ğµ Ñ˜Ğ° Ñ„Ñ€Ğ°Ğ·Ğ°Ñ‚Ğ° Ñ‚ÑƒĞºĞ° Ğ¸Ğ»Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ĞµÑ‚Ğµ Ğ³Ğ¾ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ğ¾Ñ‚...","ğŸ¤ Ğ—Ğ±Ğ¾Ñ€ÑƒĞ²Ğ°Ñ˜","â¡ï¸ ĞŸÑ€ĞµĞ²ĞµĞ´Ğ¸","ğŸ‘‚ Ğ¡Ğ»ÑƒÑˆĞ°Ğ¼..."],'sq':["Keni nevojÃ« pÃ«r ndihmÃ« dhe nuk dini si ta thoni? Zgjidhni gjuhÃ«n tuaj dhe shpjegojeni me piktograme!","Gjuha juaj:","PÃ«rkthe nÃ«:","Shkruani frazÃ«n kÃ«tu ose pÃ«rdorni mikrofonin...","ğŸ¤ Flisni","â¡ï¸ PÃ«rkthe","ğŸ‘‚ Duke dÃ«gjuar..."],'hu':["SegÃ­tsÃ©gre van szÃ¼ksÃ©ge, Ã©s nem tudja, hogyan mondja el? VÃ¡lassza ki a nyelvÃ©t, Ã©s magyarÃ¡zza el piktogramokkal!","Az Ã–n nyelve:","FordÃ­tÃ¡s erre:","Ãrja be ide a kifejezÃ©st, vagy hasznÃ¡lja a mikrofont...","ğŸ¤ BeszÃ©lj","â¡ï¸ FordÃ­tÃ¡s","ğŸ‘‚ Figyelek..."],'da':["Brug for hjÃ¦lp og ved ikke, hvordan man siger det? VÃ¦lg dit sprog og forklar det med piktogrammer!","Dit sprog:","OversÃ¦t til:","Skriv sÃ¦tningen her eller brug mikrofonen...","ğŸ¤ Tal","â¡ï¸ OversÃ¦t","ğŸ‘‚ Lytter..."],'sv':["BehÃ¶ver du hjÃ¤lp och vet inte hur du ska sÃ¤ga det? VÃ¤lj ditt sprÃ¥k och fÃ¶rklara det med piktogram!","Ditt sprÃ¥k:","Ã–versÃ¤tt till:","Skriv frasen hÃ¤r eller anvÃ¤nd mikrofonen...","ğŸ¤ Tala","â¡ï¸ Ã–versÃ¤tt","ğŸ‘‚ Lyssnar..."],'fi':["Tarvitsetko apua etkÃ¤ tiedÃ¤ miten sanoa se? Valitse kielesi ja selitÃ¤ se kuvamerkeillÃ¤!","Sinun kielesi:","KÃ¤Ã¤nnÃ¤ kielelle:","Kirjoita lause tÃ¤hÃ¤n tai kÃ¤ytÃ¤ mikrofonia...","ğŸ¤ Puhu","â¡ï¸ KÃ¤Ã¤nnÃ¤","ğŸ‘‚ Kuuntelen..."],'et':["Vajad abi ja ei tea, kuidas seda Ã¶elda? Vali oma keel ja selgita piktogrammidega!","Sinu keel:","TÃµlgi keelde:","Kirjuta fraas siia vÃµi kasuta mikrofoni...","ğŸ¤ RÃ¤Ã¤gi","â¡ï¸ TÃµlgi","ğŸ‘‚ Kuulan..."],'lt':["Reikia pagalbos ir neÅ¾inote, kaip tai pasakyti? Pasirinkite savo kalbÄ… ir paaiÅ¡kinkite piktogramomis!","JÅ«sÅ³ kalba:","IÅ¡versti Ä¯:","Ä®raÅ¡ykite frazÄ™ Äia arba naudokite mikrofonÄ…...","ğŸ¤ KalbÄ—ti","â¡ï¸ IÅ¡versti","ğŸ‘‚ Klausau..."],'lv':["NepiecieÅ¡ama palÄ«dzÄ«ba un nezinÄt, kÄ to pateikt? IzvÄ“lieties savu valodu un izskaidrojiet to ar piktogrammÄm!","JÅ«su valoda:","Tulkot uz:","Ierakstiet frÄzi Å¡eit vai izmantojiet mikrofonu...","ğŸ¤ RunÄt","â¡ï¸ Tulkot","ğŸ‘‚ Klausos..."],'ko':["ë„ì›€ì´ í•„ìš”í•˜ì§€ë§Œ ì–´ë–»ê²Œ ë§í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ë‚˜ìš”? ì–¸ì–´ë¥¼ ì„ íƒí•˜ê³  í”½í† ê·¸ë¨ìœ¼ë¡œ ì„¤ëª…í•´ ë³´ì„¸ìš”!","ì‚¬ìš© ì–¸ì–´:","ë²ˆì—­í•  ì–¸ì–´:","ì—¬ê¸°ì— ë¬¸ì¥ì„ ì…ë ¥í•˜ê±°ë‚˜ ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”...","ğŸ¤ ë§í•˜ê¸°","â¡ï¸ ë²ˆì—­","ğŸ‘‚ ë“£ëŠ” ì¤‘..."],'ur':["Ù…Ø¯Ø¯ Ú©ÛŒ Ø¶Ø±ÙˆØ±Øª ÛÛ’ Ø§ÙˆØ± Ù†ÛÛŒÚº Ø¬Ø§Ù†ØªÛ’ Ú©Û Ú©ÛŒØ³Û’ Ú©ÛÙ†Ø§ ÛÛ’ØŸ Ø§Ù¾Ù†ÛŒ Ø²Ø¨Ø§Ù† Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº Ø§ÙˆØ± ØªØµÙˆÛŒØ±ÛŒ Ø¹Ù„Ø§Ù…ØªÙˆÚº Ø³Û’ Ø³Ù…Ø¬Ú¾Ø§Ø¦ÛŒÚº!","Ø¢Ù¾ Ú©ÛŒ Ø²Ø¨Ø§Ù†:","Ø§Ø³ Ù…ÛŒÚº ØªØ±Ø¬Ù…Û Ú©Ø±ÛŒÚº:","ÛŒÛØ§Úº Ø¬Ù…Ù„Û Ù„Ú©Ú¾ÛŒÚº ÛŒØ§ Ù…Ø§Ø¦ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ÛŒÚº...","ğŸ¤ Ø¨ÙˆÙ„ÛŒÚº","â¡ï¸ ØªØ±Ø¬Ù…Û Ú©Ø±ÛŒÚº","ğŸ‘‚ Ø³Ù† Ø±ÛØ§ ÛÙˆÚº..."]};

        function initLangs(){
            const l=[{v:'ca',t:'CatalÃ '},{v:'es',t:'CastellÃ  (EspaÃ±ol)'},{v:'en',t:'AnglÃ¨s (English)'},{v:'fr',t:'FrancÃ¨s (FranÃ§ais)'},{v:'de',t:'Alemany (Deutsch)'},{v:'it',t:'ItaliÃ  (Italiano)'},{v:'pt',t:'PortuguÃ¨s (PortuguÃªs)'},{v:'nl',t:'NeerlandÃ¨s (Nederlands)'},{v:'ro',t:'RomanÃ¨s (RomÃ¢nÄƒ)'},{v:'pl',t:'PolonÃ¨s (Polski)'},{v:'uk',t:'UcraÃ¯nÃ¨s (Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°)'},{v:'ru',t:'Rus (Ğ ÑƒÑÑĞºĞ¸Ğ¹)'},{v:'bg',t:'BÃºlgar (Ğ‘ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸)'},{v:'ar',t:'Ã€rab (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)'},{v:'zh',t:'XinÃ¨s (ä¸­æ–‡)'},{v:'fa',t:'Persa (ÙØ§Ø±Ø³ÛŒ)'},{v:'he',t:'Hebreu (×¢×‘×¨×™×ª)'},{v:'el',t:'Grec (Î•Î»Î»Î·Î½Î¹ÎºÎ¬)'},{v:'eu',t:'Basc (Euskara)'},{v:'gl',t:'Gallec (Galego)'},{v:'val',t:'ValenciÃ  (ValenciÃ )'},{v:'cs',t:'Txec (ÄŒeÅ¡tina)'},{v:'sk',t:'Eslovac (SlovenÄina)'},{v:'sl',t:'EslovÃ¨ (SlovenÅ¡Äina)'},{v:'hr',t:'Croat (Hrvatski)'},{v:'sr',t:'Serbi (Ğ¡Ñ€Ğ¿ÑĞºĞ¸)'},{v:'mk',t:'Macedoni (ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½ÑĞºĞ¸)'},{v:'sq',t:'AlbanÃ¨s (Shqip)'},{v:'hu',t:'HongarÃ¨s (Magyar)'},{v:'da',t:'DanÃ¨s (Dansk)'},{v:'sv',t:'Suec (Svenska)'},{v:'fi',t:'FinlandÃ¨s (Suomi)'},{v:'et',t:'EstoniÃ  (Eesti)'},{v:'lt',t:'LituÃ  (LietuviÅ³)'},{v:'lv',t:'LetÃ³ (LatvieÅ¡u)'},{v:'ko',t:'CoreÃ  (í•œêµ­ì–´)'},{v:'ur',t:'Urdu (Ø§Ø±Ø¯Ùˆ)'},{v:'pa',t:'Panjabi (à¨ªà©°à¨œà¨¾à¨¬à©€)'}];
            const opts=l.map(x=>`<option value="${x.v}">${x.t}</option>`).join('');
            const idiomaInput = document.getElementById('idioma-input');
            const idiomaDesti = document.getElementById('idioma-desti');
            if (idiomaInput) idiomaInput.innerHTML = opts;
            if (idiomaDesti) idiomaDesti.innerHTML = opts;
        }
        initLangs();

        let isListening = false;
        let textSpeak = "ğŸ¤ Parlar";
        let textListen = "ğŸ‘‚ Escoltant...";

        function intercanviarIdiomes() {
            const selInput = document.getElementById('idioma-input');
            const selDesti = document.getElementById('idioma-desti');
            if (!selInput.value || !selDesti.value) return;
            const temp = selInput.value;
            selInput.value = selDesti.value;
            selDesti.value = temp;
            canviarIdiomaUI();
        }

        function canviarIdiomaUI() {
            const lang = document.getElementById('idioma-input').value;
            const texts = uiDict[lang] || uiDict['ca'];
            document.getElementById('label-idioma-traductor').innerText = texts[1];
            document.getElementById('label-idioma-desti').innerText = texts[2];
            document.getElementById('text-input').placeholder = texts[3];
            textSpeak = texts[4];
            textListen = texts[6];
            if(!isListening) document.getElementById('btn-mic-trad').innerHTML = textSpeak;
            else document.getElementById('btn-mic-trad').innerHTML = textListen;
            if(!document.getElementById('btn-trad').disabled) document.getElementById('btn-trad').innerHTML = texts[5];
        }

        let currentView = 'pictotraductor'; 
        let idiomaSeleccionat = 'ca';
        let elementEditant = null;
        let dadesDomino = []; 
        let globalSchoolLogoSrc = ''; 
        let memoriaEdicions = {}; 
        let currentColorSelected = '#ffffff';
        let imgOriginalSrcOnOpen = ''; 
        let editorCanvas, editorCtx;
        let editorImgObj = new Image();
        editorImgObj.crossOrigin = "Anonymous";
        let currentDrawings = [];
        let isDrawing = false;
        let drawColor = '#e74c3c';
        let currentTool = 'freehand'; 
        let startX, startY, currentX, currentY;
        let isDraggingShape = false;
        let draggedShapeIndex = -1;
        let lastMouseX = 0, lastMouseY = 0;

        window.onload = function() {
            document.getElementById('any-actual').innerText = new Date().getFullYear();
            if (typeof RUTA_LOGO_PICTOJOCS !== 'undefined' && RUTA_LOGO_PICTOJOCS.trim() !== '') {
                document.querySelectorAll('.logo-pictojocs').forEach(el => el.src = RUTA_LOGO_PICTOJOCS);
                document.querySelectorAll('.big-logo-print').forEach(el => el.src = RUTA_LOGO_PICTOJOCS);
            }
            editorCanvas = document.getElementById('canvasEditor');
            if(editorCanvas) {
                editorCtx = editorCanvas.getContext('2d');
                editorCanvas.addEventListener('mousedown', startDrawingCanvas);
                editorCanvas.addEventListener('mousemove', drawCanvas);
                window.addEventListener('mouseup', stopDrawingCanvas);
                editorCanvas.addEventListener('touchstart', e => { e.preventDefault(); startDrawingCanvas(e); }, {passive: false});
                editorCanvas.addEventListener('touchmove', e => { e.preventDefault(); drawCanvas(e); }, {passive: false});
                window.addEventListener('touchend', stopDrawingCanvas);
            }
        };

        function switchAppView(view) {
            currentView = view;
            const viewPictotraductor = document.getElementById('view-pictotraductor');
            if (viewPictotraductor) viewPictotraductor.style.display = (view === 'pictotraductor') ? 'block' : 'none';
            if (view === 'pictotraductor') canviarIdiomaUI();
        }

        function enviarSuggeriment() {
            const email = document.getElementById('sugg-email').value;
            const subject = document.getElementById('sugg-assumpte').value;
            const msg = document.getElementById('sugg-missatge').value;
            window.location.href = `mailto:rrobles4@xtec.cat?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent("Correu: "+email+"\n\n"+msg)}`;
        }

        function desarProjecte() {
            const data = {
                titol: document.getElementById('titol-doc').value,
                curs: document.getElementById('curs').value,
                idioma: document.getElementById('idioma').value,
                paraules: document.getElementById('llista-paraules').value,
                mode: document.getElementById('selector-mode').value,
                midaPaper: document.getElementById('mida-paper').value,
                sentit: document.getElementById('sentit-paper').value,
                columnes: document.getElementById('selector-columnes').value,
                font: document.getElementById('selector-font').value,
                memoria: memoriaEdicions
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pictojocs_projecte.json'; 
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            
            const btn = document.getElementById('btn-desar');
            const txtOriginal = btn.innerHTML;
            btn.innerHTML = "âœ… Fet!";
            btn.style.backgroundColor = "var(--color-accio)";
            btn.style.color = "white";
            setTimeout(() => { btn.innerHTML = txtOriginal; btn.style.backgroundColor = ""; btn.style.color = ""; }, 2000);
        }

        function carregarProjecte(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e2) {
                try {
                    const data = JSON.parse(e2.target.result);
                    if (data.titol !== undefined) document.getElementById('titol-doc').value = data.titol;
                    if (data.curs !== undefined) document.getElementById('curs').value = data.curs;
                    if (data.idioma !== undefined) document.getElementById('idioma').value = data.idioma;
                    if (data.paraules !== undefined) document.getElementById('llista-paraules').value = data.paraules;
                    if (data.mode !== undefined) document.getElementById('selector-mode').value = data.mode;
                    if (data.midaPaper !== undefined) document.getElementById('mida-paper').value = data.midaPaper;
                    if (data.sentit !== undefined) document.getElementById('sentit-paper').value = data.sentit;
                    actualitzarOpcionsColumnes(); 
                    if (data.columnes !== undefined) document.getElementById('selector-columnes').value = data.columnes;
                    if (data.font !== undefined) document.getElementById('selector-font').value = data.font;
                    memoriaEdicions = data.memoria || {};
                    canviarMode(); actualitzarEstils(); 
                } catch(err) { alert("Error carregant el projecte"); }
            }; reader.readAsText(file);
        }

        function carregarLogoEscola(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    globalSchoolLogoSrc = e.target.result;
                    ['logo-visual', 'logo-visual-back'].forEach(id => { const img = document.getElementById(id); if(img) { img.src = globalSchoolLogoSrc; img.style.display = 'block'; } });
                    document.getElementById('wrapper-logo').classList.add('feteservir'); document.getElementById('wrapper-logo').innerHTML = "âœ… Logo Escola Carregat";
                }; reader.readAsDataURL(input.files[0]);
            }
        }
        
        function imprimirSegur(btn) {
            const txt = btn.innerHTML;
            btn.innerHTML = "â³ Preparant...";
            setTimeout(() => { btn.innerHTML = txt; window.print(); }, 1500);
        }

        function canviarMode() {
            const mode = document.getElementById('selector-mode').value;
            document.getElementById('avis-doble-cara').style.display = (mode === 'targeta' || mode === 'memory') ? 'list-item' : 'none';
            document.getElementById('btn-mix').style.display = (mode === 'domino') ? 'flex' : 'none'; 
            generarDocument();
        }

        async function generarDocument() {
            const titol = document.getElementById('titol-doc').value || "Sense tÃ­tol";
            const curs = document.getElementById('curs').value;
            const textParaules = document.getElementById('llista-paraules').value;
            const mode = document.getElementById('selector-mode').value;
            idiomaSeleccionat = document.getElementById('idioma').value;

            document.getElementById('titol-resultat').innerText = titol;
            document.getElementById('titol-resultat-back').innerText = titol;
            
            const cursEl = document.getElementById('curs-resultat');
            const cursElBack = document.getElementById('curs-resultat-back');
            if (curs.trim()) { cursEl.innerText = curs; cursEl.style.display='inline-block'; cursElBack.innerText = curs; cursElBack.style.display='inline-block'; } 
            else { cursEl.style.display='none'; cursElBack.style.display='none'; }

            const contenidor = document.getElementById('contenidor-picts');
            const contenidorRevers = document.getElementById('contenidor-revers');
            const wrapperRevers = document.getElementById('contenidor-revers-wrapper');

            contenidor.innerHTML = ''; contenidorRevers.innerHTML = '';
            contenidor.classList.remove('mode-targeta-front', 'mode-domino', 'mode-memory-front');
            contenidorRevers.classList.remove('mode-targeta-back'); wrapperRevers.style.display = 'none';

            if (!textParaules.trim()) return; 
            const llista = textParaules.split(',').map(p=>p.trim()).filter(p=>p!=='');
            
            if (dadesDomino.length === 0 || dadesDomino.length !== llista.length) {
                dadesDomino = llista.map(p => { let mem = memoriaEdicions[p]; return mem ? { txt: mem.htmlFinal, imgUrl: mem.imgUrl, isHtml: true } : { txt: p, imgUrl: null, isHtml: false }; }); 
            }

            if (mode === 'targeta') { 
                wrapperRevers.style.display = 'block'; contenidor.classList.add('mode-targeta-front'); contenidorRevers.classList.add('mode-targeta-back');
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula];
                    const divFront = crearElementTargeta(paraula, i, 'front'); const divBack = crearElementTargeta(paraula, i, 'back');
                    if (mem) { divFront.querySelector('img').src = mem.imgUrl; divFront.querySelector('img').style.opacity = '1'; divBack.querySelector('.contingut-back').innerHTML = mem.htmlFinal; } else { buscarArasaacAuto(paraula, i); }
                    contenidor.appendChild(divFront); contenidorRevers.appendChild(divBack);
                });
            } else if (mode === 'memory') {
                wrapperRevers.style.display = 'block'; contenidor.classList.add('mode-memory-front');
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula];
                    const fitxaImg = crearElementTargeta(paraula, i, 'front'); fitxaImg.classList.add('nomes-img');
                    const fitxaText = crearElementTargeta(paraula, i, 'front'); fitxaText.classList.add('nomes-text');
                    const pText = fitxaText.querySelector('p'); pText.id = `text-memory-${i}`; 
                    if (mem) { fitxaImg.querySelector('img').src = mem.imgUrl; fitxaImg.querySelector('img').style.opacity = '1'; pText.innerHTML = mem.htmlFinal; } else { buscarArasaacAuto(paraula, i); }
                    contenidor.appendChild(fitxaImg); contenidor.appendChild(fitxaText);
                    contenidorRevers.appendChild(crearElementReversLogoPictojocs()); contenidorRevers.appendChild(crearElementReversLogoPictojocs());
                });
            } else if (mode === 'domino') {
                contenidor.classList.add('mode-domino');
                for(let i=0; i<llista.length; i++) {
                    let textMostrar = dadesDomino[i] ? dadesDomino[i].txt : llista[i]; let paraulaOriginal = llista[i]; 
                    const div = document.createElement('div'); div.className = 'pictograma'; div.dataset.index = i; div.dataset.original = paraulaOriginal;
                    const divImg = document.createElement('div'); divImg.className = 'imatge-box';
                    const img = document.createElement('img'); img.id = `img-${i}-domino`;
                    if(dadesDomino[i] && dadesDomino[i].imgUrl) { img.src = dadesDomino[i].imgUrl; img.style.opacity = '1'; } else { img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png'; buscarArasaacDomino(paraulaOriginal, i); }
                    divImg.appendChild(img);
                    const separador = document.createElement('div'); separador.className = 'separador-domino';
                    const divText = document.createElement('div'); divText.className = 'text-domino';
                    if (dadesDomino[i] && dadesDomino[i].isHtml) divText.innerHTML = dadesDomino[i].txt; else divText.innerHTML = `<span class="fila-paraula">${textMostrar}</span>`;
                    div.appendChild(divImg); div.appendChild(separador); div.appendChild(divText);
                    div.addEventListener('click', () => { if(!div.classList.contains('dragging')) obrirModal(div); });
                    addDragEvents(div);
                    contenidor.appendChild(div);
                }
            } else {
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula]; const targeta = crearElementTargeta(paraula, i, 'front');
                    if(mem) { targeta.querySelector('img').src = mem.imgUrl; targeta.querySelector('img').style.opacity = '1'; targeta.querySelector('p').innerHTML = mem.htmlFinal; } else { buscarArasaacAuto(paraula, i); }
                    contenidor.appendChild(targeta);
                });
            }
            actualitzarEstils();
        }

        function crearElementReversLogoPictojocs() {
            const div = document.createElement('div'); div.className = 'pictograma'; const content = document.createElement('div'); content.className = 'contingut-back-logo';
            const img = document.createElement('img'); img.src = RUTA_LOGO_PICTOJOCS; content.appendChild(img); div.appendChild(content); return div;
        }

        function barrejarDomino() {
            const fitxes = document.querySelectorAll('.pictograma'); let actualImages = []; let actualTexts = [];
            fitxes.forEach((f, index) => { actualImages.push(f.querySelector('img').src); actualTexts.push(f.querySelector('.text-domino').innerHTML); });
            const ultimText = actualTexts.pop(); actualTexts.unshift(ultimText);
            dadesDomino = []; for(let i=0; i<actualImages.length; i++) { dadesDomino.push({ imgUrl: actualImages[i], txt: actualTexts[i], isHtml: true }); }
            generarDocument(); const btn = document.getElementById('btn-mix'); btn.innerText = "âœ… Fet!"; setTimeout(()=> btn.innerText = "Barrejar fitxes", 1500);
        }
        
        function addDragEvents(div) {
            div.draggable = true;
            div.addEventListener('dragstart', () => div.classList.add('dragging'));
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); sincronitzarOrdre(div); });
            let tTo;
            div.addEventListener('touchstart', (e) => { tTo = setTimeout(() => div.classList.add('dragging'), 300); }, {passive: true});
            div.addEventListener('touchmove', (e) => {
                if(!div.classList.contains('dragging')) { clearTimeout(tTo); return; }
                e.preventDefault(); const t = e.touches[0], el = document.elementFromPoint(t.clientX, t.clientY);
                if(el) { const p = el.closest('.pictograma'); if(p && p !== div && p.parentElement === div.parentElement) { const b = p.getBoundingClientRect(); if(t.clientX > b.left + b.width/2) div.parentElement.insertBefore(div, p.nextSibling); else div.parentElement.insertBefore(div, p); } }
            }, {passive: false});
            div.addEventListener('touchend', () => { clearTimeout(tTo); if(div.classList.contains('dragging')){ div.classList.remove('dragging'); sincronitzarOrdre(div); } });
        }

        function crearElementTargeta(paraula, index, tipus) {
            const div = document.createElement('div'); div.className = 'pictograma'; div.dataset.index = index; div.dataset.original = paraula; 
            div.addEventListener('click', () => { if(!div.classList.contains('dragging')) obrirModal(div); });
            addDragEvents(div);
            if (tipus === 'back') {
                const containerText = document.createElement('div'); containerText.id = `text-${index}-${tipus}`; containerText.className = 'contingut-back';
                const span = document.createElement('div'); span.className = 'fila-paraula'; span.innerText = paraula;
                containerText.appendChild(span); div.appendChild(containerText);
            } else {
                const divImg = document.createElement('div'); divImg.className = 'imatge-box'; const img = document.createElement('img'); img.id = `img-${index}-${tipus}`; img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png'; divImg.appendChild(img);
                const p = document.createElement('p'); p.id = `text-${index}-${tipus}`; p.innerHTML = `<span class="fila-paraula">${paraula}</span>`; div.appendChild(divImg); div.appendChild(p);
            }
            return div;
        }

        function sincronitzarOrdre(element) {
            const mode = document.getElementById('selector-mode').value; if (mode === 'memory') return; 
            const isFront = element.parentElement.id === 'contenidor-picts';
            const origen = isFront ? document.getElementById('contenidor-picts') : document.getElementById('contenidor-revers');
            const desti = isFront ? document.getElementById('contenidor-revers') : document.getElementById('contenidor-picts');
            if (!origen || !desti) return;
            const elementsOrigen = Array.from(origen.children); const ordreIndex = elementsOrigen.map(el => el.dataset.index);
            ordreIndex.forEach(idx => { const el = desti.querySelector(`.pictograma[data-index="${idx}"]`); if(el) desti.appendChild(el); });
        }
        
        const conts = [document.getElementById('contenidor-picts'), document.getElementById('contenidor-revers')].filter(Boolean);
        conts.forEach(cont => {
            cont.addEventListener('dragover', (e) => {
                e.preventDefault(); const dragging = document.querySelector('.dragging'); if(!dragging || dragging.parentElement !== cont) return; 
                const siblings = [...cont.querySelectorAll('.pictograma:not(.dragging)')]; let closest = null; let minDistance = Infinity;
                siblings.forEach(sibling => { const box = sibling.getBoundingClientRect(); const d = Math.abs(e.clientY - (box.top + box.height / 2)); if (d < minDistance) { minDistance = d; closest = sibling; } });
                if (closest) { const box = closest.getBoundingClientRect(); if(e.clientX > box.left + box.width/2) cont.insertBefore(dragging, closest.nextSibling); else cont.insertBefore(dragging, closest); } else cont.appendChild(dragging);
            });
        });

        async function buscarArasaacAuto(text, index) {
            try { const r = await fetch(`https://api.arasaac.org/api/pictograms/${idiomaSeleccionat}/search/${encodeURIComponent(text)}`); const d = await r.json(); let src = d.length ? `https://static.arasaac.org/pictograms/${d[0]._id}/${d[0]._id}_500.png` : "https://static.arasaac.org/images/no_results.png"; actualitzarImatgeTargeta(index, src, d.length ? "1" : "0.3"); } catch(e){}
        }

        async function buscarArasaacDomino(text, index) {
            try { const r = await fetch(`https://api.arasaac.org/api/pictograms/${idiomaSeleccionat}/search/${encodeURIComponent(text)}`); const d = await r.json(); let src = d.length ? `https://static.arasaac.org/pictograms/${d[0]._id}/${d[0]._id}_500.png` : "https://static.arasaac.org/images/no_results.png"; const imgEl = document.getElementById(`img-${index}-domino`); if(imgEl) { imgEl.src = src; imgEl.style.opacity = '1'; } if(dadesDomino[index]) dadesDomino[index].imgUrl = src; } catch(e){}
        }

        function actualitzarImatgeTargeta(index, src, opacitat) { const imgFront = document.getElementById(`img-${index}-front`); if(imgFront) { imgFront.src = src; imgFront.style.opacity = opacitat; } }

        function actualitzarOpcionsColumnes() {
            const paper = document.getElementById('mida-paper').value;
            const colSelect = document.getElementById('selector-columnes');
            const valActual = parseInt(colSelect.value);
            let maxCols = paper === 'a3' ? 10 : 5;
            colSelect.innerHTML = '';
            for(let i=1; i<=maxCols; i++) colSelect.innerHTML += `<option value="${i}">${i} columna${i>1?'s':''}</option>`;
            colSelect.value = valActual <= maxCols ? valActual : maxCols;
        }

        function actualitzarEstils() {
            const doc = document.documentElement.style;
            doc.setProperty('--tipus-font', document.getElementById('selector-font').value);
            const paper = document.getElementById('mida-paper').value;
            const sentit = document.getElementById('sentit-paper').value;
            if (paper === 'a3') { doc.setProperty('--width-paper', sentit === 'horitzontal' ? '420mm' : '297mm'); doc.setProperty('--height-paper', sentit === 'horitzontal' ? '297mm' : '420mm'); } 
            else { doc.setProperty('--width-paper', sentit === 'horitzontal' ? '297mm' : '210mm'); doc.setProperty('--height-paper', sentit === 'horitzontal' ? '210mm' : '297mm'); }
            doc.setProperty('--num-columnes', document.getElementById('selector-columnes').value);
            setTimeout(() => {
                const mode = document.getElementById('selector-mode').value;
                if(mode === 'targeta') document.querySelectorAll('.contingut-back').forEach(el => autoMidaText(el));
                else if(mode === 'memory') document.querySelectorAll('.nomes-text p').forEach(el => autoMidaText(el));
                else if(mode === 'domino') document.querySelectorAll('.text-domino').forEach(el => autoMidaText(el));
                else document.querySelectorAll('.pictograma p').forEach(el => autoMidaText(el));
            }, 50); 
        }

        const _tCv=document.createElement('canvas'),_tCtx=_tCv.getContext('2d');
        function autoMidaText(c){
            if(!c)return;
            const f=c.querySelectorAll('.fila-paraula'),isPX=c.closest('#view-pictotraductor')!==null,maxW=c.clientWidth-12,maxH=c.clientHeight-4;
            if(maxW<=0||maxH<=0)return;
            let bS=isPX?34:44;
            const font=window.getComputedStyle(c).fontFamily||'Arial';
            if(f.length>0){
                const mH=Math.floor(maxH/(f.length*1.1));
                if(bS>mH)bS=mH;
                f.forEach(l=>{
                    l.style.whiteSpace='nowrap';
                    _tCtx.font=`bold 100px ${font}`;
                    const w=_tCtx.measureText(l.innerText).width;
                    let s=bS;
                    if(w>0){const fW=Math.floor(maxW*(100/w));if(fW<s)s=fW}
                    l.style.fontSize=s+'px';l.style.lineHeight='1.1'
                });
            }else{
                c.style.whiteSpace='nowrap';
                const mH=Math.floor(maxH/1.1);
                if(bS>mH)bS=mH;
                _tCtx.font=`bold 100px ${font}`;
                const w=_tCtx.measureText(c.innerText).width;
                let s=bS;
                if(w>0){const fW=Math.floor(maxW*(100/w));if(fW<s)s=fW}
                c.style.fontSize=s+'px';c.style.lineHeight='1.1'
            }
        }

        function obrirModalPromptIA() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { alert("âš ï¸ Encara no has afegit la teva clau API!\n\nPer utilitzar aquest mÃ¨tode intelÂ·ligent, clica a la icona 'ğŸ¤– ConfiguraciÃ³ IA' de dalt a la dreta i enganxa-hi la teva clau gratuÃ¯ta de Google Gemini."); return; }
            document.getElementById('ia-prompt-text').value = '';
            document.getElementById('modal-prompt-ia').style.display = 'flex';
        }

        async function generarLlistaIA() {
            const apiKey = localStorage.getItem('gemini_api_key');
            const promptUser = document.getElementById('ia-prompt-text').value.trim();
            if (!promptUser) return;
            const lang = document.getElementById('idioma').options[document.getElementById('idioma').selectedIndex].text;
            const btn = document.getElementById('btn-exec-ia');
            btn.innerHTML = "â³ Generant..."; btn.disabled = true;
            const prompt = `Ets un expert en crear materials educatius amb pictogrames (com ARASAAC). \nEl mestre et demana: "${promptUser}".\nGenera una llista ordenada i lÃ²gica de paraules que encaixin perfectament amb el que demana. \nIdioma de les paraules: ${lang}.\nNormes:\n- Retorna ÃšNICAMENT les paraules separades per comes.\n- No posis cap text extra, ni llistes numerades, ni explicacions.\n- Usa paraules en la seva forma de diccionari (infinitius, singulars) sempre que sigui possible, ja que sÃ³n mÃ©s fÃ cils de trobar com a pictogrames.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.trim().replace(/\n/g, ', ').replace(/,\s*,/g, ',');
                document.getElementById('llista-paraules').value = text; document.getElementById('modal-prompt-ia').style.display = 'none'; generarDocument();
            } catch (err) { alert("Error connectant amb la IA: " + err.message); } finally { btn.innerHTML = "âœ… Generar"; btn.disabled = false; }
        }

        const stopWords = new Set(["el", "la", "els", "les", "un", "una", "uns", "unes", "a", "al", "als", "de", "del", "dels", "en", "per", "amb", "i", "o", "u", "si", "no", "que", "quÃ¨", "com", "on", "em", "et", "es", "ens", "us", "meu", "meva", "teu", "teva", "seu", "seva", "si us plau", "sisplau", "hi", "ho", "li", "puc", "podem", "vull", "volem", "los", "las", "unos", "unas", "por", "para", "con", "y", "quÃ©", "como", "donde", "me", "te", "se", "nos", "os", "mi", "tu", "su", "por favor", "puedo", "podemos", "quiero", "queremos", "the", "an", "to", "of", "in", "for", "on", "with", "at", "by", "from", "and", "or", "but", "is", "are", "am", "was", "were", "be", "been", "being", "you", "he", "she", "it", "we", "they", "my", "your", "his", "her", "its", "our", "their", "please", "can", "could", "would", "will", "shall", "should", "may", "might", "must", "do", "does", "did", "have", "has", "had", "ein", "eine", "einer", "eines", "einem", "einen", "der", "die", "das", "den", "dem", "des", "ich", "du", "er", "sie", "es", "wir", "ihr", "mich", "dich", "sich", "uns", "euch", "ist", "sind", "war", "waren", "sein", "haben", "hat", "hatte", "bitte", "ÛÛ’", "ÛÛŒÚº", "Ø§ÙˆØ±", "Ù…ÛŒÚº", "Ú©Ùˆ", "Ú©Ø§", "Ú©ÛŒ", "Ú©Û’", "Ø³Û’", "ÛŒÛ", "ÙˆÛ", "à¨¨à©‚à©°", "à¨¦à¨¾", "à¨¦à©€", "à¨¦à©‡", "à¨¹à©ˆ", "à¨¹à¨¨", "à¨…à¨¤à©‡", "à¨µà¨¿à©±à¨š", "à¨¨à¨¾à¨²", "à¨‡à©±à¨•"]);
        const negacioWords = new Set(["no", "not", "don't", "dont", "can't", "cant", "cannot", "won't", "wont", "never", "ni", "sin", "nunca", "pas", "ne", "nicht", "kein", "keine", "non", "mai", "Ù„Ø§", "Ù„ÙŠØ³", "Ù…Ø§", "Ğ½Ğµ", "Ğ½ĞµÑ‚", "Ğ½Ñ–ĞºĞ¾Ğ»Ğ¸", "nie", "nu", "à¨¨à¨¹à©€à¨‚", "Ù†ÛÛŒÚº"]);
        function netejarParaula(paraula) { return paraula.replace(/^[.,?!Â¡Â¿()]+|[.,?!Â¡Â¿()]+$/g, '').toLowerCase(); }

        function segmentarParaules(text, langCode) {
            const raw = (text || '').toString().trim();
            if (!raw) return [];
            try {
                if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                    const segmenter = new Intl.Segmenter(langCode || 'und', { granularity: 'word' });
                    const tokens = [];
                    for (const part of segmenter.segment(raw)) {
                        if (!part.isWordLike) continue;
                        const token = netejarParaula(part.segment);
                        if (token) tokens.push(token);
                    }
                    if (tokens.length) return tokens;
                }
            } catch (e) {}
            const fallbackTokens = raw.match(/[\p{L}\p{M}\p{N}'â€™-]+/gu) || raw.split(/\s+/);
            return fallbackTokens.map(netejarParaula).filter(Boolean);
        }

        function extreureParaulesNegades(frase) {
            const result = new Set();
            const tokens = segmentarParaules(frase, 'und');
            for (let i = 0; i < tokens.length; i++) {
                if (!negacioWords.has(tokens[i])) continue;
                for (let j = i + 1; j < tokens.length; j++) {
                    const t = tokens[j];
                    if (t.length < 2 || stopWords.has(t) || negacioWords.has(t)) continue;
                    result.add(t);
                    break;
                }
            }
            return result;
        }

        function obtenirMinimPictogrames(fraseTraduida) {
            const tokens = segmentarParaules(fraseTraduida, 'und').filter(t => t && t.length >= 2 && !stopWords.has(t));
            if (!tokens.length) return 1;
            return Math.min(8, Math.max(3, Math.floor(tokens.length * 0.75)));
        }

        const GLOBAL_SYMBOLS_CONFIG = {
            enabled: true,
            baseUrl: "https://www.globalsymbols.com/api/v1"
        };

        function extreureResultatsGlobalSymbols(data) {
            if (Array.isArray(data)) return data;
            if (Array.isArray(data?.results)) return data.results;
            if (Array.isArray(data?.items)) return data.items;
            if (Array.isArray(data?.symbols)) return data.symbols;
            if (Array.isArray(data?.data)) return data.data;
            return [];
        }

        function extreureResultatsArasaac(data) {
            if (Array.isArray(data)) return data;
            if (Array.isArray(data?.value)) return data.value;
            if (Array.isArray(data?.results)) return data.results;
            return [];
        }

        function extreureImatgeGlobalSymbols(item) {
            if (!item || typeof item !== 'object') return null;
            return item.image_url || item.imageUrl || item.icon_url || item.iconUrl || item.symbol_url || item.symbolUrl || item.png_url || item.pngUrl || item.svg_url || item.svgUrl || item.url || item?.image?.url || null;
        }

        async function buscarPictogramaArasaac(paraula, lang) {
            try {
                const r = await fetch(`https://api.arasaac.org/api/pictograms/${lang}/bestsearch/${encodeURIComponent(paraula)}`);
                const d = await r.json();
                const resultats = extreureResultatsArasaac(d);
                if (resultats.length > 0) {
                    const id = resultats[0]._id;
                    return { src: `https://static.arasaac.org/pictograms/${id}/${id}_300.png`, source: 'arasaac' };
                }
            } catch (e) {}
            return null;
        }

        async function buscarPictogramaGlobalSymbols(paraula, lang) {
            if (!GLOBAL_SYMBOLS_CONFIG.enabled || !GLOBAL_SYMBOLS_CONFIG.baseUrl) return null;
            const base = GLOBAL_SYMBOLS_CONFIG.baseUrl.replace(/\/$/, '');
            const urls = [
                `${base}/symbols/search?q=${encodeURIComponent(paraula)}&language=${encodeURIComponent(lang)}`,
                `${base}/symbols/search?query=${encodeURIComponent(paraula)}&language=${encodeURIComponent(lang)}`,
                `${base}/search?q=${encodeURIComponent(paraula)}&language=${encodeURIComponent(lang)}`,
                `${base}/labels/search?query=${encodeURIComponent(paraula)}&language=${encodeURIComponent(lang)}`
            ];
            for (const url of urls) {
                try {
                    const r = await fetch(url);
                    if (!r.ok) continue;
                    const d = await r.json();
                    const items = extreureResultatsGlobalSymbols(d);
                    if (!items.length) continue;
                    const img = extreureImatgeGlobalSymbols(items[0]);
                    if (img) return { src: img, source: 'globalsymbols' };
                } catch (e) {}
            }
            return null;
        }

        async function buscarPictogramaAmbFallback(paraula, lang, opts = {}) {
            const variants = [paraula, ...(opts.variants || [])]
                .map(v => (v || '').toString().trim())
                .filter(Boolean);
            const seen = new Set();
            const variantsUnics = variants.filter(v => {
                const k = netejarParaula(v);
                if (!k || seen.has(k)) return false;
                seen.add(k);
                return true;
            });

            const langsArasaac = opts.langsArasaac || [lang, 'ca', 'es', 'en'];
            const langsGlobal = opts.langsGlobal || [lang, 'en', 'es'];

            for (const variant of variantsUnics) {
                for (const idioma of langsArasaac) {
                    const arasaac = await buscarPictogramaArasaac(variant, idioma);
                    if (arasaac) return arasaac;
                }
            }
            for (const variant of variantsUnics) {
                for (const idioma of langsGlobal) {
                    const globalSymbols = await buscarPictogramaGlobalSymbols(variant, idioma);
                    if (globalSymbols) return globalSymbols;
                }
            }
            return null;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition(); recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = function() { isListening = true; const btn = document.getElementById('btn-mic-trad'); btn.classList.add('escoltant'); btn.innerHTML = textListen; document.getElementById('text-input').value = ""; document.getElementById('text-input').placeholder = "..."; };
            recognition.onend = function() { isListening = false; const btn = document.getElementById('btn-mic-trad'); btn.classList.remove('escoltant'); btn.innerHTML = textSpeak; canviarIdiomaUI(); };
            recognition.onresult = function(event) { document.getElementById('text-input').value = event.results[0][0].transcript; executarTraduccio(); };
        } else { document.getElementById('btn-mic-trad').style.display = 'none'; }

        function activarMicrofon() {
            if (!recognition) return;
            if (isListening) { recognition.stop(); return; }
            let idio = document.getElementById('idioma-input').value;
            const speechLangMap = { 'ca': 'ca-ES', 'es': 'es-ES', 'en': 'en-US', 'fr': 'fr-FR', 'de': 'de-DE', 'it': 'it-IT', 'pt': 'pt-PT', 'nl': 'nl-NL', 'ro': 'ro-RO', 'pl': 'pl-PL', 'uk': 'uk-UA', 'ru': 'ru-RU', 'bg': 'bg-BG', 'ar': 'ar-SA', 'zh': 'zh-CN', 'fa': 'fa-IR', 'he': 'he-IL', 'el': 'el-GR', 'eu': 'eu-ES', 'gl': 'gl-ES', 'val': 'ca-ES', 'cs': 'cs-CZ', 'sk': 'sk-SK', 'sl': 'sl-SI', 'hr': 'hr-HR', 'sr': 'sr-RS', 'mk': 'mk-MK', 'sq': 'sq-AL', 'hu': 'hu-HU', 'da': 'da-DK', 'sv': 'sv-SE', 'fi': 'fi-FI', 'et': 'et-EE', 'lt': 'lt-LT', 'lv': 'lv-LV', 'ko': 'ko-KR', 'ur': 'ur-PK', 'pa': 'pa-IN' };
            recognition.lang = speechLangMap[idio] || idio;
            try {
                recognition.start();
            } catch (e) {
                try {
                    recognition.stop();
                    setTimeout(() => recognition.start(), 120);
                } catch (e2) {
                    alert("No s'ha pogut activar el micrÃ²fon. Revisa permisos del navegador per al micro.");
                }
            }
        }

        function obrirSettings() { document.getElementById('gemini-api-key').value = localStorage.getItem('gemini_api_key') || ""; document.getElementById('modal-settings').style.display = 'flex'; }
        function guardarSettings() { localStorage.setItem('gemini_api_key', document.getElementById('gemini-api-key').value.trim()); document.getElementById('modal-settings').style.display = 'none'; }

        async function executarTraduccio() {
            const frase = document.getElementById('text-input').value.trim(); if(!frase) return;
            const btnTrad = document.getElementById('btn-trad'); btnTrad.innerHTML = `<div class="loader" style="margin:0;"></div>`; btnTrad.disabled = true;
            document.getElementById('resultat-pictos').innerHTML = ''; document.getElementById('traduccio-literal-box').style.display = 'none';
            const apiKey = (localStorage.getItem('gemini_api_key') || '').trim();
            let processat = false;
            if (apiKey) processat = await processarAmbGemini(frase, apiKey);
            if (!processat) await processarBasic(frase);
            const lang = document.getElementById('idioma-input').value; const texts = uiDict[lang] || uiDict['ca'];
            btnTrad.innerHTML = texts[5]; btnTrad.disabled = false;
        }

        function parseRespostaGemini(rawText) {
            if (!rawText || typeof rawText !== 'string') return null;
            let text = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            try { return JSON.parse(text); } catch (e) {}
            const ini = text.indexOf('{');
            const fi = text.lastIndexOf('}');
            if (ini !== -1 && fi !== -1 && fi > ini) {
                const candidate = text.slice(ini, fi + 1).replace(/,\s*([}\]])/g, '$1');
                try { return JSON.parse(candidate); } catch (e) {}
            }
            return null;
        }

        async function fetchGeminiJson(prompt, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: 0.2
                }
            };

            let response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            let data = await response.json();

            if (data?.error?.message) {
                const fallbackPayload = { contents: [{ parts: [{ text: prompt }] }] };
                response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fallbackPayload)
                });
                data = await response.json();
            }

            if (data?.error?.message) throw new Error(data.error.message);
            return data;
        }

        async function fetchGeminiText(prompt, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.2 }
                })
            });
            const data = await response.json();
            if (data?.error?.message) throw new Error(data.error.message);
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error('Resposta textual buida de Gemini');
            return text.toString().trim();
        }

        async function processarAmbGeminiRescat(text, apiKey, langOrigen, langDesti) {
            try {
                const promptTraduccio = `Tradueix aquesta frase de '${langOrigen}' a '${langDesti}' corregint possibles errors de transcripciÃ³ o ortografia, sense canviar la intenciÃ³. Retorna NOMÃ‰S la frase final traduÃ¯da, sense cap explicaciÃ³: ${text}`;
                const traduccioLiteral = await fetchGeminiText(promptTraduccio, apiKey);
                document.getElementById('text-traduit-literal').innerText = traduccioLiteral;
                document.getElementById('traduccio-literal-box').style.display = 'block';

                const promptKeywords = `A partir de la frase "${traduccioLiteral}" en idioma '${langDesti}', retorna entre 4 i 8 paraules clau Ãºtils per pictogrames, separades nomÃ©s per comes. MantÃ©n la negaciÃ³ amb prefix NO: davant la paraula negada quan calgui. Sense explicacions.`;
                const keywordsRaw = await fetchGeminiText(promptKeywords, apiKey);
                const negadesOriginal = extreureParaulesNegades(text);
                const pictosAfegits = new Set();
                let creades = 0;

                const terms = keywordsRaw
                    .replace(/\n/g, ',')
                    .split(',')
                    .map(t => t.trim())
                    .filter(Boolean);

                for (const termRaw of terms) {
                    const negadaPrefix = /^NO\s*:\s*/i.test(termRaw);
                    const term = termRaw.replace(/^NO\s*:\s*/i, '').trim();
                    const key = netejarParaula(term);
                    if (!key || pictosAfegits.has(key)) continue;
                    const pictograma = await buscarPictogramaAmbFallback(term, langDesti, { variants: [key] });
                    if (pictograma) {
                        const negada = negadaPrefix || negadesOriginal.has(key);
                        crearTargetaTrad(term, term, pictograma.src, langOrigen, pictograma.source, negada);
                        pictosAfegits.add(key);
                        creades++;
                    }
                }

                const minim = obtenirMinimPictogrames(traduccioLiteral);
                if (creades < minim) {
                    await generarPictogramesDesDeText(traduccioLiteral, text, langDesti, langOrigen, {
                        maxAfegir: Math.max(1, minim - creades),
                        pictosAfegits,
                        negadesOriginal,
                        modeAgressiu: true
                    });
                }
                return true;
            } catch (e) {
                console.error('Error al rescat IA:', e);
                return false;
            }
        }

        async function processarAmbGemini(text, apiKey) {
            const langOrigen = document.getElementById('idioma-input').value; 
            const langDesti = document.getElementById('idioma-desti').value;
            const prompt = `Actua com el cervell d'un comunicador augmentatiu escolar. Un alumne ha escrit o dit aquesta frase en l'idioma amb codi ISO '${langOrigen}': "${text}". Vol traduir-ho a l'idioma amb codi ISO '${langDesti}'.\nPrimer, corregeix errors ortogrÃ fics o de transcripciÃ³ per entendre bÃ© el missatge (sense canviar la intenciÃ³). Si la frase Ã©s incomprensible, posa te_sentit a false.\nRetorna ÃšNICAMENT un objecte JSON (sense markdown) amb aquesta estructura:\n{\n  "te_sentit": true o false,\n  "missatge_error": "Si no tÃ© sentit, missatge curt en idioma origen.",\n  "traduccio_literal": "Frase completa traduÃ¯da a l'idioma destÃ­",\n  "pictogrames": [\n    {"cat": "lema a l'idioma destÃ­", "orig": "terme original corresponent", "negada": true o false}\n  ]\n}\nRegles de qualitat: \n- Prioritza comprensiÃ³ completa del missatge.\n- Dona entre 4 i 8 pictogrames si la frase ho permet.\n- Evita articles/preposicions que no aportin significat, perÃ² mantÃ©n negacions, temps, lloc i accions essencials.\n- MantÃ©n cobertura semÃ ntica equivalent independentment de l'idioma origen (Ã rabs, cirÃ­lÂ·lics, etc.).`;
            try {
                const data = await fetchGeminiJson(prompt, apiKey);
                const textResposta = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!textResposta) throw new Error("Resposta IA buida o no vÃ lida.");
                const resultat = parseRespostaGemini(textResposta);
                if(!resultat) {
                    const rescatOk = await processarAmbGeminiRescat(text, apiKey, langOrigen, langDesti);
                    if (rescatOk) return true;
                    throw new Error("No s'ha pogut interpretar la resposta de la IA.");
                }
                if(!resultat.te_sentit) { alert(resultat.missatge_error || "No s'ha entÃ¨s la frase."); return true; }
                const traduccioLiteral = (resultat.traduccio_literal || resultat.traduccio || text).toString();
                document.getElementById('text-traduit-literal').innerText = traduccioLiteral; document.getElementById('traduccio-literal-box').style.display = 'block';
                const negadesOriginal = extreureParaulesNegades(text);
                const pictosAfegits = new Set();
                let creades = 0;
                const pictogrames = Array.isArray(resultat.pictogrames)
                    ? resultat.pictogrames
                    : (Array.isArray(resultat.keywords) ? resultat.keywords : []);
                for (let picto of pictogrames) {
                    try { 
                        const textCat = (typeof picto === 'string' ? picto : (picto?.cat || picto?.lemma || picto?.text || picto?.word || '')).toString().trim();
                        const textOrig = (picto?.orig || picto?.original || picto?.source || textCat).toString().trim();
                        if (!textCat) continue;
                        const key = netejarParaula(textCat);
                        if (!key || pictosAfegits.has(key)) continue;
                        const arasaacHint = (picto?.arasaac || picto?.base || picto?.root || '').toString().trim();
                        const pictograma = await buscarPictogramaAmbFallback(textCat, langDesti, {
                            variants: [arasaacHint, textOrig, key]
                        });
                        const negada = Boolean(picto?.negada || picto?.negat || picto?.negative || negadesOriginal.has(netejarParaula(textOrig)) || negadesOriginal.has(key));
                        if (pictograma) { crearTargetaTrad(textCat, textOrig, pictograma.src, langOrigen, pictograma.source, negada); pictosAfegits.add(key); creades++; }
                    } catch(e) {} 
                }
                const minim = obtenirMinimPictogrames(traduccioLiteral);
                if (creades < minim) {
                    const afegides = await generarPictogramesDesDeText(traduccioLiteral, text, langDesti, langOrigen, {
                        maxAfegir: Math.max(1, minim - creades),
                        pictosAfegits,
                        negadesOriginal
                    });
                    creades += afegides;
                    if (creades < minim) {
                        await generarPictogramesDesDeText(traduccioLiteral, text, langDesti, langOrigen, {
                            maxAfegir: Math.max(1, minim - creades),
                            pictosAfegits,
                            negadesOriginal,
                            modeAgressiu: true
                        });
                    }
                }
                return true;
            } catch(e) {
                console.error('Error processant IA:', e);
                alert("EstÃ s traduint molt de pressa i la IA necessita un descans! Espera un minut per tornar a fer servir les traduccions avanÃ§ades. Mentrestant, farem servir el mode bÃ sic.");
                return false;
            }
        }

        async function generarPictogramesDesDeText(fraseTraduida, fraseOriginal, langDesti, langOrigen, opts = {}) {
            let creades = 0;
            let textKilled = (fraseTraduida || '').toLowerCase().replace("si us plau", "").replace("por favor", "").replace("please", "");
            const paraules = segmentarParaules(textKilled, langDesti);
            const paraulesOriginals = segmentarParaules((fraseOriginal || fraseTraduida || ''), langOrigen);
            const maxAfegir = typeof opts.maxAfegir === 'number' ? opts.maxAfegir : Number.MAX_SAFE_INTEGER;
            const pictosAfegits = opts.pictosAfegits || new Set();
            const negadesOriginal = opts.negadesOriginal || extreureParaulesNegades(fraseOriginal);
            const modeAgressiu = Boolean(opts.modeAgressiu);
            for (let i=0; i<paraules.length; i++) {
                if (creades >= maxAfegir) break;
                let paraula = paraules[i]; let pNeta = netejarParaula(paraula); if (pNeta.length < 2) continue; if (!modeAgressiu && stopWords.has(pNeta)) continue;
                if (pictosAfegits.has(pNeta)) continue;
                try {
                    const pictograma = await buscarPictogramaAmbFallback(pNeta, langDesti);
                    if (pictograma) {
                        let paraulaPrincipal = pNeta;
                        let paraulaAnotada = paraulesOriginals[i] ? netejarParaula(paraulesOriginals[i]) : pNeta;
                        const negada = negadesOriginal.has(paraulaAnotada) || negadesOriginal.has(paraulaPrincipal);
                        crearTargetaTrad(paraulaPrincipal, paraulaAnotada, pictograma.src, langOrigen, pictograma.source, negada);
                        pictosAfegits.add(pNeta);
                        creades++;
                    }
                } catch (err) {}
            }
            return creades;
        }

        async function processarBasic(frase) {
            const langOrigen = document.getElementById('idioma-input').value; 
            const langDesti = document.getElementById('idioma-desti').value; 
            let fraseTraduida = frase;
            if (langOrigen !== langDesti) { 
                try { 
                    const resT = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(frase)}&langpair=${langOrigen}|${langDesti}`); 
                    const dataT = await resT.json(); 
                    if(dataT.responseData && dataT.responseData.translatedText) { 
                        if(dataT.responseData.translatedText.includes('MYMEMORY WARNING')) { 
                            alert("âš ï¸ Has superat el lÃ­mit de traduccions gratuÃ¯tes per avui.\nSi us plau, afegeix la teva clau de Google Gemini a 'ConfiguraciÃ³ IA' per continuar sense lÃ­mits."); 
                            document.getElementById('text-traduit-literal').innerText = "âš ï¸ LÃ­mit de traducciÃ³ assolit."; 
                            document.getElementById('traduccio-literal-box').style.display = 'block'; 
                            return; 
                        }
                        fraseTraduida = dataT.responseData.translatedText; 
                        document.getElementById('text-traduit-literal').innerText = fraseTraduida; 
                        document.getElementById('traduccio-literal-box').style.display = 'block'; 
                    } 
                } catch(e) {} 
            } else { 
                document.getElementById('text-traduit-literal').innerText = frase; document.getElementById('traduccio-literal-box').style.display = 'block'; 
            }
            await generarPictogramesDesDeText(fraseTraduida, frase, langDesti, langOrigen);
        }

        let numTargetesTrad = 0;
        function crearTargetaTrad(textCat, textOrig, imgUrl, langCode, source = 'arasaac', negada = false) {
            const contenidor = document.getElementById('resultat-pictos'); const div = document.createElement('div'); div.className = 'pictograma'; div.dataset.index = numTargetesTrad++; div.dataset.orig = textOrig;
            if (negada) div.classList.add('negat');
            let htmlOriginal = ''; if (textCat.toLowerCase() !== textOrig.toLowerCase()) { htmlOriginal = `<span class="fila-paraula text-alumne">(${textOrig})</span>`; }
            div.innerHTML = `<div class="imatge-box"><img src="${imgUrl}"></div><p><span class="fila-paraula text-traduit">${textCat}</span>${htmlOriginal}</p>`;
            div.onclick = function() { obrirModal(this); }; contenidor.appendChild(div);
            setTimeout(() => autoMidaText(div.querySelector('p')), 50);
        }

        function obrirModal(el) {
            elementEditant = el;
            if (currentView === 'pictotraductor') { document.getElementById('tab-btn-traductor').style.display = 'none'; document.getElementById('tab-btn-pujar').style.display = 'none'; document.getElementById('tab-btn-ia').style.display = 'none'; } 
            else { document.getElementById('tab-btn-traductor').style.display = 'flex'; document.getElementById('tab-btn-pujar').style.display = 'flex'; document.getElementById('tab-btn-ia').style.display = 'flex'; }
            let imgTarget = null;
            if (currentView === 'pictojocs' && document.getElementById('selector-mode').value === 'memory') { const index = el.dataset.index; if (el.classList.contains('nomes-img')) imgTarget = el.querySelector('img'); else { const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if(imgCard) imgTarget = imgCard.querySelector('img'); } } 
            else { imgTarget = el.querySelector('img'); }
            imgOriginalSrcOnOpen = imgTarget ? imgTarget.src : '';
            const containerInputs = document.getElementById('camps-text'); containerInputs.innerHTML = ''; let paraulaCerca = '';
            if (currentView === 'pictotraductor') {
                containerInputs.className = `inputs-container-modal dues-paraules`; const p = el.querySelector('p'); const trad = p.querySelector('.text-traduit'); let v0 = trad ? trad.innerText : ""; let v1 = el.dataset.orig || "";
                containerInputs.innerHTML += `<input type="text" class="input-text-modal" id="input-modal-0" value="${v1}" placeholder="Text Principal">`; containerInputs.innerHTML += `<input type="text" class="input-text-modal" id="input-modal-1" value="${v0}" placeholder="Text Secundari">`; paraulaCerca = v1 || v0;
            } else {
                const mode = document.getElementById('selector-mode').value; let containerTxt = null; let maxInputs = (mode === 'targeta' || mode === 'memory') ? 5 : 2; let classeLayout = (mode === 'targeta' || mode === 'memory') ? "cinc-paraules" : "dues-paraules";
                if (mode === 'domino') containerTxt = el.querySelector('.text-domino'); else if (mode === 'targeta') containerTxt = document.getElementById(`text-${el.dataset.index}-back`); else containerTxt = el.querySelector('p');
                let paraulesActuals = []; if(containerTxt) { const files = containerTxt.querySelectorAll('.fila-paraula'); if(files.length > 0) files.forEach(f => paraulesActuals.push(f.innerText)); else paraulesActuals.push(containerTxt.innerText); }
                containerInputs.className = `inputs-container-modal ${classeLayout}`;
                for(let i=0; i<maxInputs; i++) { const val = paraulesActuals[i] || ""; containerInputs.innerHTML += `<input type="text" class="input-text-modal" id="input-modal-${i}" value="${val}" placeholder="Text ${i+1}">`; }
                paraulaCerca = el.dataset.original || paraulesActuals[0] || "";
            }
            document.getElementById('input-arasaac').value = paraulaCerca; document.getElementById('resultats-traductor').innerHTML = ''; document.getElementById('modal-edicio').style.display = 'flex'; canviarPestanya('tab-arasaac'); if(paraulaCerca) buscarArasaacModal();
        }

        function setTargetColor(color, btnElem) { currentColorSelected = color; document.querySelectorAll('.color-btn').forEach(b => b.style.borderColor = '#ccc'); if(btnElem) btnElem.style.borderColor = '#333'; }

        function guardarTancar() {
            if(elementEditant) {
                if (document.getElementById('tab-dibuix').style.display === 'block') { aplicarEdicioImatge(false); }
                if (currentView === 'pictotraductor') {
                    let txtCat = document.getElementById('input-modal-1').value.trim(); let txtOrig = document.getElementById('input-modal-0').value.trim();
                    let p = elementEditant.querySelector('p'); let html = `<span class="fila-paraula text-traduit">${txtCat}</span>`; if(txtOrig !== "") html += `<span class="fila-paraula text-alumne">(${txtOrig})</span>`;
                    p.innerHTML = html; elementEditant.dataset.orig = txtOrig; setTimeout(() => autoMidaText(p), 50);
                } else {
                    const mode = document.getElementById('selector-mode').value; const index = elementEditant.dataset.index; const original = elementEditant.dataset.original;
                    let nousTextos = []; document.querySelectorAll('.input-text-modal').forEach(inp => { if(inp.value.trim() !== "") nousTextos.push(inp.value.trim()); });
                    let htmlFinal = nousTextos.map(t => `<div class="fila-paraula">${t}</div>`).join(''); if(htmlFinal === "") htmlFinal = `<div class="fila-paraula">&nbsp;</div>`; let currentImgUrl = null;
                    if (mode === 'domino') { currentImgUrl = elementEditant.querySelector('img').src; } else if (mode === 'memory') { const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if (imgCard) currentImgUrl = imgCard.querySelector('img').src; } else { currentImgUrl = elementEditant.querySelector('img') ? elementEditant.querySelector('img').src : null; }
                    memoriaEdicions[original] = { htmlFinal: htmlFinal, imgUrl: currentImgUrl };
                    if (mode === 'domino') { elementEditant.querySelector('.text-domino').innerHTML = htmlFinal; autoMidaText(elementEditant.querySelector('.text-domino')); if(dadesDomino[index]) { dadesDomino[index].txt = htmlFinal; dadesDomino[index].isHtml = true; } } else if (mode === 'targeta') { document.getElementById(`text-${index}-back`).innerHTML = htmlFinal; autoMidaText(document.getElementById(`text-${index}-back`)); } else if (mode === 'memory') { if(elementEditant.classList.contains('nomes-text')) { elementEditant.querySelector('p').innerHTML = htmlFinal; autoMidaText(elementEditant.querySelector('p')); } else { const p = elementEditant.querySelector('p'); if(p) p.innerHTML = htmlFinal; } } else { const p = elementEditant.querySelector('p'); p.innerHTML = htmlFinal; autoMidaText(p); }
                    if(currentColorSelected !== '#ffffff') { elementEditant.style.backgroundColor = currentColorSelected; }
                }
            } tancarModal();
        }

        function tancarModalSenseGuardar() { 
            if(elementEditant && imgOriginalSrcOnOpen) {
                 if(currentView === 'pictotraductor') { elementEditant.querySelector('img').src = imgOriginalSrcOnOpen; }
                 else {
                     const index = elementEditant.dataset.index; const mode = document.getElementById('selector-mode').value;
                     if (mode === 'domino') { elementEditant.querySelector('img').src = imgOriginalSrcOnOpen; } else if (mode === 'memory') { if (elementEditant.classList.contains('nomes-img')) elementEditant.querySelector('img').src = imgOriginalSrcOnOpen; else { const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if(imgCard) imgCard.querySelector('img').src = imgOriginalSrcOnOpen; } } else { const img = document.getElementById(`img-${index}-front`); if(img) img.src = imgOriginalSrcOnOpen; }
                 }
            } tancarModal(); 
        }
        
        function tancarModal() { document.getElementById('modal-edicio').style.display = 'none'; elementEditant = null; currentColorSelected = '#ffffff'; document.querySelectorAll('.color-btn').forEach(b => b.style.borderColor = '#ccc'); }
        function eliminarTargeta() { if(!elementEditant) return; if(confirm("Segur que vols eliminar aquesta targeta?")) { if (currentView === 'pictotraductor') { elementEditant.remove(); tancarModal(); } else { const original = elementEditant.dataset.original; let llista = document.getElementById('llista-paraules').value.split(',').map(p=>p.trim()).filter(p=>p!==''); const idx = llista.indexOf(original); if(idx > -1) { llista.splice(idx, 1); document.getElementById('llista-paraules').value = llista.join(', '); tancarModal(); generarDocument(); } } } }
        function canviarPestanya(id) { document.querySelectorAll('.contingut-tab').forEach(e=>e.style.display='none'); document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('actiu')); document.getElementById(id).style.display='block'; document.querySelectorAll(`.tab-btn[onclick*="${id}"]`).forEach(b=>b.classList.add('actiu')); }
        function aplicarImatge(src) { 
            if(elementEditant) { 
                if (currentView === 'pictotraductor') { const img = elementEditant.querySelector('img'); if(img) img.src = src; }
                else {
                    const index = elementEditant.dataset.index; const mode = document.getElementById('selector-mode').value;
                    if (mode === 'domino') { elementEditant.querySelector('img').src = src; } else if (mode === 'memory') { if (elementEditant.classList.contains('nomes-img')) { elementEditant.querySelector('img').src = src; } else { const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if(imgCard) imgCard.querySelector('img').src = src; } } else { const img = document.getElementById(`img-${index}-front`); if(img) { img.src = src; img.style.opacity = '1'; } }
                }
            } 
        }

        async function buscarArasaacModal() { 
            const q = document.getElementById('input-arasaac').value; const div = document.getElementById('resultats-arasaac'); div.innerHTML = ''; let lang = currentView === 'pictojocs' ? document.getElementById('idioma').value : (document.getElementById('idioma-input') ? document.getElementById('idioma-input').value : 'ca');
            const arasaacLangs = ['ar','bg','br','ca','da','de','el','en','es','et','eu','fa','fi','fr','ga','gl','he','hr','hu','it','ko','lt','mk','nl','pl','pt','ro','ru','sk','sl','sq','sr','sv','uk','val','zh'];
            let found = false;
            if (arasaacLangs.includes(lang)) { try { const r = await fetch(`https://api.arasaac.org/api/pictograms/${lang}/search/${encodeURIComponent(q)}`); const d = await r.json(); const urls = d.map(x=>`https://static.arasaac.org/pictograms/${x._id}/${x._id}_300.png`); urls.forEach(url=>{ const i=document.createElement('img'); i.src=url; i.onclick=()=>aplicarImatge(url); div.appendChild(i); }); if(urls.length > 0) found = true; } catch(e) {} }
            if (!found) { try { const base = GLOBAL_SYMBOLS_CONFIG.baseUrl.replace(/\/$/, ''); const r = await fetch(`${base}/labels/search?query=${encodeURIComponent(q)}&language=${encodeURIComponent(lang)}`); if(r.ok) { const d = await r.json(); const items = extreureResultatsGlobalSymbols(d); items.forEach(item=>{ const imgUrl = extreureImatgeGlobalSymbols(item); if(imgUrl){ const i=document.createElement('img'); i.src=imgUrl; i.onclick=()=>aplicarImatge(imgUrl); div.appendChild(i); } }); } } catch(e) {} }
        }
        function pujarImatge(i) { const r=new FileReader(); r.onload=e=>aplicarImatge(e.target.result); if(i.files[0]) r.readAsDataURL(i.files[0]); }

        async function traduirParaula() {
            const word = document.getElementById('input-modal-0').value; const divRes = document.getElementById('resultats-traductor'); divRes.innerHTML = "<p style='text-align:center'>â³ Traduint...</p>"; let html = ""; const checkboxes = document.querySelectorAll('.check-trad:checked');
            if (checkboxes.length === 0) { divRes.innerHTML = "<p style='text-align:center'>âš ï¸ Selecciona com a mÃ­nim un idioma.</p>"; return; }
            for (const cb of checkboxes) {
                const langCode = cb.value; const langNom = cb.parentNode.innerText.trim();
                try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=ca|${langCode}`); const data = await res.json(); if(data.responseData && data.responseData.translatedText) { if(data.responseData.translatedText.includes('MYMEMORY WARNING')) { html += `<p style='text-align:center;color:#e74c3c;grid-column:1/-1;'>âš ï¸ LÃ­mit diari esgotat. Usa IA.</p>`; break; } html += `<div class="item-traduccio" onclick="copiarText('${data.responseData.translatedText.replace(/'/g,"\\'").replace(/"/g,'&quot;')}')"><div><span class="lang-code">${langNom}</span><span class="trad-text">${data.responseData.translatedText}</span></div><span class="copy-hint">ğŸ“‹</span></div>`; } } catch(e) {} 
            } divRes.innerHTML = html || "Error de connexiÃ³";
        }
        function copiarText(t) { navigator.clipboard.writeText(t); const o = document.getElementById('toast'); o.style.display='block'; setTimeout(()=>o.style.display='none', 2000); }

        function setTool(tool) { currentTool = tool; document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('actiu')); document.getElementById('tool-' + tool).classList.add('actiu'); }
        function setDrawColor(c) { drawColor = c; }
        function undoLastDrawing() { if (currentDrawings.length > 0) { currentDrawings.pop(); drawEditorCanvas(); } }
        function getMousePos(e) { const rect = editorCanvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; }
        function buildPath(ctx, shape) {
            ctx.beginPath();
            if (shape.type === 'freehand') { shape.points.forEach((p, i) => { if(i===0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); }); } 
            else if (shape.type === 'rect') { ctx.rect(shape.start.x, shape.start.y, shape.end.x - shape.start.x, shape.end.y - shape.start.y); } 
            else if (shape.type === 'circle') { let r = Math.sqrt(Math.pow(shape.end.x - shape.start.x, 2) + Math.pow(shape.end.y - shape.start.y, 2)); ctx.arc(shape.start.x, shape.start.y, r, 0, 2 * Math.PI); } 
            else if (shape.type === 'arrow') { let headlen = 15; let dx = shape.end.x - shape.start.x; let dy = shape.end.y - shape.start.y; let angle = Math.atan2(dy, dx); ctx.moveTo(shape.start.x, shape.start.y); ctx.lineTo(shape.end.x, shape.end.y); ctx.lineTo(shape.end.x - headlen * Math.cos(angle - Math.PI / 6), shape.end.y - headlen * Math.sin(angle - Math.PI / 6)); ctx.moveTo(shape.end.x, shape.end.y); ctx.lineTo(shape.end.x - headlen * Math.cos(angle + Math.PI / 6), shape.end.y - headlen * Math.sin(angle + Math.PI / 6)); } 
            else if (shape.type === 'cross') { ctx.moveTo(shape.start.x, shape.start.y); ctx.lineTo(shape.end.x, shape.end.y); ctx.moveTo(shape.end.x, shape.start.y); ctx.lineTo(shape.start.x, shape.end.y); }
        }
        function getHitShapeIndex(x, y) { editorCtx.lineWidth = 15; for (let i = currentDrawings.length - 1; i >= 0; i--) { buildPath(editorCtx, currentDrawings[i]); if (editorCtx.isPointInStroke(x, y)) return i; } return -1; }
        function startDrawingCanvas(e) { const pos = getMousePos(e); let hitIdx = getHitShapeIndex(pos.x, pos.y); if (hitIdx !== -1) { isDraggingShape = true; draggedShapeIndex = hitIdx; lastMouseX = pos.x; lastMouseY = pos.y; } else { isDrawing = true; startX = pos.x; startY = pos.y; currentX = pos.x; currentY = pos.y; if (currentTool === 'freehand') currentDrawings.push({ type: 'freehand', color: drawColor, points: [{x: startX, y: startY}] }); } }
        function drawCanvas(e) {
            const pos = getMousePos(e);
            if (isDraggingShape) { let dx = pos.x - lastMouseX; let dy = pos.y - lastMouseY; let shape = currentDrawings[draggedShapeIndex]; if (shape.type === 'freehand') shape.points.forEach(pt => { pt.x += dx; pt.y += dy; }); else { shape.start.x += dx; shape.start.y += dy; shape.end.x += dx; shape.end.y += dy; } lastMouseX = pos.x; lastMouseY = pos.y; drawEditorCanvas(); } 
            else if (isDrawing) { currentX = pos.x; currentY = pos.y; if (currentTool === 'freehand') currentDrawings[currentDrawings.length-1].points.push({x: currentX, y: currentY}); drawEditorCanvas(); } 
            else { let hitIdx = getHitShapeIndex(pos.x, pos.y); editorCanvas.style.cursor = hitIdx !== -1 ? 'pointer' : 'crosshair'; }
        }
        function stopDrawingCanvas() { if (isDraggingShape) { isDraggingShape = false; draggedShapeIndex = -1; } if (isDrawing) { isDrawing = false; if (currentTool !== 'freehand' && (startX !== currentX || startY !== currentY)) { currentDrawings.push({ type: currentTool, color: drawColor, start: {x: startX, y: startY}, end: {x: currentX, y: currentY} }); } drawEditorCanvas(); } }
        function obrirTabEdicio() {
            canviarPestanya('tab-dibuix'); let currentSrc = ''; document.getElementById('ed-scale').value = 1; document.getElementById('ed-x').value = 0; document.getElementById('ed-y').value = 0; setTool('freehand');
            if (currentView === 'pictotraductor') { currentSrc = elementEditant.querySelector('img') ? elementEditant.querySelector('img').src : ''; } else { const mode = document.getElementById('selector-mode').value; if (mode === 'domino') { currentSrc = elementEditant.querySelector('img').src; } else if (mode === 'memory') { if (elementEditant.classList.contains('nomes-img')) { currentSrc = elementEditant.querySelector('img').src; } else { const index = elementEditant.dataset.index; const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if(imgCard) currentSrc = imgCard.querySelector('img').src; } } else { const img = elementEditant.querySelector('img'); if(img) currentSrc = img.src; } }
            if(currentSrc) { if (currentSrc.indexOf('static.arasaac.org') !== -1 && currentSrc.indexOf('?') === -1 && !currentSrc.endsWith('.mp4')) { currentSrc += '?c=' + new Date().getTime(); } editorImgObj.onload = () => { currentDrawings = []; drawEditorCanvas(); editorImgObj.onload = null; }; editorImgObj.src = currentSrc; if(editorImgObj.complete) editorImgObj.onload(); }
        }
        function drawEditorCanvas() {
            editorCtx.clearRect(0, 0, 300, 300); const scale = parseFloat(document.getElementById('ed-scale').value); const dx = parseFloat(document.getElementById('ed-x').value); const dy = parseFloat(document.getElementById('ed-y').value);
            editorCtx.save(); editorCtx.translate(150 + dx, 150 + dy); editorCtx.scale(scale, scale);
            if (editorImgObj.src && !editorImgObj.src.endsWith('.mp4')) { const aspect = editorImgObj.width / editorImgObj.height; let w = 280, h = 280; if (aspect > 1) h = w / aspect; else w = h * aspect; editorCtx.drawImage(editorImgObj, -w/2, -h/2, w, h); }
            editorCtx.restore(); editorCtx.lineCap = 'round'; editorCtx.lineJoin = 'round'; 
            currentDrawings.forEach(shape => { editorCtx.strokeStyle = shape.color; editorCtx.lineWidth = 4; buildPath(editorCtx, shape); editorCtx.stroke(); });
            if(isDrawing && currentTool !== 'freehand') { editorCtx.strokeStyle = drawColor; editorCtx.lineWidth = 4; let tempShape = { type: currentTool, start: {x: startX, y: startY}, end: {x: currentX, y: currentY} }; buildPath(editorCtx, tempShape); editorCtx.stroke(); }
        }
        function aplicarEdicioImatge(canviarTab = true) { const dataUrl = editorCanvas.toDataURL('image/png'); aplicarImatge(dataUrl); if(canviarTab) canviarPestanya('tab-arasaac'); }
    </script>
<script>
    // Afegim el menÃº hamburguesa i el tÃ­tol net a dalt de tot
    document.body.insertAdjacentHTML('afterbegin', `
        <style>
            .menu-btn { position: fixed; top: 20px; left: 20px; background-color: var(--color-principal); color: white; border: none; border-radius: 8px; padding: 10px 15px; font-size: 24px; cursor: pointer; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
            .menu-btn:hover { background-color: var(--color-principal); }
            .side-menu { height: 100%; width: 0; position: fixed; z-index: 10001; top: 0; left: 0; background-color: #ffffff; overflow-x: hidden; transition: 0.4s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding-top: 70px; display: flex; flex-direction: column; font-family: 'Fredoka', sans-serif;}
            .side-menu a { padding: 15px 25px; text-decoration: none; font-size: 18px; color: #333; display: block; transition: 0.2s; }
            .side-menu a:hover { background-color: #f0f8ff; color: var(--color-principal); }
            .side-menu .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #999; }
            .nova-capsalera { text-align: center; margin-bottom: 10px; padding-top: 20px; }
            .nova-capsalera h1 { font-family: 'Fredoka', sans-serif; color: var(--color-principal); margin: 10px 0 0 0; font-size: 2.5rem;}
            .nova-capsalera p { color: #666; font-family: 'Andika', sans-serif; margin-top: 5px;}
        </style>

        <button class="menu-btn no-print" onclick="document.getElementById('elMeuMenuXat').style.width = '250px'">â˜°</button>

        <div id="elMeuMenuXat" class="side-menu no-print">
            <button class="close-btn" onclick="document.getElementById('elMeuMenuXat').style.width = '0'">Ã—</button>
            <a href="index.html">ğŸ  Inici (PictoSuite)</a>
            <a href="targetes.html">ğŸƒ Targetes</a>
            <a href="pictoxat.html">ğŸ’¬ PictoXat</a>
        </div>

        <div class="nova-capsalera no-print">
            <h1>ğŸ’¬ PictoXat</h1>
            <p>Necessites ajuda i no saps com dir-ho? Tria el teu idioma i ho podrÃ s explicar amb pictogrames!</p>
        </div>
    `);
</script>
</body>
</html>


