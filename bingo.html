<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo ‚Äì PictoSuite</title>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-fons: #fdfbf7;
            --color-principal: #e67e22;
            --color-secundari: #f39c12;
            --color-accio: #27ae60;
            --color-text: #333333;
            --font-titols: 'Fredoka', sans-serif;
            --font-text: 'Andika', sans-serif;
        }

        body {
            font-family: var(--font-text);
            background-color: var(--color-fons);
            background-image: linear-gradient(#e1e1e1 1px, transparent 1px), linear-gradient(90deg, #e1e1e1 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--color-text);
            margin: 0;
            padding: 20px;
        }

        body.dark-mode {
            --color-fons: #1e1e2e;
            --color-text: #cdd6f4;
            background-color: #1e1e2e;
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
        }
        body.dark-mode .configuracio { background-color: #2a2a3e; color: #cdd6f4; }
        body.dark-mode label { color: #a6adc8; }
        body.dark-mode .sidebar-label { color: #a6adc8; }
        body.dark-mode .sidebar-input { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode .side-menu { background-color: #2a2a3e; }
        body.dark-mode .side-menu a { color: #cdd6f4; }
        body.dark-mode .side-menu a:hover { background-color: #1e1e2e; }
        body.dark-mode .side-menu select.sidebar-input { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode input[type="text"], body.dark-mode select, body.dark-mode textarea { background: #1e1e2e; color: #cdd6f4; border-color: #555; }
        body.dark-mode .header-app h1 { color: #ffffff; }
        body.dark-mode .bingo-card { background: #2a2a3e; border-color: #555; }
        body.dark-mode .bingo-cell { background: #1e1e2e; border-color: #555; color: #cdd6f4; }
        body.dark-mode .avis { background: #3a3a4e; border-color: #666; color: #cdd6f4; }

        .menu-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: var(--color-principal);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.3s;
        }

        .side-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1001;
            top: 0;
            left: 0;
            background-color: #ffffff;
            overflow-x: hidden;
            overflow-y: auto;
            transition: 0.4s;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding-top: 70px;
            display: flex;
            flex-direction: column;
            font-family: var(--font-titols);
        }
        .side-menu a { padding: 15px 25px; text-decoration: none; font-size: 18px; color: var(--color-text); display: block; transition: 0.2s; }
        .side-menu a:hover { background-color: #f0f8ff; color: var(--color-principal); }
        .side-menu .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #999; }
        .sidebar-section { padding: 10px 25px; }
        .sidebar-label { display: block; font-size: 0.82em; font-weight: bold; color: #555; margin-bottom: 4px; font-family: var(--font-titols); }
        .sidebar-input { width: 100%; box-sizing: border-box; padding: 7px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85em; }
        .sidebar-btn { margin-top: 5px; background: var(--color-accio); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; width: 100%; font-weight: bold; }
        .toggle-wrap { display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; }
        .toggle-switch { position: relative; display: inline-block; width: 46px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 22px; transition: .3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .toggle-slider { background-color: var(--color-principal); }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        .configuracio {
            background-color: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            max-width: 950px;
            margin: 0 auto 20px;
            border-left: 10px solid var(--color-principal);
        }
        .header-app { display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 25px; margin-bottom: 20px; text-align: center; }
        .header-app h1 { margin: 0; color: #333333; font-family: var(--font-titols); font-size: 2.5rem; letter-spacing: 1px; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: .9em; }
        input[type="text"], select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; font-family: var(--font-text); }

        .fila-flex { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap; }
        .columna { flex: 1; min-width: 120px; }

        .btn-container { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button { border: none; padding: 12px 25px; font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold; color: #fff; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: transform .1s; font-family: var(--font-titols); }
        button:active { transform: scale(.98); }
        .btn-generar { background-color: var(--color-principal); flex: 2; }
        .btn-imprimir { background-color: var(--color-accio); flex: 1; }
        .btn-ia { background-color: #8e44ad; flex: 1; }

        .avis { margin-top: 15px; padding: 10px 15px; background-color: #fef3cd; border-left: 4px solid #f39c12; border-radius: 4px; color: #7d5a00; font-size: .9em; display: none; }
        .avis.error { background-color: #fce4e4; border-left-color: #e74c3c; color: #a00; }
        .avis.ok { background-color: #e8f8f5; border-left-color: #27ae60; color: #166534; }

        /* Bingo cards output */
        #zona-sortida { max-width: 1200px; margin: 0 auto; }
        .bingo-card {
            background: white;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            break-inside: avoid;
            page-break-inside: avoid;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
        }
        .bingo-card-title {
            font-family: var(--font-titols);
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 8px;
            color: var(--color-principal);
        }
        .bingo-grid {
            display: grid;
            gap: 4px;
        }
        .bingo-cell {
            border: 2px solid #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            background: white;
            aspect-ratio: 1;
            overflow: hidden;
            text-align: center;
            font-size: 0.85em;
            font-weight: bold;
            word-break: break-word;
        }
        .bingo-cell img { width: 80%; height: 70%; object-fit: contain; display: block; }
        .bingo-cell .cell-text { font-size: 0.8em; margin-top: 2px; font-weight: bold; }
        .bingo-cell.nomes-text { font-size: 1.1em; }
        .bingo-cell.nomes-text img { display: none; }
        .bingo-cell.nomes-img .cell-text { display: none; }
        .bingo-cell.nomes-img img { width: 90%; height: 90%; }

        .cards-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: flex-start; }
        .bingo-card { width: calc(50% - 10px); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--color-principal); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            @page { margin: 10mm; size: A4 portrait; }
            body { background: #fff; padding: 0; margin: 0; background-image: none; }
            .configuracio, .menu-btn, .side-menu, #modal-contacte, #modal-ia, .no-print { display: none !important; }
            #zona-sortida { max-width: 100%; }
            .bingo-card { break-inside: avoid; page-break-inside: avoid; }
            .cards-container { display: block; }
            .bingo-card { width: 100%; margin-bottom: 15mm; }
        }
    </style>
</head>
<body>
    <button class="menu-btn" onclick="obrirMenu()">‚ò∞</button>

    <div id="elMeuMenu" class="side-menu">
        <button class="close-btn" onclick="tancarMenu()">√ó</button>
        <a href="index.html">üè† Inici (PictoSuite)</a>
        <a href="targetes.html">üÉè Targetes</a>
        <a href="pictoxat.html">üí¨ PictoXat</a>
        <a href="bingo.html">üéØ Bingo</a>
        <hr style="width:80%;border:0;border-top:1px solid #eee;margin:15px auto;">
        <div class="toggle-wrap">
            <span style="font-size:16px;" data-i18n="mode_fosc">üåô Mode Fosc</span>
            <label class="toggle-switch">
                <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode(this)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="sidebar-section">
            <span class="sidebar-label" data-i18n="idioma_ui">üåê Idioma de l'aplicaci√≥</span>
            <select id="ui-lang-select" class="sidebar-input" onchange="canviarIdiomaInterficie(this.value)">
                <option value="ca">Catal√†</option>
                <option value="es">Castell√†</option>
                <option value="en">English</option>
                <option value="fr">Fran√ßais</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="zh">‰∏≠Êñá</option>
                <option value="ur">ÿßÿ±ÿØŸà</option>
            </select>
        </div>
        <div class="sidebar-section">
            <span class="sidebar-label" data-i18n="clau_api">ü§ñ Clau API Google AI Studio:</span>
            <input type="password" id="gemini-api-key" class="sidebar-input" placeholder="AIza...">
            <button class="sidebar-btn" onclick="guardarApiKey(this)" data-i18n="desar_clau">üíæ Desar clau</button>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.8em;color:var(--color-principal);display:block;margin-top:6px;text-align:center;" data-i18n="aconseguir_clau">üëâ Aconseguir clau gratis</a>
        </div>
        <hr style="width:80%;border:0;border-top:1px solid #eee;margin:10px auto;">
        <div class="sidebar-section">
            <button onclick="tancarMenu(); document.getElementById('modal-contacte').style.display='flex';" style="background:#333;color:white;border:none;padding:10px;border-radius:8px;cursor:pointer;width:100%;font-size:0.9em;font-family:var(--font-titols);" data-i18n="suggerencia">‚úâÔ∏è Tens alguna sugger√®ncia?</button>
        </div>
    </div>

    <div id="modal-contacte" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;width:90%;max-width:600px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;color:#2c3e50;font-family:var(--font-titols);">‚úâÔ∏è Tens alguna sugger√®ncia?</h3>
            <p style="color:#666;font-size:0.9em;">Vols crear algun altre mena de joc o consultar dubtes? Estar√© encantat de respondre't!</p>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <div style="display:flex;gap:10px;">
                    <input type="email" id="sugg-email" placeholder="El teu correu electr√≤nic" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:0.9em;">
                    <input type="text" id="sugg-assumpte" placeholder="Assumpte" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:0.9em;">
                </div>
                <textarea id="sugg-missatge" placeholder="Escriu el teu missatge aqu√≠..." style="width:100%;min-height:96px;resize:vertical;box-sizing:border-box;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:0.9em;"></textarea>
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button onclick="enviarSuggeriment()" style="background:#333;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:6px;">‚úâÔ∏è Envia'm un missatge</button>
                    <button onclick="document.getElementById('modal-contacte').style.display='none'" style="background:#999;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;">Tancar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="configuracio">
        <div class="header-app">
            <span style="font-size:4rem;" aria-label="Bingo">üéØ</span>
            <h1>Bingo</h1>
        </div>

        <div class="fila-flex">
            <div class="columna">
                <label data-i18n="mida_cartro">Mida del cartr√≥</label>
                <select id="mida-cartro">
                    <option value="3">3√ó3 (9 cel¬∑les)</option>
                    <option value="4">4√ó4 (16 cel¬∑les)</option>
                    <option value="5" selected>5√ó5 (25 cel¬∑les)</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="num_jugadors">Nombre de cartrons</label>
                <select id="num-jugadors">
                    <option value="1">1 cartr√≥</option>
                    <option value="2">2 cartrons</option>
                    <option value="3">3 cartrons</option>
                    <option value="4" selected>4 cartrons</option>
                    <option value="5">5 cartrons</option>
                    <option value="6">6 cartrons</option>
                    <option value="8">8 cartrons</option>
                    <option value="10">10 cartrons</option>
                    <option value="15">15 cartrons</option>
                    <option value="20">20 cartrons</option>
                    <option value="30">30 cartrons</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="mode_visual">Mode de visualitzaci√≥</label>
                <select id="mode-visual">
                    <option value="imatge+text" selected data-i18n-opt="opt_imatgetext">Imatge + Text</option>
                    <option value="nomes-img" data-i18n-opt="opt_nomesimg">Nom√©s pictogrames</option>
                    <option value="nomes-text" data-i18n-opt="opt_nomestext">Nom√©s text</option>
                </select>
            </div>
            <div class="columna">
                <label data-i18n="mida_paper_bingo">Mida impressi√≥</label>
                <select id="mida-paper">
                    <option value="a4" selected>A4</option>
                    <option value="a3">A3</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom:15px;">
            <label data-i18n="paraules_bingo">Paraules (separades amb comes):</label>
            <textarea id="llista-paraules" placeholder="Ex: gat, gos, ocell, peix, conill, cavall, vaca, ovella, porc..."></textarea>
        </div>

        <div id="avis-paraules" class="avis"></div>

        <div class="btn-container">
            <button class="btn-generar" onclick="generarBingo()" data-i18n="generar_bingo">üéØ Generar Bingo</button>
            <button class="btn-ia" onclick="obrirModalIA()" data-i18n="mode_ia">ü§ñ Mode IA</button>
            <button class="btn-imprimir" onclick="imprimirBingo()" data-i18n="imprimir">üñ®Ô∏è Imprimir</button>
        </div>
    </div>

    <!-- Modal IA -->
    <div id="modal-ia" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center;">
        <div style="background:#fff;border-radius:12px;width:90%;max-width:500px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="margin-top:0;color:#8e44ad;font-family:var(--font-titols);">ü§ñ Mode IA ‚Äì Genera paraules autom√†ticament</h3>
            <p style="color:#666;font-size:0.9em;" data-i18n="ia_descripcio">Escriu una tem√†tica i la IA generar√† una llista de paraules per al Bingo.</p>
            <label style="color:#333;font-weight:bold;" data-i18n="tematica">Tem√†tica:</label>
            <input type="text" id="ia-tematica" placeholder="Ex: animals de granja, fruites, professions..." style="margin-bottom:15px;">
            <label style="color:#333;font-weight:bold;" data-i18n="num_paraules_ia">Nombre de paraules:</label>
            <input type="text" id="ia-num-paraules" value="30" style="margin-bottom:15px;">
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="generarParaulesIA()" style="background:#8e44ad;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;" data-i18n="generar_ia">‚ú® Genera paraules</button>
                <button onclick="document.getElementById('modal-ia').style.display='none'" style="background:#999;color:white;padding:10px 20px;border-radius:30px;border:none;cursor:pointer;font-weight:bold;" data-i18n="tancar">Tancar</button>
            </div>
            <div id="ia-estat" style="margin-top:15px;text-align:center;color:#8e44ad;font-size:0.9em;"></div>
        </div>
    </div>

    <div id="zona-sortida"></div>

    <script>
        const i18nUI = {
            ca: { mode_fosc:"üåô Mode Fosc", idioma_ui:"üåê Idioma de l'aplicaci√≥", clau_api:"ü§ñ Clau API Google AI Studio:", desar_clau:"üíæ Desar clau", aconseguir_clau:"üëâ Aconseguir clau gratis", suggerencia:"‚úâÔ∏è Tens alguna sugger√®ncia?", mida_cartro:"Mida del cartr√≥", num_jugadors:"Nombre de cartrons", mode_visual:"Mode de visualitzaci√≥", mida_paper_bingo:"Mida impressi√≥", paraules_bingo:"Paraules (separades amb comes):", generar_bingo:"üéØ Generar Bingo", mode_ia:"ü§ñ Mode IA", imprimir:"üñ®Ô∏è Imprimir", ia_descripcio:"Escriu una tem√†tica i la IA generar√† una llista de paraules per al Bingo.", tematica:"Tem√†tica:", num_paraules_ia:"Nombre de paraules:", generar_ia:"‚ú® Genera paraules", tancar:"Tancar", opt_imatgetext:"Imatge + Text", opt_nomesimg:"Nom√©s pictogrames", opt_nomestext:"Nom√©s text" },
            es: { mode_fosc:"üåô Modo Oscuro", idioma_ui:"üåê Idioma de la aplicaci√≥n", clau_api:"ü§ñ Clave API Google AI Studio:", desar_clau:"üíæ Guardar clave", aconseguir_clau:"üëâ Obtener clave gratis", suggerencia:"‚úâÔ∏è ¬øAlguna sugerencia?", mida_cartro:"Tama√±o del cart√≥n", num_jugadors:"N√∫mero de cartones", mode_visual:"Modo de visualizaci√≥n", mida_paper_bingo:"Tama√±o impresi√≥n", paraules_bingo:"Palabras (separadas por comas):", generar_bingo:"üéØ Generar Bingo", mode_ia:"ü§ñ Modo IA", imprimir:"üñ®Ô∏è Imprimir", ia_descripcio:"Escribe una tem√°tica y la IA generar√° una lista de palabras para el Bingo.", tematica:"Tem√°tica:", num_paraules_ia:"N√∫mero de palabras:", generar_ia:"‚ú® Generar palabras", tancar:"Cerrar", opt_imatgetext:"Imagen + Texto", opt_nomesimg:"Solo pictogramas", opt_nomestext:"Solo texto" },
            en: { mode_fosc:"üåô Dark Mode", idioma_ui:"üåê Application language", clau_api:"ü§ñ Google AI Studio API Key:", desar_clau:"üíæ Save key", aconseguir_clau:"üëâ Get free key", suggerencia:"‚úâÔ∏è Any suggestion?", mida_cartro:"Card size", num_jugadors:"Number of cards", mode_visual:"Display mode", mida_paper_bingo:"Print size", paraules_bingo:"Words (comma-separated):", generar_bingo:"üéØ Generate Bingo", mode_ia:"ü§ñ AI Mode", imprimir:"üñ®Ô∏è Print", ia_descripcio:"Enter a theme and AI will generate a word list for the Bingo.", tematica:"Theme:", num_paraules_ia:"Number of words:", generar_ia:"‚ú® Generate words", tancar:"Close", opt_imatgetext:"Image + Text", opt_nomesimg:"Pictograms only", opt_nomestext:"Text only" },
            fr: { mode_fosc:"üåô Mode Sombre", idioma_ui:"üåê Langue de l'application", clau_api:"ü§ñ Cl√© API Google AI Studio :", desar_clau:"üíæ Enregistrer", aconseguir_clau:"üëâ Obtenir une cl√©", suggerencia:"‚úâÔ∏è Une suggestion ?", mida_cartro:"Taille du carton", num_jugadors:"Nombre de cartons", mode_visual:"Mode d'affichage", mida_paper_bingo:"Taille d'impression", paraules_bingo:"Mots (s√©par√©s par des virgules) :", generar_bingo:"üéØ G√©n√©rer Bingo", mode_ia:"ü§ñ Mode IA", imprimir:"üñ®Ô∏è Imprimer", ia_descripcio:"Entrez un th√®me et l'IA g√©n√®rera une liste de mots pour le Bingo.", tematica:"Th√®me :", num_paraules_ia:"Nombre de mots :", generar_ia:"‚ú® G√©n√©rer des mots", tancar:"Fermer", opt_imatgetext:"Image + Texte", opt_nomesimg:"Pictogrammes seulement", opt_nomestext:"Texte seulement" },
            ar: { mode_fosc:"üåô ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ∏ŸÑŸÖ", idioma_ui:"üåê ŸÑÿ∫ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ", clau_api:"ü§ñ ŸÖŸÅÿ™ÿßÿ≠ API ÿ¨Ÿàÿ¨ŸÑ:", desar_clau:"üíæ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠", aconseguir_clau:"üëâ ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÅÿ™ÿßÿ≠ ŸÖÿ¨ÿßŸÜŸä", suggerencia:"‚úâÔ∏è ŸáŸÑ ŸÑÿØŸäŸÉ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿü", mida_cartro:"ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©", num_jugadors:"ÿπÿØÿØ ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™", mode_visual:"Ÿàÿ∂ÿπ ÿßŸÑÿπÿ±ÿ∂", mida_paper_bingo:"ÿ≠ÿ¨ŸÖ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©", paraules_bingo:"ŸÉŸÑŸÖÿßÿ™ (ŸÖŸÅÿµŸàŸÑÿ© ÿ®ŸÅŸàÿßÿµŸÑ):", generar_bingo:"üéØ ÿ•ŸÜÿ¥ÿßÿ° ÿ®ŸäŸÜÿ∫Ÿà", mode_ia:"ü§ñ Ÿàÿ∂ÿπ AI", imprimir:"üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ©", ia_descripcio:"ÿßŸÉÿ™ÿ® ŸÖŸàÿ∂ŸàÿπÿßŸã Ÿàÿ≥ÿ™ŸÜÿ¥ÿ¶ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÇÿßÿ¶ŸÖÿ© ŸÉŸÑŸÖÿßÿ™ ŸÑŸÑÿ®ŸäŸÜÿ∫Ÿà.", tematica:"ÿßŸÑŸÖŸàÿ∂Ÿàÿπ:", num_paraules_ia:"ÿπÿØÿØ ÿßŸÑŸÉŸÑŸÖÿßÿ™:", generar_ia:"‚ú® ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸÑŸÖÿßÿ™", tancar:"ÿ•ÿ∫ŸÑÿßŸÇ", opt_imatgetext:"ÿµŸàÿ±ÿ© + ŸÜÿµ", opt_nomesimg:"ÿ±ŸÖŸàÿ≤ ŸÅŸÇÿ∑", opt_nomestext:"ŸÜÿµ ŸÅŸÇÿ∑" },
            zh: { mode_fosc:"üåô ÊöóÈªëÊ®°Âºè", idioma_ui:"üåê Â∫îÁî®ËØ≠Ë®Ä", clau_api:"ü§ñ Ë∞∑Ê≠åAI StudioÂØÜÈí•Ôºö", desar_clau:"üíæ ‰øùÂ≠òÂØÜÈí•", aconseguir_clau:"üëâ Ëé∑ÂèñÂÖçË¥πÂØÜÈí•", suggerencia:"‚úâÔ∏è Êúâ‰ªÄ‰πàÂª∫ËÆÆÔºü", mida_cartro:"Âç°ÁâáÂ§ßÂ∞è", num_jugadors:"Âç°ÁâáÊï∞Èáè", mode_visual:"ÊòæÁ§∫Ê®°Âºè", mida_paper_bingo:"ÊâìÂç∞Â§ßÂ∞è", paraules_bingo:"ËØçËØ≠ÔºàÈÄóÂè∑ÂàÜÈöîÔºâÔºö", generar_bingo:"üéØ ÁîüÊàêÂÆæÊûú", mode_ia:"ü§ñ AIÊ®°Âºè", imprimir:"üñ®Ô∏è ÊâìÂç∞", ia_descripcio:"ËæìÂÖ•‰∏ªÈ¢òÔºåAIÂ∞Ü‰∏∫ÂÆæÊûúÁîüÊàêËØçËØ≠ÂàóË°®„ÄÇ", tematica:"‰∏ªÈ¢òÔºö", num_paraules_ia:"ËØçËØ≠Êï∞ÈáèÔºö", generar_ia:"‚ú® ÁîüÊàêËØçËØ≠", tancar:"ÂÖ≥Èó≠", opt_imatgetext:"ÂõæÁâá+ÊñáÂ≠ó", opt_nomesimg:"‰ªÖÂõæÁ§∫", opt_nomestext:"‰ªÖÊñáÂ≠ó" },
            ur: { mode_fosc:"üåô ⁄àÿßÿ±⁄© ŸÖŸà⁄à", idioma_ui:"üåê ÿß€åŸæ ⁄©€å ÿ≤ÿ®ÿßŸÜ", clau_api:"ü§ñ ⁄ØŸà⁄ØŸÑ AI Studio ⁄©€å ⁄©ŸÑ€åÿØ:", desar_clau:"üíæ ⁄©€å ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫", aconseguir_clau:"üëâ ŸÖŸÅÿ™ ⁄©€å ŸÑ€å⁄∫", suggerencia:"‚úâÔ∏è ⁄©Ÿàÿ¶€å ÿ™ÿ¨Ÿà€åÿ≤ÿü", mida_cartro:"⁄©ÿßÿ±⁄à ⁄©ÿß ÿ≥ÿßÿ¶ÿ≤", num_jugadors:"⁄©ÿßÿ±⁄àÿ≤ ⁄©€å ÿ™ÿπÿØÿßÿØ", mode_visual:"⁄àÿ≥ŸæŸÑ€í ŸÖŸà⁄à", mida_paper_bingo:"Ÿæÿ±ŸÜŸπ ÿ≥ÿßÿ¶ÿ≤", paraules_bingo:"ÿßŸÑŸÅÿßÿ∏ (⁄©ÿßŸÖÿß ÿ≥€í ÿßŸÑ⁄Ø):", generar_bingo:"üéØ ÿ®ŸÜ⁄ØŸà ÿ®ŸÜÿßÿ¶€å⁄∫", mode_ia:"ü§ñ AI ŸÖŸà⁄à", imprimir:"üñ®Ô∏è Ÿæÿ±ŸÜŸπ", ia_descripcio:"ÿß€å⁄© ŸÖŸàÿ∂Ÿàÿπ ŸÑ⁄©⁄æ€å⁄∫ ÿßŸàÿ± AI ÿ®ŸÜ⁄ØŸà ⁄©€í ŸÑ€å€í ÿßŸÑŸÅÿßÿ∏ ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™ ÿ®ŸÜÿßÿ¶€í ⁄Øÿß€î", tematica:"ŸÖŸàÿ∂Ÿàÿπ:", num_paraules_ia:"ÿßŸÑŸÅÿßÿ∏ ⁄©€å ÿ™ÿπÿØÿßÿØ:", generar_ia:"‚ú® ÿßŸÑŸÅÿßÿ∏ ÿ®ŸÜÿßÿ¶€å⁄∫", tancar:"ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫", opt_imatgetext:"ÿ™ÿµŸà€åÿ± + ŸÖÿ™ŸÜ", opt_nomesimg:"ÿµÿ±ŸÅ ÿ™ÿµŸà€åÿ±€å⁄∫", opt_nomestext:"ÿµÿ±ŸÅ ŸÖÿ™ŸÜ" }
        };

        function canviarIdiomaInterficie(lang) {
            localStorage.setItem('ui_lang', lang);
            const t = i18nUI[lang] || i18nUI['ca'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (t[key] !== undefined) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-opt]').forEach(el => {
                const key = el.dataset.i18nOpt;
                if (t[key] !== undefined) el.textContent = t[key];
            });
            const sel = document.getElementById('ui-lang-select');
            if (sel && sel.value !== lang) sel.value = lang;
        }

        function obrirMenu() { document.getElementById("elMeuMenu").style.width = "280px"; }
        function tancarMenu() { document.getElementById("elMeuMenu").style.width = "0"; }

        function toggleDarkMode(el) {
            document.body.classList.toggle('dark-mode', el.checked);
            localStorage.setItem('dark_mode', el.checked ? '1' : '0');
        }

        function guardarApiKey(btn) {
            const key = document.getElementById('gemini-api-key').value.trim();
            localStorage.setItem('gemini_api_key', key);
            const orig = btn.textContent;
            btn.textContent = '‚úÖ Desada!';
            setTimeout(() => btn.textContent = orig, 2000);
        }

        function enviarSuggeriment() {
            const email = document.getElementById('sugg-email').value;
            const subject = document.getElementById('sugg-assumpte').value;
            const msg = document.getElementById('sugg-missatge').value;
            window.location.href = `mailto:rrobles4@xtec.cat?subject=${encodeURIComponent("Sugger√®ncia per a PictoSuite: "+subject)}&body=${encodeURIComponent("Correu: "+email+"\n\n"+msg)}`;
        }

        // Fisher-Yates shuffle
        function barrejar(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function generarBingo() {
            const mida = parseInt(document.getElementById('mida-cartro').value);
            const numJugadors = parseInt(document.getElementById('num-jugadors').value);
            const modeVisual = document.getElementById('mode-visual').value;
            const textParaules = document.getElementById('llista-paraules').value;
            const avis = document.getElementById('avis-paraules');

            const llista = textParaules.split(',').map(p => p.trim()).filter(p => p !== '');
            const cellsPerCard = mida * mida;

            // Math: minimum words needed = cells_per_card + num_players (so each card can be different)
            const minParaules = cellsPerCard + numJugadors;

            avis.style.display = 'none';
            avis.className = 'avis';

            if (llista.length === 0) {
                avis.textContent = '‚ö†Ô∏è Afegeix paraules a la llista per generar els cartrons.';
                avis.className = 'avis error';
                avis.style.display = 'block';
                return;
            }

            if (llista.length < cellsPerCard) {
                avis.textContent = `‚ö†Ô∏è Necessites almenys ${cellsPerCard} paraules per omplir un cartr√≥ de ${mida}√ó${mida}. Tens ${llista.length} paraules.`;
                avis.className = 'avis error';
                avis.style.display = 'block';
                return;
            }

            if (llista.length < minParaules) {
                avis.textContent = `‚ö†Ô∏è Amb ${numJugadors} cartrons de ${mida}√ó${mida}, es recomanen almenys ${minParaules} paraules per evitar cartrons id√®ntics. Tens ${llista.length}. Es generaran igualment per√≤ alguns cartrons podrien ser similars.`;
                avis.className = 'avis';
                avis.style.display = 'block';
            }

            const zona = document.getElementById('zona-sortida');
            zona.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'cards-container';

            // Generate cards
            const cardsGenerated = [];
            for (let c = 0; c < numJugadors; c++) {
                const shuffled = barrejar(llista);
                const selected = shuffled.slice(0, cellsPerCard);
                cardsGenerated.push(selected);
            }

            cardsGenerated.forEach((words, idx) => {
                const card = document.createElement('div');
                card.className = 'bingo-card';

                const title = document.createElement('div');
                title.className = 'bingo-card-title';
                title.textContent = `üéØ Cartr√≥ ${idx + 1}`;
                card.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'bingo-grid';
                grid.style.gridTemplateColumns = `repeat(${mida}, 1fr)`;

                words.forEach(word => {
                    const cell = document.createElement('div');
                    cell.className = 'bingo-cell';
                    if (modeVisual === 'nomes-text') cell.classList.add('nomes-text');
                    if (modeVisual === 'nomes-img') cell.classList.add('nomes-img');

                    const img = document.createElement('img');
                    img.alt = word;
                    img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png';
                    img.style.opacity = '0.1';
                    // Load pictogram from ARASAAC
                    const encodedWord = encodeURIComponent(word);
                    const arasaacLang = localStorage.getItem('ui_lang') || 'ca';
                    fetch(`https://api.arasaac.org/v1/pictograms/${arasaacLang}/search/${encodedWord}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                img.src = `https://static.arasaac.org/pictograms/${data[0]._id}/${data[0]._id}_300.png`;
                                img.style.opacity = '1';
                            }
                        })
                        .catch(() => {});

                    const text = document.createElement('span');
                    text.className = 'cell-text';
                    text.textContent = word;

                    cell.appendChild(img);
                    cell.appendChild(text);
                    grid.appendChild(cell);
                });

                card.appendChild(grid);
                container.appendChild(card);
            });

            zona.appendChild(container);

            if (llista.length >= cellsPerCard && llista.length >= minParaules) {
                avis.textContent = `‚úÖ ${numJugadors} cartrons de ${mida}√ó${mida} generats correctament amb ${llista.length} paraules.`;
                avis.className = 'avis ok';
                avis.style.display = 'block';
            }
        }

        function imprimirBingo() {
            const mida = document.getElementById('mida-paper').value;
            let styleEl = document.getElementById('print-page-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'print-page-style';
                document.head.appendChild(styleEl);
            }
            if (mida === 'a3') {
                styleEl.textContent = '@media print { @page { size: A3 portrait; margin: 10mm; } }';
            } else {
                styleEl.textContent = '@media print { @page { size: A4 portrait; margin: 10mm; } }';
            }
            window.print();
        }

        function obrirModalIA() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert('‚ö†Ô∏è Necessites una clau API de Google AI Studio per usar el Mode IA. Afegeix-la al men√∫ lateral.');
                return;
            }
            document.getElementById('modal-ia').style.display = 'flex';
        }

        async function generarParaulesIA() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) { alert('Clau API no trobada.'); return; }

            const tematica = document.getElementById('ia-tematica').value.trim();
            const numParaules = parseInt(document.getElementById('ia-num-paraules').value) || 30;
            const estat = document.getElementById('ia-estat');

            if (!tematica) { estat.textContent = '‚ö†Ô∏è Escriu una tem√†tica.'; return; }

            estat.innerHTML = '<span class="loader"></span> Generant paraules...';
            const btn = document.querySelector('#modal-ia button');

            const prompt = `Generate a list of exactly ${numParaules} words or short expressions (maximum 3 words each) about the theme: "${tematica}". The words must be suitable for primary school or special education students. Respond ONLY with the words separated by commas, in the same language as the theme provided, without numbering or any additional explanation.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 500 }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'Error API');
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const paraules = text.split(',').map(p => p.trim().replace(/\n/g, ' ')).filter(p => p.length > 0);

                document.getElementById('llista-paraules').value = paraules.join(', ');
                estat.textContent = `‚úÖ ${paraules.length} paraules generades!`;
                setTimeout(() => {
                    document.getElementById('modal-ia').style.display = 'none';
                    estat.textContent = '';
                }, 1500);
            } catch (e) {
                estat.textContent = `‚ùå Error: ${e.message}`;
            }
        }

        window.addEventListener('load', function() {
            if (localStorage.getItem('dark_mode') === '1') {
                document.body.classList.add('dark-mode');
                const t = document.getElementById('dark-mode-toggle');
                if (t) t.checked = true;
            }
            const key = localStorage.getItem('gemini_api_key');
            if (key) {
                const inp = document.getElementById('gemini-api-key');
                if (inp) inp.value = key;
            }
            const lang = localStorage.getItem('ui_lang') || 'ca';
            canviarIdiomaInterficie(lang);
        });
    </script>
</body>
</html>
