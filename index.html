<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoJocs - Generador de Recursos</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Dancing+Script:wght@400;700&family=Fredoka:wght@400;600&family=Indie+Flower&family=Patrick+Hand&family=Roboto&family=Comic+Neue:wght@400;700&family=Schoolbell&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILS GENERALS --- */
        :root {
            --color-fons: #f0f8ff;
            --color-principal: #4a90e2;
            --color-secundari: #f39c12; 
            --color-accio: #27ae60;
            --mida-font-base: 18px; 
            --tipus-font: 'Arial', sans-serif;
            --color-font: #000000;
            --num-columnes: 3;
            --width-paper: 210mm;
            --height-paper: 297mm;
            
            /* Variables de color per la targeta */
            --targeta-bg: #ffffff;
            --targeta-border: #000000;
            --targeta-text: #000000;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
            /* Fons quadriculat recuperat */
            background-color: #fdfbf7;
            background-image: 
                linear-gradient(#e1e1e1 1px, transparent 1px),
                linear-gradient(90deg, #e1e1e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- CONFIGURACI√ì (NO PRINT) --- */
        .configuracio {
            background-color: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 950px;
            margin: 0 auto 20px auto; border-left: 10px solid var(--color-principal);
            position: relative;
        }

        /* Projecte Controls */
        .projecte-controls {
            display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 10px;
        }
        .btn-mini {
            background: #ecf0f1; border: 1px solid #bdc3c7; padding: 8px 12px; border-radius: 8px; 
            cursor: pointer; font-size: 0.9em; font-weight: bold; color: #333; 
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-mini:hover { background: #d5dbdb; }

        /* Header amb Logo APP */
        .header-app {
            display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px;
        }
        .header-app h1 { margin: 0; color: #2c3e50; font-size: 2.2em; letter-spacing: 1px; }
        .logo-pictojocs { height: 70px; width: auto; }

        .fila-flex { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; }
        .columna { flex: 1; }

        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        
        input[type="text"], input[type="email"], select, textarea {
            width: 100%; padding: 10px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 16px; box-sizing: border-box;
        }

        .input-logo-wrapper {
            border: 2px dashed #ccc; padding: 8px; border-radius: 8px; 
            text-align: center; cursor: pointer; transition: all 0.3s;
            background: #fafafa; font-size: 0.9em; color: #777; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .input-logo-wrapper:hover { border-color: var(--color-principal); color: var(--color-principal); }
        .input-logo-wrapper.feteservir {
            border-style: solid; border-color: var(--color-accio); 
            background-color: #e8f8f5; color: var(--color-accio); font-weight: bold;
        }

        /* --- DISSENY COMPACTE D'ESTILS I COLORS --- */
        .barra-estils {
            background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid #d1d9e6; 
            display: flex; gap: 15px; align-items: stretch; justify-content: space-between; flex-wrap: wrap;
        }
        .control-estil { display: flex; flex-direction: column; min-width: 90px; }
        
        /* Contenidor de colors */
        .colors-container {
            flex: 1.2; border-left: 2px solid #d1d9e6; padding-left: 15px;
            display: flex; flex-direction: column;
        }
        .colors-title {
            text-align: center; font-size: 0.85em; font-weight: bold; color: #555;
            border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 8px;
        }
        .color-inputs-wrapper {
            display: flex; gap: 12px; align-items: center; justify-content: space-around;
        }
        .color-item {
            display: flex; flex-direction: column; align-items: center; gap: 3px;
        }
        .color-item input[type="color"] {
            width: 35px; height: 35px; padding: 0; border: none; background: none;
            border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-item label { font-size: 0.75em; margin: 0; color: #666; font-weight: normal;}

        /* --- MODE D'IMPRESSI√ì I PARAULES --- */
        .layout-metode-paraules {
            display: flex; gap: 20px; margin-bottom: 15px; align-items: stretch;
        }
        .panell-metode {
            flex: 0.35; background: #fffcf5; padding: 15px; border-radius: 12px;
            border: 2px solid var(--color-secundari); display: flex; flex-direction: column; justify-content: center;
        }
        .panell-metode label {
            color: var(--color-secundari); font-size: 1.05em; margin-bottom: 10px;
        }
        .panell-metode select {
            font-size: 1.1em; border-color: var(--color-secundari); border-width: 2px; cursor: pointer; font-weight: bold; color: #333;
        }
        .panell-paraules {
            flex: 0.65; display: flex; flex-direction: column;
        }
        .panell-paraules textarea {
            flex-grow: 1; min-height: 80px; resize: vertical;
        }
        
        .btn-container { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;}
        button {
            border: none; padding: 12px 25px; font-size: 16px; border-radius: 50px;
            cursor: pointer; font-weight: bold; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-generar { background-color: var(--color-principal); flex: 2; }
        .btn-imprimir { background-color: var(--color-accio); flex: 1; }
        
        .btn-domino { 
            background-color: var(--color-secundari); 
            flex: 2; display: none; animation: popIn 0.3s ease;
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .instruccions {
            background-color: #e8f6f3; border: 1px solid #a2d9ce; color: #16a085;
            padding: 8px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; text-align: center;
        }

        .avis-impressio {
            margin-top: 15px; padding: 10px 15px; background-color: #f8f9fa;
            border-left: 4px solid #6c757d; border-radius: 4px; color: #444; font-size: 0.85em; line-height: 1.4;
        }
        .avis-impressio strong { color: #2c3e50; font-size: 1em; display:block; margin-bottom: 5px;}
        .avis-impressio ul { margin: 0; padding-left: 20px; }
        .avis-impressio li { margin-bottom: 2px; }
        .info-doble-cara { display: none; color: inherit; font-weight: normal; }

        /* --- ZONA D'IMPRESSI√ì --- */
        #zona-impressio {
            background-color: white; padding: 15mm; width: var(--width-paper);
            min-height: var(--height-paper); margin: 0 auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            box-sizing: border-box; transition: width 0.3s, min-height 0.3s;
        }

        .header-print {
            display: grid; grid-template-columns: 120px 1fr 120px; align-items: center;
            margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; height: 70px; overflow: hidden;
        }
        .logo-escola { height: 100%; width: auto; max-height: 60px; object-fit: contain; display: none; }
        .titol-print-container { text-align: center; }
        .titol-print-container h2 { margin: 0; font-size: 1.8em; color: #222; }
        
        .curs-print-wrapper { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
        
        /* LOGO IMPRESSI√ì M√âS GRAN */
        .big-logo-print { height: 90px; width: auto; opacity: 1; }
        .curs-print { font-size: 1.2em; font-weight: bold; color: #555; text-align: right; margin-top: 5px;}

        .graella { display: grid; grid-template-columns: repeat(var(--num-columnes), 1fr); gap: 15px; width: 100%; }

        .zona-revers { display: none; margin-top: 50px; border-top: 2px dashed #ccc; padding-top: 20px; }

        /* --- DISSENY DE LA TARGETA BASE --- */
        .pictograma {
            border: 4px solid var(--targeta-border);
            border-radius: 15px; 
            background-color: var(--targeta-bg);
            display: flex; flex-direction: column;
            align-items: center; justify-content: space-between; 
            aspect-ratio: 0.85; 
            padding: 12px; 
            cursor: grab; 
            break-inside: avoid; page-break-inside: avoid;
            box-sizing: border-box;
            position: relative;
            overflow: hidden; 
        }
        
        .pictograma:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .pictograma.dragging { opacity: 0.4; border: 3px dashed #999; background: #eee; }

        .imatge-box {
            background-color: #ffffff; 
            border-radius: 10px; 
            width: 100%; height: 70%; 
            display: flex; align-items: center; justify-content: center;
            padding: 5px; box-sizing: border-box;
            overflow: hidden;
        }

        .imatge-box img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        .pictograma p {
            margin: 0; width: 100%; text-align: center;
            font-size: var(--mida-font-base);
            font-family: var(--tipus-font); 
            color: var(--targeta-text);
            line-height: 1.2;
            font-weight: bold;
            height: 28%; margin-top: 2%;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }

        .mode-targeta-front .pictograma .imatge-box { height: 100%; }
        .mode-targeta-front .pictograma p { display: none; }
        
        .mode-memory-front .pictograma.nomes-img .imatge-box { height: 100%; }
        .mode-memory-front .pictograma.nomes-img p { display: none; }
        .mode-memory-front .pictograma.nomes-text .imatge-box { display: none; }
        .mode-memory-front .pictograma.nomes-text p { height: 100%; font-size: 1.5em; margin-top: 0; }

        .contingut-back {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 5px; box-sizing: border-box; overflow: hidden;
            color: var(--targeta-text);
        }

        .contingut-back-logo {
            background-color: #ffffff; border-radius: 10px;
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            padding: 5px; box-sizing: border-box;
        }
        .contingut-back-logo img { width: 90%; height: 90%; object-fit: contain; }

        .mode-domino .graella { grid-template-columns: repeat(2, 1fr) !important; }
        .mode-domino .pictograma { flex-direction: row; aspect-ratio: 2.5 / 1; padding: 8px; gap: 0; }
        .mode-domino .imatge-box { width: 48%; height: 100%; order: 1; margin: 0; padding: 5px; }
        .separador-domino {
            display: none; width: 3px; height: 100%;
            background-color: var(--targeta-border);
            margin: 0 10px; flex-shrink: 0; order: 2;
        }
        .mode-domino .separador-domino { display: block; }
        .mode-domino .text-domino {
            order: 3; width: 48%; height: 100%;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            text-align: center; font-family: var(--tipus-font);
            font-weight: bold; color: var(--targeta-text); overflow: hidden;
        }
        .mode-domino .pictograma p { display: none; } 
        .fila-paraula { text-align: center; width: 100%; font-family: var(--tipus-font); font-weight: bold; color: inherit; line-height: 1.1; margin: 2px 0; }

        /* SUGGERIMENTS RECUPERATS */
        .seccio-suggeriments {
            margin: 40px auto 20px auto; max-width: 600px; text-align: center;
            background-color: #fff; padding: 25px; border-radius: 15px;
            border: 2px dashed #4a90e2; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .seccio-suggeriments h3 { margin-top: 0; color: #2c3e50; }
        .seccio-suggeriments p { color: #666; margin-bottom: 15px; }

        /* FOOTER / CR√àDITS RECUPERATS */
        .footer-credits {
            text-align: center; margin-top: 20px; padding: 15px; font-size: 0.85em; 
            color: #444; background-color: rgba(255,255,255,0.8); border-radius: 10px;
            max-width: 600px; margin-left: auto; margin-right: auto;
        }

        /* MODAL */
        #modal-edicio { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-contingut { background: white; border-radius: 12px; width: 90%; max-width: 650px; display: flex; flex-direction: column; max-height: 90vh; overflow: hidden; }
        .modal-tabs { display: flex; background: #f1f1f1; border-bottom: 2px solid #ddd; overflow-x: auto; flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 10px 4px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; display: flex; align-items: center; justify-content: center; white-space: nowrap; gap: 5px; min-width: auto; }
        .tab-btn.actiu { border-bottom: 3px solid var(--color-principal); color: var(--color-principal); background: white; font-weight: bold; }
        .modal-body { padding: 25px; overflow-y: auto; }
        .grup-titol-modal { margin-bottom: 20px; text-align: center; }
        .inputs-container-modal { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; justify-content: center; }
        
        .input-text-modal { font-size: 1.1em; text-align: center; border: 2px solid #ddd; padding: 8px; border-radius: 6px; box-sizing: border-box; }
        
        /* FIx de columnes: SEMPRE DOS PER FILA en Targeta i Memory */
        .dues-paraules .input-text-modal { width: 48%; }
        .cinc-paraules .input-text-modal { width: 48%; margin-bottom: 5px; }
        
        .cerca-wrapper { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-cerca-modal { background: var(--color-principal); border-radius: 8px; padding: 10px 20px; font-size: 1em; flex-shrink: 0; color: white; border: none; cursor: pointer; }
        .btn-cerca-wiki { background: var(--color-secundari); }
        .btn-cerca-open { background: #333; }
        .btn-cerca-trad { background: #8e44ad; }
        .resultats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .resultats-grid img { width: 100%; height: 90px; object-fit: contain; border: 1px solid #eee; border-radius: 8px; cursor: pointer; padding: 5px; }
        .resultats-grid img:hover { transform: scale(1.05); border-color: var(--color-principal); background: #f0f8ff; }

        .grid-traduccions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .item-traduccio { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .item-traduccio:hover { background: #e8f6f3; border-color: #27ae60; }
        .lang-code { font-weight: bold; color: #555; background: #ddd; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 10px;}
        .trad-text { font-size: 1.1em; color: #333; }
        .copy-hint { font-size: 0.8em; color: #27ae60; opacity: 0; transition: 0.2s;}
        .item-traduccio:hover .copy-hint { opacity: 1; }

        /* Eines de Dibuix (En l√≠nia i compactes) */
        .toolbar-dibuix {
            display: flex; gap: 8px; margin-bottom: 5px; align-items: center; flex-wrap: wrap; justify-content: center;
        }
        @media (min-width: 600px) {
            .toolbar-dibuix { flex-wrap: nowrap; }
        }

        .btn-color-dibuix { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer; flex-shrink: 0;}
        .btn-color-dibuix:hover { transform: scale(1.1); }
        .btn-tool { background: #fff; border: 1px solid #ccc; font-size: 1.2em; border-radius: 5px; padding: 5px 10px; cursor: pointer; transition: 0.2s; flex-shrink: 0;}
        .btn-tool:hover { background: #f0f8ff; border-color: var(--color-principal); }
        .btn-tool.actiu { background: #e8f8f5; border: 2px solid var(--color-accio); box-shadow: 0 0 5px rgba(39,174,96,0.3); }

        /* --- IMPRESSI√ì NETA --- */
        @media print {
            @page { margin: 0 !important; }
            body { background: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; background-image: none; }
            .configuracio, .no-print, #modal-edicio, .avis-impressio { display: none !important; }
            #zona-impressio { margin: 0 auto; box-shadow: none; padding: 10mm; }
            .graella { gap: 5px; }
            .pictograma { border: 2px solid var(--targeta-border); } 
            .zona-revers { padding-top: 15mm !important; margin-top: 0 !important; border: none !important; page-break-before: always; direction: rtl; }
            .mode-domino .pictograma { border: 3px solid var(--targeta-border); }
            .separador-domino { -webkit-print-color-adjust: exact; background-color: var(--targeta-border) !important; }
            
            /* S'assegura que el logo s'imprimeix gran */
            .header-print { height: auto; padding-bottom: 5px; }
            .big-logo-print { height: 90px; }
        }

        @media screen and (max-width: 850px) {
            .configuracio { width: auto; margin: 10px; padding: 15px; }
            .fila-flex { flex-direction: column; align-items: stretch; gap: 10px; }
            .columna, .control-estil { width: 100%; flex: auto !important; }
            .barra-estils { flex-direction: column; align-items: stretch; }
            .colors-container { border-left: none; padding-left: 0; margin-top: 10px; border-top: 2px solid #ddd; padding-top: 15px; }
            .layout-metode-paraules { flex-direction: column; }
            #zona-impressio { width: 100% !important; padding: 10px; box-sizing: border-box; height: auto; min-height: 50vh; }
            body { padding: 0; background-color: #f0f8ff; }
            .btn-container { flex-direction: column; }
            button { padding: 15px; width: 100%; font-size: 1.1em; }
            .modal-contingut { width: 95%; height: 90vh; max-height: 90vh; }
        }
    </style>
</head>
<body>

    <script>
        // --- CONFIGURACI√ì DEL LOGO DE PICTOJOCS ---
        const RUTA_LOGO_PICTOJOCS = "https://github.com/rrobles4/pictojocs/blob/main/logo%20PictoJocs.png?raw=true";
    </script>

    <div class="configuracio no-print">
        
        <div class="projecte-controls">
            <button class="btn-mini" onclick="desarProjecte()">üíæ Desar Projecte</button>
            <button class="btn-mini" onclick="document.getElementById('input-carregar').click()">üìÇ Carregar Projecte</button>
            <input type="file" id="input-carregar" accept=".json" style="display:none" onchange="carregarProjecte(event)">
        </div>

        <div class="header-app">
            <img id="app-logo-header" class="logo-pictojocs" src="" alt="PictoJocs Logo">
            <h1>PictoJocs</h1>
        </div>
        
        <div class="fila-flex">
            <div class="columna" style="flex: 0.6;">
                <label>Logo Escola:</label>
                <div id="wrapper-logo" class="input-logo-wrapper" onclick="document.getElementById('input-logo').click()">
                    üìÅ Logo de l'escola
                </div>
                <input type="file" id="input-logo" accept="image/*" style="display:none" onchange="carregarLogoEscola(this)">
            </div>
            <div class="columna" style="flex: 1.5;">
                <label>T√≠tol:</label>
                <input type="text" id="titol-doc" placeholder="Ex: El cicle de l'aigua">
            </div>
            <div class="columna">
                <label>Curs:</label>
                <input type="text" id="curs" placeholder="Ex: PRI3">
            </div>
            <div class="columna" style="flex: 0.8;">
                <label>Idioma:</label>
                <select id="idioma">
                    <option value="ca">Catal√†</option>
                    <option value="es">Castellano</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="ar">ÿπÿ±ÿ®Ÿä (√Ärab)</option>
                    <option value="zh">‰∏≠Êñá (Xin√®s)</option>
                    <option value="ur">Urdu</option>
                </select>
            </div>
        </div>

        <div class="barra-estils">
            <div class="control-estil" style="flex:1;">
                <label>Mida Paper</label>
                <select id="mida-paper" onchange="actualitzarEstils()">
                    <option value="a4">A4</option>
                    <option value="a3">A3</option>
                </select>
            </div>
            <div class="control-estil" style="flex:1;">
                <label>Columnes</label>
                <select id="selector-columnes" onchange="actualitzarEstils()">
                    <option value="1">1 (Gegant)</option>
                    <option value="2">2 (Molt Gran)</option>
                    <option value="3" selected>3 (Gran)</option>
                    <option value="4">4 (Mitjana)</option>
                    <option value="5">5 (Petita)</option>
                </select>
            </div>
            <div class="control-estil" style="flex:1;">
                <label>Font</label>
                <select id="selector-font" onchange="actualitzarEstils()">
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Fredoka', sans-serif">Fredoka</option>
                    <option value="'Comic Neue', cursive">Comic</option>
                    <option value="'Schoolbell', cursive">Guix</option>
                    <option value="'Open Sans', sans-serif">Neta (Open)</option>
                    <option value="'Patrick Hand', cursive">Manual</option>
                    <option value="'Dancing Script', cursive">Lligada</option>
                    <option value="'Andika', sans-serif">Lectoescriptura</option>
                </select>
            </div>
            
            <div class="colors-container">
                <div class="colors-title">Colors de les targetes</div>
                <div class="color-inputs-wrapper">
                    <div class="color-item">
                        <input type="color" id="color-bg" value="#ffffff" onchange="actualitzarEstils()" title="Fons de la Targeta">
                        <label>Fons</label>
                    </div>
                    <div class="color-item">
                        <input type="color" id="color-border" value="#000000" onchange="actualitzarEstils()" title="Marge de la Targeta">
                        <label>Marge</label>
                    </div>
                    <div class="color-item">
                        <input type="color" id="color-text" value="#000000" onchange="actualitzarEstils()" title="Color de la Lletra">
                        <label>Lletra</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="layout-metode-paraules">
            <div class="panell-metode">
                <label>‚≠ê Mode d'impressi√≥</label>
                <select id="selector-mode" onchange="canviarMode()">
                    <option value="standard">Imatge + Text</option>
                    <option value="targeta">Targeta (Doble Cara)</option>
                    <option value="memory">Memory</option>
                    <option value="domino">Domin√≥</option>
                </select>
            </div>
            
            <div class="panell-paraules">
                <label>Llista de paraules (separades amb comes):</label>
                <textarea id="llista-paraules" placeholder="Ex: aigua, torrent, n√∫vol..."></textarea>
            </div>
        </div>

        <div class="btn-container">
            <button class="btn-generar" onclick="generarDocument()">‚ö° Generar</button>
            <button class="btn-domino" id="btn-mix" onclick="barrejarDomino()">Barrejar fitxes</button>
            <button class="btn-imprimir" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        </div>

        <div class="instruccions" id="text-instruccions">
            Consell: Arrossega per reordenar. Fes clic als dibuixos o noms per editar.
        </div>
        
        <div class="avis-impressio" id="avis-impressio">
            <strong>‚ö†Ô∏è Informaci√≥ per imprimir:</strong>
            <ul>
                <li>Desmarca <b>"Cap√ßalera i peu de p√†gina"</b>.</li>
                <li id="avis-doble-cara" class="info-doble-cara">Selecciona <b>"Imprimir a doble cara"</b> (girar per la vora llarga).</li>
            </ul>
        </div>
    </div>

    <div id="zona-impressio">
        <div class="header-print">
            <div style="display:flex; justify-content:flex-start;">
                <img id="logo-visual" class="logo-escola" src="" alt="Logo Escola">
            </div>
            <div class="titol-print-container">
                <h2 id="titol-resultat">T√≠tol del document</h2>
            </div>
            <div class="curs-print-wrapper">
                <img id="print-mini-logo" class="big-logo-print" src="" alt="PJ">
                <span id="curs-resultat" class="curs-print"></span>
            </div>
        </div>
        <div class="graella" id="contenidor-picts"></div>

        <div id="contenidor-revers-wrapper" class="zona-revers">
            <div class="header-print" style="direction: ltr;">
                <div style="display:flex; justify-content:flex-start;">
                    <img id="logo-visual-back" class="logo-escola" src="" alt="Logo Escola">
                </div>
                <div class="titol-print-container">
                    <h2 id="titol-resultat-back">T√≠tol del document</h2>
                </div>
                <div class="curs-print-wrapper">
                    <img id="print-mini-logo-back" class="big-logo-print" src="" alt="PJ">
                    <span id="curs-resultat-back" class="curs-print"></span>
                </div>
            </div>
            <div class="graella" id="contenidor-revers"></div>
        </div>
    </div>

    <div class="seccio-suggeriments no-print">
        <h3>Tens alguna sugger√®ncia?</h3>
        <p>Vols crear algun altre mena de joc o consultar dubtes? Estar√© encantat de respondre't!</p>
        <div style="display:flex; flex-direction:column; gap:10px; max-width:400px; margin:0 auto;">
            <input type="email" id="sugg-email" placeholder="El teu correu electr√≤nic">
            <input type="text" id="sugg-assumpte" placeholder="Assumpte">
            <textarea id="sugg-missatge" placeholder="Escriu el teu missatge aqu√≠..." style="min-height:80px; resize:vertical;"></textarea>
            <button onclick="enviarSuggeriment()" class="btn-contacte" style="justify-content:center;">‚úâÔ∏è Envia'm un missatge</button>
        </div>
    </div>

    <div class="footer-credits no-print">
        <p style="margin: 0; font-weight: bold; color: #333;">
            ¬© <span id="any-actual"></span> PictoJocs - Creat per Rafa Robles Fontanet.
        </p>
        <p style="margin: 2px 0; font-size: 0.9em;">
            Tots els drets reservats. Prohibida la c√≤pia o modificaci√≥ d'aquest software sense perm√≠s.
        </p>
        <hr style="margin: 10px auto; width: 50%; opacity: 0.3;">
        <p style="margin: 5px 0; font-size: 0.8em; color: #666;">
            Els s√≠mbols pictogr√†fics utilitzats s√≥n propietat del Govern d'Arag√≥ i han estat creats per Sergio Palao per a 
            <a href="http://www.arasaac.org" target="_blank" style="color: #4a90e2; text-decoration: none;">ARASAAC</a> 
            (http://www.arasaac.org), que els distribueix sota llic√®ncia 
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" style="color: #4a90e2;">CC (BY-NC-SA)</a>.
        </p>
    </div>

    <div id="modal-edicio">
        <div class="modal-contingut">
            <div class="modal-tabs">
                <button class="tab-btn actiu" onclick="canviarPestanya('tab-arasaac')">üß© ARASAAC</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-traductor')">üåç Traductor</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-wiki')">üì∑ Wiki</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-simbols')">‚úíÔ∏è S√≠mbols</button>
                <button class="tab-btn" onclick="canviarPestanya('tab-pujar')">üì§ Pujar/IA</button>
                <button class="tab-btn" onclick="obrirTabEdicio()">üé® Editar</button>
            </div>
            <div class="modal-body">
                <div class="grup-titol-modal">
                    <label style="margin-bottom:10px;">Editar Text:</label>
                    <div id="camps-text" class="inputs-container-modal"></div>
                </div>
                <div id="tab-arasaac" class="contingut-tab">
                    <div class="cerca-wrapper"><input id="input-arasaac" onkeyup="if(event.key==='Enter') buscarArasaacModal()"><button class="btn-cerca-modal" onclick="buscarArasaacModal()">üîç Cerca</button></div>
                    <div id="resultats-arasaac" class="resultats-grid"></div>
                </div>
                <div id="tab-traductor" class="contingut-tab" style="display:none;">
                    <div class="cerca-wrapper"><button class="btn-cerca-modal btn-cerca-trad" onclick="traduirParaula()" style="width:100%">üåç Traduir</button></div>
                    <div id="resultats-traductor" class="grid-traduccions"></div>
                </div>
                <div id="tab-wiki" class="contingut-tab" style="display:none;">
                    <div class="cerca-wrapper"><input id="input-wiki" onkeyup="if(event.key==='Enter') buscarWikiImages()"><button class="btn-cerca-modal btn-cerca-wiki" onclick="buscarWikiImages()">üì∑ Cerca</button></div>
                    <div id="resultats-wiki" class="resultats-grid"></div>
                </div>
                <div id="tab-simbols" class="contingut-tab" style="display:none;">
                    <div class="cerca-wrapper"><input id="input-open" onkeyup="if(event.key==='Enter') buscarOpenSymbols()"><button class="btn-cerca-modal btn-cerca-open" onclick="buscarOpenSymbols()">‚úíÔ∏è Cerca</button></div>
                    <div id="resultats-open" class="resultats-grid"></div>
                </div>
                <div id="tab-pujar" class="contingut-tab" style="display:none;text-align:center;">
                    <p>Puja una imatge pr√≤pia:</p><input type="file" accept="image/*" onchange="pujarImatge(this)">
                    <hr style="margin:20px0; border:0; border-top:1px solid #eee;">
                    <button onclick="window.open('https://www.craiyon.com/','_blank','width=400,height=600')" style="background:#333;color:white;margin:auto;padding:15px;border-radius:50px;">üé® Generar amb IA</button>
                </div>
                
                <div id="tab-dibuix" class="contingut-tab" style="display:none; text-align:center;">
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; background:#eee; padding:10px; border-radius:10px;">
                            <label style="font-size:0.8em;">Mida: <input type="range" id="ed-scale" min="0.5" max="3" step="0.1" value="1" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em;">X: <input type="range" id="ed-x" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                            <label style="font-size:0.8em;">Y: <input type="range" id="ed-y" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                        </div>

                        <div class="toolbar-dibuix">
                            <span style="font-size:0.9em; color:#555; font-weight:bold;">Eina:</span>
                            <button id="tool-freehand" class="btn-tool actiu" onclick="setTool('freehand')" title="Dibuix Lliure">„Ä∞Ô∏è</button>
                            <button id="tool-rect" class="btn-tool" onclick="setTool('rect')" title="Quadrat">‚¨õ</button>
                            <button id="tool-circle" class="btn-tool" onclick="setTool('circle')" title="Cercle">‚≠ï</button>
                            <button id="tool-arrow" class="btn-tool" onclick="setTool('arrow')" title="Fletxa">‚ÜóÔ∏è</button>
                            
                            <div style="width:2px; height:20px; background:#ccc; margin:0 2px;"></div> 
                            
                            <button class="btn-color-dibuix" style="background:#e74c3c" onclick="setDrawColor('#e74c3c')"></button>
                            <button class="btn-color-dibuix" style="background:#2980b9" onclick="setDrawColor('#2980b9')"></button>
                            <button class="btn-color-dibuix" style="background:#27ae60" onclick="setDrawColor('#27ae60')"></button>
                            <button class="btn-color-dibuix" style="background:#f1c40f" onclick="setDrawColor('#f1c40f')"></button>
                            <button class="btn-color-dibuix" style="background:#000000" onclick="setDrawColor('#000000')"></button>
                            
                            <div style="width:2px; height:20px; background:#ccc; margin:0 2px;"></div> 
                            
                            <button style="background:#95a5a6; border:none; padding:8px 15px; border-radius:5px; color:white; cursor:pointer; font-size:1.2em; font-weight:bold;" onclick="undoLastDrawing()" title="Desfer √∫ltim pas">‚Ü©Ô∏è</button>
                        </div>
                        <canvas id="canvasEditor" width="300" height="300" style="border:2px dashed #ccc; border-radius:10px; touch-action:none; background:white; cursor:crosshair;"></canvas>
                    </div>
                </div>

            </div>
            <div style="padding:15px;background:#f9f9f9; display:flex; justify-content:space-between; align-items:center;">
                <button onclick="eliminarTargeta()" style="background:#e74c3c; color:white; display:inline-flex; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold;">üóëÔ∏è Eliminar targeta</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="guardarTancar()" style="background:var(--color-accio);display:inline-flex;">‚úÖ Fet</button>
                    <button onclick="tancarModalSenseGuardar()" style="background:#999;display:inline-flex;">Cancel¬∑lar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background: #333; color:white; padding: 10px 20px; border-radius: 30px; z-index:2000;">Copiat!</div>

    <script>
        // Mem√≤ria i variables globals
        let idiomaSeleccionat = 'ca';
        let elementEditant = null;
        let dadesDomino = []; 
        let globalSchoolLogoSrc = ''; 
        let memoriaEdicions = {}; 
        let imgOriginalSrcOnOpen = ''; // Serveix per cancel¬∑lar edici√≥

        // Variables Canvas
        let editorCanvas, editorCtx;
        let editorImgObj = new Image();
        editorImgObj.crossOrigin = "Anonymous";
        let currentDrawings = [];
        let isDrawing = false;
        let drawColor = '#e74c3c';
        let currentTool = 'freehand';
        let startX, startY, currentX, currentY;

        window.onload = function() {
            document.getElementById('any-actual').innerText = new Date().getFullYear();
            if (typeof RUTA_LOGO_PICTOJOCS !== 'undefined' && RUTA_LOGO_PICTOJOCS.trim() !== '') {
                document.getElementById('app-logo-header').src = RUTA_LOGO_PICTOJOCS;
                document.getElementById('print-mini-logo').src = RUTA_LOGO_PICTOJOCS;
                document.getElementById('print-mini-logo-back').src = RUTA_LOGO_PICTOJOCS;
            }

            editorCanvas = document.getElementById('canvasEditor');
            if(editorCanvas) {
                editorCtx = editorCanvas.getContext('2d');
                editorCanvas.addEventListener('mousedown', startDrawingCanvas);
                editorCanvas.addEventListener('mousemove', drawCanvas);
                window.addEventListener('mouseup', stopDrawingCanvas);
                
                editorCanvas.addEventListener('touchstart', e => { e.preventDefault(); startDrawingCanvas(e); }, {passive: false});
                editorCanvas.addEventListener('touchmove', e => { e.preventDefault(); drawCanvas(e); }, {passive: false});
                window.addEventListener('touchend', stopDrawingCanvas);
            }
        };

        // Enviar Suggeriment
        function enviarSuggeriment() {
            const email = document.getElementById('sugg-email').value;
            const subject = document.getElementById('sugg-assumpte').value;
            const msg = document.getElementById('sugg-missatge').value;
            const finalBody = `Correu de contacte: ${email}\n\nMissatge:\n${msg}`;
            window.location.href = `mailto:rrobles4@xtec.cat?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalBody)}`;
        }

        // Projectes JSON
        function desarProjecte() {
            const data = {
                titol: document.getElementById('titol-doc').value,
                curs: document.getElementById('curs').value,
                idioma: document.getElementById('idioma').value,
                paraules: document.getElementById('llista-paraules').value,
                mode: document.getElementById('selector-mode').value,
                midaPaper: document.getElementById('mida-paper').value,
                columnes: document.getElementById('selector-columnes').value,
                font: document.getElementById('selector-font').value,
                colorBg: document.getElementById('color-bg').value,
                colorBorder: document.getElementById('color-border').value,
                colorText: document.getElementById('color-text').value,
                memoria: memoriaEdicions
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'pictojocs_projecte.json';
            a.click();
        }

        function carregarProjecte(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e2) {
                try {
                    const data = JSON.parse(e2.target.result);
                    if (data.titol !== undefined) document.getElementById('titol-doc').value = data.titol;
                    if (data.curs !== undefined) document.getElementById('curs').value = data.curs;
                    if (data.idioma !== undefined) document.getElementById('idioma').value = data.idioma;
                    if (data.paraules !== undefined) document.getElementById('llista-paraules').value = data.paraules;
                    if (data.mode !== undefined) document.getElementById('selector-mode').value = data.mode;
                    if (data.midaPaper !== undefined) document.getElementById('mida-paper').value = data.midaPaper;
                    if (data.columnes !== undefined) document.getElementById('selector-columnes').value = data.columnes;
                    if (data.font !== undefined) document.getElementById('selector-font').value = data.font;
                    
                    if (data.colorBg !== undefined) document.getElementById('color-bg').value = data.colorBg;
                    if (data.colorBorder !== undefined) document.getElementById('color-border').value = data.colorBorder;
                    if (data.colorText !== undefined) document.getElementById('color-text').value = data.colorText;

                    memoriaEdicions = data.memoria || {};
                    canviarMode(); 
                    actualitzarEstils(); 
                } catch(err) { alert("Error carregant el projecte"); }
            };
            reader.readAsText(file);
        }

        function carregarLogoEscola(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { 
                    globalSchoolLogoSrc = e.target.result;
                    const idsImatges = ['logo-visual', 'logo-visual-back'];
                    idsImatges.forEach(id => {
                        const img = document.getElementById(id);
                        if(img) { img.src = globalSchoolLogoSrc; img.style.display = 'block'; }
                    });
                    document.getElementById('wrapper-logo').classList.add('feteservir');
                    document.getElementById('wrapper-logo').innerHTML = "‚úÖ Logo Escola Carregat";
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function canviarMode() {
            const mode = document.getElementById('selector-mode').value;
            const btnMix = document.getElementById('btn-mix');
            const instruccions = document.getElementById('text-instruccions');
            const avisDobleCara = document.getElementById('avis-doble-cara');
            
            if (mode === 'targeta' || mode === 'memory') {
                avisDobleCara.style.display = 'list-item';
            } else {
                avisDobleCara.style.display = 'none';
            }

            if (mode === 'domino') {
                btnMix.style.display = 'flex';
                instruccions.innerHTML = "Consell: clica a \"Barrejar fitxes\" per reordenar aleat√≤riament.";
            } else if (mode === 'memory') {
                btnMix.style.display = 'none';
                instruccions.innerHTML = "Consell: Es generaran parelles separades. El revers ser√† el logo de PictoJocs.";
            } else {
                btnMix.style.display = 'none';
                instruccions.innerHTML = "Consell: Arrossega per reordenar. Fes clic als dibuixos o noms per editar.";
            }
            generarDocument();
        }

        async function generarDocument() {
            const titol = document.getElementById('titol-doc').value || "Sense t√≠tol";
            const curs = document.getElementById('curs').value;
            const textParaules = document.getElementById('llista-paraules').value;
            const mode = document.getElementById('selector-mode').value;
            idiomaSeleccionat = document.getElementById('idioma').value;

            document.getElementById('titol-resultat').innerText = titol;
            document.getElementById('titol-resultat-back').innerText = titol;
            
            const cursEl = document.getElementById('curs-resultat');
            const cursElBack = document.getElementById('curs-resultat-back');
            if (curs.trim()) { 
                cursEl.innerText = curs; cursEl.style.display='inline-block'; 
                cursElBack.innerText = curs; cursElBack.style.display='inline-block';
            } else { 
                cursEl.style.display='none'; cursElBack.style.display='none';
            }

            const contenidor = document.getElementById('contenidor-picts');
            const contenidorRevers = document.getElementById('contenidor-revers');
            const wrapperRevers = document.getElementById('contenidor-revers-wrapper');

            contenidor.innerHTML = '';
            contenidorRevers.innerHTML = '';
            
            contenidor.classList.remove('mode-targeta-front', 'mode-domino', 'mode-memory-front');
            contenidorRevers.classList.remove('mode-targeta-back');
            wrapperRevers.style.display = 'none';

            if (!textParaules.trim()) return; 
            const llista = textParaules.split(',').map(p=>p.trim()).filter(p=>p!=='');
            
            if (dadesDomino.length === 0 || dadesDomino.length !== llista.length) {
                dadesDomino = llista.map(p => {
                    let mem = memoriaEdicions[p];
                    if (mem) return { txt: mem.htmlFinal, imgUrl: mem.imgUrl, isHtml: true };
                    return { txt: p, imgUrl: null, isHtml: false };
                }); 
            }

            if (mode === 'targeta') { 
                wrapperRevers.style.display = 'block';
                contenidor.classList.add('mode-targeta-front');
                contenidorRevers.classList.add('mode-targeta-back');
                
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula];
                    const divFront = crearElementTargeta(paraula, i, 'front');
                    const divBack = crearElementTargeta(paraula, i, 'back');
                    
                    if (mem) {
                        divFront.querySelector('img').src = mem.imgUrl;
                        divFront.querySelector('img').style.opacity = '1';
                        divBack.querySelector('.contingut-back').innerHTML = mem.htmlFinal;
                    } else {
                        buscarArasaacAuto(paraula, i);
                    }
                    contenidor.appendChild(divFront);
                    contenidorRevers.appendChild(divBack);
                });

            } else if (mode === 'memory') {
                wrapperRevers.style.display = 'block';
                contenidor.classList.add('mode-memory-front');
                
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula];
                    
                    const fitxaImg = crearElementTargeta(paraula, i, 'front');
                    fitxaImg.classList.add('nomes-img');
                    
                    const fitxaText = crearElementTargeta(paraula, i, 'front');
                    fitxaText.classList.add('nomes-text');
                    const pText = fitxaText.querySelector('p');
                    pText.id = `text-memory-${i}`; 

                    if (mem) {
                        fitxaImg.querySelector('img').src = mem.imgUrl;
                        fitxaImg.querySelector('img').style.opacity = '1';
                        pText.innerHTML = mem.htmlFinal;
                    } else {
                        buscarArasaacAuto(paraula, i); 
                    }

                    contenidor.appendChild(fitxaImg);
                    contenidor.appendChild(fitxaText);
                    contenidorRevers.appendChild(crearElementReversLogoPictojocs());
                    contenidorRevers.appendChild(crearElementReversLogoPictojocs());
                });

            } else if (mode === 'domino') {
                contenidor.classList.add('mode-domino');
                
                for(let i=0; i<llista.length; i++) {
                    let textMostrar = dadesDomino[i] ? dadesDomino[i].txt : llista[i];
                    let paraulaOriginal = llista[i]; 
                    
                    const div = document.createElement('div');
                    div.className = 'pictograma';
                    div.dataset.index = i;
                    div.dataset.original = paraulaOriginal;
                    
                    const divImg = document.createElement('div');
                    divImg.className = 'imatge-box';
                    const img = document.createElement('img');
                    img.id = `img-${i}-domino`;
                    if(dadesDomino[i] && dadesDomino[i].imgUrl) {
                        img.src = dadesDomino[i].imgUrl;
                        img.style.opacity = '1';
                    } else {
                        img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png';
                        buscarArasaacDomino(paraulaOriginal, i); 
                    }
                    divImg.appendChild(img);
                    
                    const separador = document.createElement('div');
                    separador.className = 'separador-domino';

                    const divText = document.createElement('div');
                    divText.className = 'text-domino';
                    if (dadesDomino[i] && dadesDomino[i].isHtml) {
                        divText.innerHTML = dadesDomino[i].txt;
                    } else {
                        divText.innerHTML = `<span class="fila-paraula">${textMostrar}</span>`;
                    }

                    div.appendChild(divImg);
                    div.appendChild(separador);
                    div.appendChild(divText);
                    
                    div.addEventListener('click', () => obrirModal(div));
                    div.draggable = true;
                    div.addEventListener('dragstart', ()=>div.classList.add('dragging'));
                    div.addEventListener('dragend', ()=>div.classList.remove('dragging'));
                    
                    contenidor.appendChild(div);
                }

            } else {
                llista.forEach((paraula, i) => {
                    let mem = memoriaEdicions[paraula];
                    const targeta = crearElementTargeta(paraula, i, 'front');
                    if(mem) {
                        targeta.querySelector('img').src = mem.imgUrl;
                        targeta.querySelector('img').style.opacity = '1';
                        targeta.querySelector('p').innerHTML = mem.htmlFinal;
                    } else {
                        buscarArasaacAuto(paraula, i);
                    }
                    contenidor.appendChild(targeta);
                });
            }
            actualitzarEstils();
        }

        function crearElementReversLogoPictojocs() {
            const div = document.createElement('div');
            div.className = 'pictograma';
            const content = document.createElement('div');
            content.className = 'contingut-back-logo';
            const img = document.createElement('img');
            img.src = RUTA_LOGO_PICTOJOCS; 
            content.appendChild(img);
            div.appendChild(content);
            return div;
        }

        function barrejarDomino() {
            const fitxes = document.querySelectorAll('.pictograma');
            let actualImages = [];
            let actualTexts = [];

            fitxes.forEach((f, index) => {
                actualImages.push(f.querySelector('img').src);
                actualTexts.push(f.querySelector('.text-domino').innerHTML);
            });

            const ultimText = actualTexts.pop();
            actualTexts.unshift(ultimText);

            dadesDomino = [];
            for(let i=0; i<actualImages.length; i++) {
                dadesDomino.push({
                    imgUrl: actualImages[i],
                    txt: actualTexts[i],
                    isHtml: true
                });
            }
            generarDocument();
            
            const btn = document.getElementById('btn-mix');
            btn.innerText = "‚úÖ Fet!";
            setTimeout(()=> btn.innerText = "Barrejar fitxes", 1500);
        }

        function crearElementTargeta(paraula, index, tipus) {
            const div = document.createElement('div');
            div.className = 'pictograma';
            div.draggable = true; div.dataset.index = index; div.dataset.original = paraula; 
            
            div.addEventListener('click', () => { if(!div.classList.contains('dragging')) obrirModal(div); });
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); sincronitzarOrdre(div); });
            
            if (tipus === 'back') {
                const containerText = document.createElement('div');
                containerText.id = `text-${index}-${tipus}`;
                containerText.className = 'contingut-back';
                const span = document.createElement('div');
                span.className = 'fila-paraula';
                span.innerText = paraula;
                containerText.appendChild(span);
                div.appendChild(containerText);
            } else {
                const divImg = document.createElement('div');
                divImg.className = 'imatge-box';
                
                const img = document.createElement('img');
                img.id = `img-${index}-${tipus}`; 
                img.src = 'https://upload.wikimedia.org/wikipedia/commons/c/ca/1x1.png'; 
                
                divImg.appendChild(img);
                
                const p = document.createElement('p');
                p.id = `text-${index}-${tipus}`;
                p.innerHTML = `<span class="fila-paraula">${paraula}</span>`;
                
                div.appendChild(divImg);
                div.appendChild(p);
            }
            return div;
        }

        function sincronitzarOrdre(element) {
            const mode = document.getElementById('selector-mode').value;
            if (mode === 'memory') return; 

            const isFront = element.parentElement.id === 'contenidor-picts';
            const origen = isFront ? document.getElementById('contenidor-picts') : document.getElementById('contenidor-revers');
            const desti = isFront ? document.getElementById('contenidor-revers') : document.getElementById('contenidor-picts');
            if (!origen || !desti) return;
            const elementsOrigen = Array.from(origen.children);
            const ordreIndex = elementsOrigen.map(el => el.dataset.index);
            
            let nousElements = [];
            ordreIndex.forEach(idx => {
                const el = desti.querySelector(`.pictograma[data-index="${idx}"]`);
                if(el) desti.appendChild(el);
            });
        }
        
        const conts = [document.getElementById('contenidor-picts'), document.getElementById('contenidor-revers')];
        conts.forEach(cont => {
            cont.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if(!dragging || dragging.parentElement !== cont) return; 
                const siblings = [...cont.querySelectorAll('.pictograma:not(.dragging)')];
                let closest = null; let minDistance = Infinity;
                siblings.forEach(sibling => {
                    const box = sibling.getBoundingClientRect();
                    const d = Math.abs(e.clientY - (box.top + box.height / 2));
                    if (d < minDistance) { minDistance = d; closest = sibling; }
                });
                if (closest) {
                    const box = closest.getBoundingClientRect();
                    if(e.clientX > box.left + box.width/2) cont.insertBefore(dragging, closest.nextSibling);
                    else cont.insertBefore(dragging, closest);
                } else cont.appendChild(dragging);
            });
        });

        async function buscarArasaacAuto(text, index) {
            try {
                const r = await fetch(`https://api.arasaac.org/api/pictograms/${idiomaSeleccionat}/search/${encodeURIComponent(text)}`);
                const d = await r.json();
                let src = d.length ? `https://static.arasaac.org/pictograms/${d[0]._id}/${d[0]._id}_500.png` : "https://static.arasaac.org/images/no_results.png";
                actualitzarImatgeTargeta(index, src, d.length ? "1" : "0.3");
            } catch(e){}
        }

        async function buscarArasaacDomino(text, index) {
            try {
                const r = await fetch(`https://api.arasaac.org/api/pictograms/${idiomaSeleccionat}/search/${encodeURIComponent(text)}`);
                const d = await r.json();
                let src = d.length ? `https://static.arasaac.org/pictograms/${d[0]._id}/${d[0]._id}_500.png` : "https://static.arasaac.org/images/no_results.png";
                const imgEl = document.getElementById(`img-${index}-domino`);
                if(imgEl) { imgEl.src = src; imgEl.style.opacity = '1'; }
                if(dadesDomino[index]) dadesDomino[index].imgUrl = src;
            } catch(e){}
        }

        function actualitzarImatgeTargeta(index, src, opacitat) {
            const imgFront = document.getElementById(`img-${index}-front`);
            if(imgFront) { imgFront.src = src; imgFront.style.opacity = opacitat; }
        }

        function actualitzarEstils() {
            const doc = document.documentElement.style;
            doc.setProperty('--tipus-font', document.getElementById('selector-font').value);
            doc.setProperty('--targeta-bg', document.getElementById('color-bg').value);
            doc.setProperty('--targeta-border', document.getElementById('color-border').value);
            doc.setProperty('--targeta-text', document.getElementById('color-text').value);

            const paper = document.getElementById('mida-paper').value;
            if (paper === 'a3') {
                doc.setProperty('--width-paper', '297mm');
                doc.setProperty('--height-paper', '420mm');
            } else {
                doc.setProperty('--width-paper', '210mm');
                doc.setProperty('--height-paper', '297mm');
            }
            doc.setProperty('--num-columnes', document.getElementById('selector-columnes').value);
            
            setTimeout(() => {
                const mode = document.getElementById('selector-mode').value;
                if(mode === 'targeta') document.querySelectorAll('.contingut-back').forEach(el => autoMidaText(el));
                else if(mode === 'memory') document.querySelectorAll('.nomes-text p').forEach(el => autoMidaText(el));
                else if(mode === 'domino') document.querySelectorAll('.text-domino').forEach(el => autoMidaText(el));
                else document.querySelectorAll('.pictograma p').forEach(el => autoMidaText(el));
            }, 100);
        }

        function autoMidaText(container) {
            if (!container) return;
            let mida = 60; container.style.fontSize = mida + 'px'; container.style.lineHeight = '1.1';
            while ((container.scrollWidth > container.clientWidth || container.scrollHeight > container.clientHeight) && mida > 8) {
                mida--; container.style.fontSize = mida + 'px';
            }
        }

        function obrirModal(el) {
            elementEditant = el;
            const index = el.dataset.index;
            const mode = document.getElementById('selector-mode').value;
            let containerTxt = null;
            
            let maxInputs = 2; 
            let classeLayout = "dues-paraules";

            // Fix per sempre: Dos espais d'amplada (48%) fins a omplir els 5
            if (mode === 'targeta' || mode === 'memory') {
                maxInputs = 5; classeLayout = "cinc-paraules";
            } else {
                maxInputs = 2; classeLayout = "dues-paraules";
            }

            // Guardar Imatge Original per si fem "Cancel¬∑lar"
            let imgTarget = elementEditant.querySelector('img');
            if (mode === 'memory') {
                if (elementEditant.classList.contains('nomes-img')) {
                    imgTarget = elementEditant.querySelector('img');
                } else {
                    const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`);
                    if(imgCard) imgTarget = imgCard.querySelector('img');
                }
            }
            imgOriginalSrcOnOpen = imgTarget ? imgTarget.src : '';

            if (mode === 'domino') containerTxt = el.querySelector('.text-domino');
            else if (mode === 'targeta') containerTxt = document.getElementById(`text-${index}-back`);
            else if (mode === 'memory') {
                 if (el.classList.contains('nomes-text')) containerTxt = el.querySelector('p'); 
                 else containerTxt = el.querySelector('p'); 
            } else containerTxt = el.querySelector('p');
            
            let paraulesActuals = [];
            if(containerTxt) {
                const files = containerTxt.querySelectorAll('.fila-paraula');
                if(files.length > 0) files.forEach(f => paraulesActuals.push(f.innerText));
                else paraulesActuals.push(containerTxt.innerText);
            }

            const containerInputs = document.getElementById('camps-text');
            containerInputs.className = `inputs-container-modal ${classeLayout}`;
            containerInputs.innerHTML = '';
            
            for(let i=0; i<maxInputs; i++) {
                const val = paraulesActuals[i] || "";
                containerInputs.innerHTML += `<input type="text" class="input-text-modal" id="input-modal-${i}" value="${val}" placeholder="Text ${i+1}">`;
            }

            let paraulaCerca = el.dataset.original || paraulesActuals[0] || "";
            document.getElementById('input-arasaac').value = paraulaCerca;
            document.getElementById('resultats-traductor').innerHTML = ''; 

            document.getElementById('modal-edicio').style.display = 'flex';
            canviarPestanya('tab-arasaac'); 
            if(paraulaCerca) buscarArasaacModal();
        }

        function eliminarTargeta() {
            if(!elementEditant) return;
            if(confirm("Segur que vols eliminar aquesta targeta? Aix√≤ la traur√† de la llista de paraules.")) {
                const original = elementEditant.dataset.original;
                let llista = document.getElementById('llista-paraules').value.split(',').map(p=>p.trim()).filter(p=>p!=='');
                const idx = llista.indexOf(original);
                if(idx > -1) {
                    llista.splice(idx, 1);
                    document.getElementById('llista-paraules').value = llista.join(', ');
                    document.getElementById('modal-edicio').style.display = 'none';
                    elementEditant = null;
                    generarDocument(); 
                }
            }
        }

        function guardarTancar() {
            if(elementEditant) {
                if (document.getElementById('tab-dibuix').style.display === 'block') {
                    aplicarEdicioImatge(false);
                }

                const mode = document.getElementById('selector-mode').value;
                const index = elementEditant.dataset.index;
                const original = elementEditant.dataset.original;
                
                let nousTextos = [];
                document.querySelectorAll('.input-text-modal').forEach(inp => {
                    if(inp.value.trim() !== "") nousTextos.push(inp.value.trim());
                });
                
                let htmlFinal = nousTextos.map(t => `<div class="fila-paraula">${t}</div>`).join('');
                if(htmlFinal === "") htmlFinal = `<div class="fila-paraula">&nbsp;</div>`;

                let currentImgUrl = null;
                if (mode === 'domino') {
                    currentImgUrl = elementEditant.querySelector('img').src;
                } else if (mode === 'memory') {
                    const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`);
                    if (imgCard) currentImgUrl = imgCard.querySelector('img').src;
                } else {
                    currentImgUrl = elementEditant.querySelector('img') ? elementEditant.querySelector('img').src : null;
                }
                
                memoriaEdicions[original] = {
                    htmlFinal: htmlFinal,
                    imgUrl: currentImgUrl
                };

                if (mode === 'domino') {
                    elementEditant.querySelector('.text-domino').innerHTML = htmlFinal; autoMidaText(elementEditant.querySelector('.text-domino'));
                    if(dadesDomino[index]) { dadesDomino[index].txt = htmlFinal; dadesDomino[index].isHtml = true; }
                } else if (mode === 'targeta') {
                    document.getElementById(`text-${index}-back`).innerHTML = htmlFinal; autoMidaText(document.getElementById(`text-${index}-back`));
                } else if (mode === 'memory') {
                    if(elementEditant.classList.contains('nomes-text')) {
                        elementEditant.querySelector('p').innerHTML = htmlFinal; autoMidaText(elementEditant.querySelector('p'));
                    } else {
                        const p = elementEditant.querySelector('p');
                        if(p) p.innerHTML = htmlFinal;
                    }
                } else { 
                    const p = elementEditant.querySelector('p');
                    p.innerHTML = htmlFinal; autoMidaText(p);
                }
            }
            document.getElementById('modal-edicio').style.display = 'none';
            elementEditant = null;
        }

        function tancarModalSenseGuardar() { 
            // Revertim la imatge si s'havia canviat visualment abans de cancel¬∑lar
            if(elementEditant && imgOriginalSrcOnOpen) {
                 const index = elementEditant.dataset.index;
                 const mode = document.getElementById('selector-mode').value;
                 if (mode === 'domino') { elementEditant.querySelector('img').src = imgOriginalSrcOnOpen; }
                 else if (mode === 'memory') {
                     if (elementEditant.classList.contains('nomes-img')) elementEditant.querySelector('img').src = imgOriginalSrcOnOpen;
                     else { const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`); if(imgCard) imgCard.querySelector('img').src = imgOriginalSrcOnOpen; }
                 } else { const img = document.getElementById(`img-${index}-front`); if(img) img.src = imgOriginalSrcOnOpen; }
            }
            document.getElementById('modal-edicio').style.display = 'none'; 
            elementEditant=null; 
        }
        
        function canviarPestanya(id) {
            document.querySelectorAll('.contingut-tab').forEach(e=>e.style.display='none');
            document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('actiu'));
            document.getElementById(id).style.display='block';
            document.querySelectorAll(`.tab-btn[onclick*="${id}"]`).forEach(b=>b.classList.add('actiu'));
        }
        
        function aplicarImatge(src) { 
            if(elementEditant) { 
                const index = elementEditant.dataset.index;
                const mode = document.getElementById('selector-mode').value;
                if (mode === 'domino') {
                    elementEditant.querySelector('img').src = src;
                } else if (mode === 'memory') {
                    if (elementEditant.classList.contains('nomes-img')) {
                         elementEditant.querySelector('img').src = src;
                    } else {
                         const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`);
                         if(imgCard) imgCard.querySelector('img').src = src;
                    }
                } else {
                    const img = document.getElementById(`img-${index}-front`);
                    if(img) { img.src = src; img.style.opacity = '1'; }
                }
            } 
        }

        /* --- FUNCIONS DE L'EDITOR CANVAS --- */
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.btn-tool').forEach(btn => btn.classList.remove('actiu'));
            document.getElementById('tool-' + tool).classList.add('actiu');
        }

        function setDrawColor(c) { drawColor = c; }
        
        function undoLastDrawing() {
            if (currentDrawings.length > 0) {
                currentDrawings.pop();
                drawEditorCanvas();
            }
        }
        
        function getMousePos(e) {
            const rect = editorCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawingCanvas(e) {
            isDrawing = true;
            const pos = getMousePos(e);
            startX = pos.x; startY = pos.y;
            currentX = pos.x; currentY = pos.y;

            if (currentTool === 'freehand') {
                currentDrawings.push({ type: 'freehand', color: drawColor, points: [{x: startX, y: startY}] });
            }
        }
        
        function drawCanvas(e) {
            if(!isDrawing) return;
            const pos = getMousePos(e);
            currentX = pos.x; currentY = pos.y;

            if (currentTool === 'freehand') {
                currentDrawings[currentDrawings.length-1].points.push({x: currentX, y: currentY});
            }
            drawEditorCanvas();
        }

        function stopDrawingCanvas() {
            if(!isDrawing) return;
            isDrawing = false;
            
            if (currentTool !== 'freehand') {
                if (startX !== currentX || startY !== currentY) {
                    currentDrawings.push({ 
                        type: currentTool, 
                        color: drawColor, 
                        start: {x: startX, y: startY}, 
                        end: {x: currentX, y: currentY} 
                    });
                }
            }
            drawEditorCanvas();
        }
        
        function obrirTabEdicio() {
            canviarPestanya('tab-dibuix');
            let currentSrc = '';
            const mode = document.getElementById('selector-mode').value;
            if (mode === 'domino') {
                currentSrc = elementEditant.querySelector('img').src;
            } else if (mode === 'memory') {
                if (elementEditant.classList.contains('nomes-img')) { currentSrc = elementEditant.querySelector('img').src; }
                else {
                    const index = elementEditant.dataset.index;
                    const imgCard = document.querySelector(`.mode-memory-front .nomes-img[data-index="${index}"]`);
                    if(imgCard) currentSrc = imgCard.querySelector('img').src;
                }
            } else {
                const img = elementEditant.querySelector('img');
                if(img) currentSrc = img.src;
            }
            
            if(currentSrc) {
                editorImgObj.src = currentSrc;
                editorImgObj.onload = () => {
                    document.getElementById('ed-scale').value = 1;
                    document.getElementById('ed-x').value = 0;
                    document.getElementById('ed-y').value = 0;
                    currentDrawings = [];
                    setTool('freehand'); 
                    drawEditorCanvas();
                };
            }
        }
        
        function drawArrow(ctx, fromx, fromy, tox, toy) {
            var headlen = 15; 
            var dx = tox - fromx;
            var dy = toy - fromy;
            var angle = Math.atan2(dy, dx);
            ctx.beginPath();
            ctx.moveTo(fromx, fromy);
            ctx.lineTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function drawEditorCanvas() {
            editorCtx.clearRect(0, 0, 300, 300);
            
            const scale = parseFloat(document.getElementById('ed-scale').value);
            const dx = parseFloat(document.getElementById('ed-x').value);
            const dy = parseFloat(document.getElementById('ed-y').value);
            
            editorCtx.save();
            editorCtx.translate(150 + dx, 150 + dy);
            editorCtx.scale(scale, scale);
            if (editorImgObj.src) {
                const aspect = editorImgObj.width / editorImgObj.height;
                let w = 280, h = 280;
                if (aspect > 1) h = w / aspect; else w = h * aspect;
                editorCtx.drawImage(editorImgObj, -w/2, -h/2, w, h);
            }
            editorCtx.restore();
            
            editorCtx.lineCap = 'round'; editorCtx.lineJoin = 'round'; 
            
            currentDrawings.forEach(shape => {
                editorCtx.strokeStyle = shape.color;
                editorCtx.lineWidth = 4;
                if (shape.type === 'freehand') {
                    editorCtx.beginPath();
                    shape.points.forEach((p, i) => { if(i===0) editorCtx.moveTo(p.x, p.y); else editorCtx.lineTo(p.x, p.y); });
                    editorCtx.stroke();
                } else if (shape.type === 'rect') {
                    editorCtx.strokeRect(shape.start.x, shape.start.y, shape.end.x - shape.start.x, shape.end.y - shape.start.y);
                } else if (shape.type === 'circle') {
                    editorCtx.beginPath();
                    let r = Math.sqrt(Math.pow(shape.end.x - shape.start.x, 2) + Math.pow(shape.end.y - shape.start.y, 2));
                    editorCtx.arc(shape.start.x, shape.start.y, r, 0, 2 * Math.PI);
                    editorCtx.stroke();
                } else if (shape.type === 'arrow') {
                    drawArrow(editorCtx, shape.start.x, shape.start.y, shape.end.x, shape.end.y);
                }
            });

            if(isDrawing && currentTool !== 'freehand') {
                editorCtx.strokeStyle = drawColor;
                editorCtx.lineWidth = 4;
                if(currentTool === 'rect') {
                    editorCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                } else if(currentTool === 'circle') {
                    editorCtx.beginPath();
                    let r = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    editorCtx.arc(startX, startY, r, 0, 2 * Math.PI);
                    editorCtx.stroke();
                } else if(currentTool === 'arrow') {
                    drawArrow(editorCtx, startX, startY, currentX, currentY);
                }
            }
        }
        
        function aplicarEdicioImatge(canviarTab = true) {
            const dataUrl = editorCanvas.toDataURL('image/png');
            aplicarImatge(dataUrl);
            if(canviarTab) canviarPestanya('tab-arasaac'); 
        }

        async function traduirParaula() {
            const word = document.getElementById('input-modal-0').value;
            const divRes = document.getElementById('resultats-traductor');
            divRes.innerHTML = "<p style='text-align:center'>‚è≥ Traduint...</p>";
            const langs = [{code:'es', nom:'Castell√†'},{code:'en', nom:'Angl√®s'},{code:'fr', nom:'Franc√®s'},{code:'zh', nom:'Xin√®s'},{code:'ur', nom:'Urdu'},{code:'ar', nom:'√Ärab'}];
            let html = "";
            for (const lang of langs) {
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=ca|${lang.code}`);
                    const data = await res.json();
                    if(data.responseData && data.responseData.translatedText) {
                        html += `<div class="item-traduccio" onclick="copiarText('${data.responseData.translatedText}')"><div><span class="lang-code">${lang.nom}</span><span class="trad-text">${data.responseData.translatedText}</span></div><span class="copy-hint">üìã</span></div>`;
                    }
                } catch(e) {}
            }
            divRes.innerHTML = html || "Error de connexi√≥";
        }
        function copiarText(t) { navigator.clipboard.writeText(t); const o = document.getElementById('toast'); o.style.display='block'; setTimeout(()=>o.style.display='none', 2000); }
        async function buscarArasaacModal() { const q=document.getElementById('input-arasaac').value; renderResultats(await fetch(`https://api.arasaac.org/api/pictograms/${idiomaSeleccionat}/search/${encodeURIComponent(q)}`).then(r=>r.json()).then(d=>d.map(x=>`https://static.arasaac.org/pictograms/${x._id}/${x._id}_300.png`)), 'resultats-arasaac'); }
        async function buscarWikiImages() { const q=document.getElementById('input-wiki').value; const r=await fetch(`https://ca.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(q)}&gsrnamespace=0&gsrlimit=10&prop=pageimages&piprop=thumbnail&pithumbsize=300&format=json&origin=*`).then(res=>res.json()); renderResultats(r.query?.pages ? Object.values(r.query.pages).filter(p=>p.thumbnail).map(p=>p.thumbnail.source) : [], 'resultats-wiki'); }
        async function buscarOpenSymbols() { const q=document.getElementById('input-open').value; const d=await fetch(`https://www.opensymbols.org/api/v1/symbols/search?q=${encodeURIComponent(q)}`).then(r=>r.json()); renderResultats(d.slice(0,12).map(x=>x.image_url), 'resultats-open'); }
        function renderResultats(u,d) { const div=document.getElementById(d); div.innerHTML=''; u.forEach(url=>{const i=document.createElement('img'); i.src=url; i.onclick=()=>aplicarImatge(url); div.appendChild(i);}); }
        function pujarImatge(i) { const r=new FileReader(); r.onload=e=>aplicarImatge(e.target.result); if(i.files[0]) r.readAsDataURL(i.files[0]); }
    </script>
</body>
</html>
