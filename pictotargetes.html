<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoTargetes - PictoSuite</title>
    <link href="https://fonts.googleapis.com/css2?family=Andika&family=Dancing+Script:wght@400;700&family=Fredoka:wght@400;600&family=Indie+Flower&family=Patrick+Hand&family=Roboto&family=Comic+Neue:wght@400;700&family=Schoolbell&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-fons: #f0f8ff;
            --color-principal: #4a90e2;
            --color-secundari: #f39c12;
            --color-accio: #27ae60;
            --mida-font-base: 18px;
            --tipus-font: 'Andika', sans-serif;
            --num-columnes: 3;
            --targeta-bg: #ffffff;
            --targeta-border: #000000;
            --targeta-text: #000000;
        }

        body { font-family: var(--tipus-font); margin: 0; padding: 20px; background-color: #fdfbf7; color: #333; }
        
        /* ESTILS DEL MEN√ö HAMBURGUESA */
        .menu-btn { position: fixed; top: 20px; left: 20px; background-color: var(--color-principal); color: white; border: none; border-radius: 8px; padding: 10px 15px; font-size: 24px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .menu-btn:hover { background-color: #357abd; }
        .side-menu { height: 100%; width: 0; position: fixed; z-index: 1001; top: 0; left: 0; background-color: #ffffff; overflow-x: hidden; transition: 0.4s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); padding-top: 70px; display: flex; flex-direction: column; font-family: 'Fredoka', sans-serif;}
        .side-menu a { padding: 15px 25px; text-decoration: none; font-size: 18px; color: #333; display: block; transition: 0.2s; }
        .side-menu a:hover { background-color: #f0f8ff; color: var(--color-principal); }
        .side-menu .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; background: none; border: none; cursor: pointer; color: #999; }
        
        /* CAP√áALERA */
        .header-app { text-align: center; margin-bottom: 20px; }
        .header-app img { max-width: 150px; border-radius: 10px; }
        .header-app h1 { font-family: 'Fredoka', sans-serif; color: var(--color-principal); margin: 10px 0 0 0; font-size: 2.5rem;}
        
        /* CONTROLS I BOTONS */
        .projecte-controls { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; padding-left: 60px; }
        button { cursor: pointer; font-family: 'Fredoka', sans-serif; border: none; border-radius: 8px; padding: 10px 15px; font-size: 16px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-mini { background-color: var(--color-principal); }
        .btn-accio { background-color: var(--color-accio); padding: 12px 20px; font-size: 18px; width: 100%; margin-top: 15px;}
        .btn-perill { background-color: #e74c3c; }
        
        /* CERCADOR I RESULTATS */
        .cercador-container { display: flex; gap: 10px; margin-bottom: 20px; }
        #cercador { flex-grow: 1; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 10px; font-family: var(--tipus-font); }
        #cercador:focus { border-color: var(--color-principal); outline: none; }
        .resultats-graella { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px; max-height: 400px; overflow-y: auto; padding: 10px; background: white; border-radius: 10px; border: 1px solid #ddd; }
        .picto-resultat { background: white; border: 2px solid #eee; border-radius: 10px; padding: 10px; text-align: center; cursor: grab; transition: all 0.2s; }
        .picto-resultat:hover { border-color: var(--color-principal); transform: translateY(-2px); }
        .picto-resultat img { width: 100%; height: auto; object-fit: contain; }
        
        /* GRAELLA DE PROJECTE (A4) */
        .full-a4 { background: white; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 10mm; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(var(--num-columnes), 1fr); gap: 10px; align-content: start; }
        .targeta { border: 2px solid var(--targeta-border); background: var(--targeta-bg); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; position: relative; aspect-ratio: 1; }
        .targeta img { max-width: 80%; max-height: 70%; object-fit: contain; flex-grow: 1; }
        .targeta input { width: 90%; text-align: center; border: none; font-size: 16px; font-family: var(--tipus-font); color: var(--targeta-text); background: transparent; margin-top: 5px; outline: none; }
        
        /* BOTONS DINS LA TARGETA */
        .targeta-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .targeta:hover .targeta-controls { opacity: 1; }
        .btn-icon { background: rgba(255,255,255,0.9); border: 1px solid #ddd; color: #333; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 0; font-size: 14px; }
        .btn-icon:hover { background: #eee; }

        /* MODALS (EDITOR I CONFIG) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .editor-tools { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .tool-btn { background: #ddd; color: #333; padding: 5px 10px; font-size: 14px; }
        .tool-btn.active { background: var(--color-principal); color: white; }
        #editor-canvas { border: 2px dashed #ccc; cursor: crosshair; background: #fff; max-width: 100%; margin: 0 auto; display: block; }
        
        @media print {
            body { background: white; padding: 0; }
            .no-print, .menu-btn, .projecte-controls, .cercador-container, .resultats-graella, .header-app { display: none !important; }
            .full-a4 { box-shadow: none; padding: 0; width: 100%; min-height: auto; }
            .targeta-controls { display: none !important; }
            .targeta input { border: none !important; }
        }
    </style>
</head>
<body>

    <button class="menu-btn no-print" onclick="document.getElementById('elMeuMenu').style.width = '250px'">‚ò∞</button>

    <div id="elMeuMenu" class="side-menu no-print">
        <button class="close-btn" onclick="document.getElementById('elMeuMenu').style.width = '0'">√ó</button>
        <a href="index.html">üè† Inici (PictoSuite)</a>
        <a href="pictotargetes.html">üÉè PictoTargetes</a>
        <a href="pictoxat.html">üí¨ PictoXat</a>
    </div>

    <div class="projecte-controls no-print">
        <button class="btn-mini" style="background:#f5b041; margin-right: auto;" onclick="obrirSettings()">ü§ñ Configuraci√≥</button>
        <button id="btn-desar" class="btn-mini" onclick="desarProjecte()">üíæ Desar Projecte</button>
        <button class="btn-mini" onclick="document.getElementById('input-carregar').click()">üìÇ Obre Projecte</button>
        <input type="file" id="input-carregar" accept=".json" style="display:none" onchange="carregarProjecte(event)">
    </div>

    <div class="header-app no-print">
        <img src="https://raw.githubusercontent.com/rrobles4/pictojocs/main/logo%20PictoJocs.png" alt="Logo PictoTargetes">
        <h1>PictoTargetes</h1>
    </div>

    <div class="cercador-container no-print">
        <input type="text" id="cercador" placeholder="Escriu una paraula per buscar a ARASAAC (ex: escola, nen...)" onkeypress="if(event.key === 'Enter') cercarPictogrames()">
        <button class="btn-mini" onclick="cercarPictogrames()">üîç Cercar</button>
    </div>

    <div id="resultats" class="resultats-graella no-print"></div>

    <div class="configuracio no-print" style="margin-bottom: 10px;">
        <label>Columnes: <input type="number" id="num-cols" value="3" min="1" max="6" onchange="actualitzarGraella()" style="width: 50px;"></label>
    </div>
    <div id="graella-targetes" class="full-a4" ondragover="allowDrop(event)" ondrop="drop(event)">
        </div>
    
    <button class="btn-accio no-print" onclick="window.print()">üñ®Ô∏è Imprimir Targetes</button>

    <div id="editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0">üé® Editor de Imatge</h2>
            <div class="editor-tools">
                <button class="tool-btn active" onclick="setTool('freehand')">‚úèÔ∏è Lliure</button>
                <button class="tool-btn" onclick="setTool('line')">üìè L√≠nia</button>
                <button class="tool-btn" onclick="setTool('rect')">‚¨õ Rectangle</button>
                <button class="tool-btn" onclick="setTool('circle')">‚≠ï Cercle</button>
                <input type="color" id="editor-color" value="#ff0000" onchange="drawColor = this.value" title="Color">
                <button class="tool-btn" onclick="clearDrawings()">üóëÔ∏è Neteja dibuix</button>
            </div>
            
            <div style="margin-bottom: 10px; font-size: 14px; background: #eee; padding: 10px; border-radius: 5px;">
                <label>Mida: <input type="range" id="ed-scale" min="0.5" max="3" step="0.1" value="1" oninput="drawEditorCanvas()"></label>
                <label> ‚ÜîÔ∏è X: <input type="range" id="ed-x" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
                <label> ‚ÜïÔ∏è Y: <input type="range" id="ed-y" min="-150" max="150" value="0" oninput="drawEditorCanvas()"></label>
            </div>

            <canvas id="editor-canvas" width="300" height="300"></canvas>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn-perill" onclick="tancarEditor()">Cancel¬∑lar</button>
                <button class="btn-accio" style="margin-top:0; width: auto;" onclick="desarEdicio()">Guardar Canvis</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0">‚öôÔ∏è Configuraci√≥</h2>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: bold; display: block; margin-bottom: 5px;">Clau API OpenAI (Per a futures funcions IA):</label>
                <input type="password" id="api-key-input" placeholder="sk-..." style="width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px;">
                <p style="font-size: 12px; color: #666;">Aquesta clau es desa nom√©s al teu navegador.</p>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn-perill" onclick="document.getElementById('settings-modal').style.display = 'none'">Tancar</button>
                <button class="btn-accio" style="margin-top:0; width: auto;" onclick="desarSettings()">Desar</button>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALS ---
        let projecteActual = [];
        let idCounter = 0;
        
        // Variables Editor Canvas
        let editorCtx, editorImgObj = new Image();
        let isDrawing = false, startX, startY, currentX, currentY;
        let currentDrawings = [];
        let currentTool = 'freehand';
        let drawColor = '#ff0000';
        let editorCurrentTargetId = null;

        // --- INICIALITZACI√ì ---
        window.onload = () => {
            const savedKey = localStorage.getItem('openai_api_key');
            if(savedKey) document.getElementById('api-key-input').value = savedKey;
            
            // Setup Canvas
            const canvas = document.getElementById('editor-canvas');
            editorCtx = canvas.getContext('2d');
            
            // Events ratol√≠/t√†ctil per al Canvas
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); const touch = e.touches[0]; const mouseEvent = new MouseEvent("mousedown", { clientX: touch.clientX, clientY: touch.clientY }); canvas.dispatchEvent(mouseEvent); }, {passive: false});
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const touch = e.touches[0]; const mouseEvent = new MouseEvent("mousemove", { clientX: touch.clientX, clientY: touch.clientY }); canvas.dispatchEvent(mouseEvent); }, {passive: false});
            canvas.addEventListener('touchend', (e) => { const mouseEvent = new MouseEvent("mouseup", {}); canvas.dispatchEvent(mouseEvent); }, {passive: false});

            editorImgObj.onload = drawEditorCanvas;
            editorImgObj.crossOrigin = "anonymous";
        };

        // --- CERCA ARASAAC ---
        async function cercarPictogrames() {
            const text = document.getElementById('cercador').value.trim().toLowerCase();
            const divResultats = document.getElementById('resultats');
            if (!text) return;
            
            divResultats.innerHTML = '<p>Buscant a ARASAAC...</p>';
            try {
                const res = await fetch(`https://api.arasaac.org/api/pictograms/ca/search/${encodeURIComponent(text)}`);
                if (!res.ok) throw new Error("No s'han trobat resultats");
                const dades = await res.json();
                
                divResultats.innerHTML = '';
                dades.forEach(picto => {
                    const imgUrl = `https://static.arasaac.org/pictograms/${picto._id}/${picto._id}_300.png`;
                    const paraula = picto.keywords[0]?.keyword || text;
                    
                    const div = document.createElement('div');
                    div.className = 'picto-resultat';
                    div.draggable = true;
                    div.ondragstart = (e) => {
                        e.dataTransfer.setData('imgUrl', imgUrl);
                        e.dataTransfer.setData('text', paraula);
                    };
                    div.onclick = () => afegirPictoTargeta(imgUrl, paraula);
                    
                    div.innerHTML = `
                        <img src="${imgUrl}" alt="${paraula}">
                        <div style="font-size: 14px; margin-top: 5px;">${paraula}</div>
                    `;
                    divResultats.appendChild(div);
                });
            } catch (err) {
                divResultats.innerHTML = '<p>Cap resultat trobat.</p>';
            }
        }

        // --- GESTI√ì DE TARGETES ---
        function afegirPictoTargeta(imgUrl, textText) {
            const novaTargeta = {
                id: 'targeta_' + idCounter++,
                img: imgUrl,
                text: textText,
                customImg: null // Per a edicions de l'editor
            };
            projecteActual.push(novaTargeta);
            renderitzarProjecte();
        }

        function esborrarTargeta(id) {
            projecteActual = projecteActual.filter(t => t.id !== id);
            renderitzarProjecte();
        }

        function actualitzarText(id, nouText) {
            const targeta = projecteActual.find(t => t.id === id);
            if(targeta) targeta.text = nouText;
        }

        function renderitzarProjecte() {
            const graella = document.getElementById('graella-targetes');
            graella.innerHTML = '';
            
            projecteActual.forEach(t => {
                const div = document.createElement('div');
                div.className = 'targeta';
                div.id = t.id;
                
                const imgSrc = t.customImg || t.img;
                
                div.innerHTML = `
                    <div class="targeta-controls no-print">
                        <button class="btn-icon" title="Editar Imatge" onclick="obrirEditor('${t.id}')">üé®</button>
                        <button class="btn-icon" style="color:red;" title="Esborrar" onclick="esborrarTargeta('${t.id}')">üóëÔ∏è</button>
                    </div>
                    <img src="${imgSrc}" alt="${t.text}">
                    <input type="text" value="${t.text}" onchange="actualitzarText('${t.id}', this.value)" placeholder="Escriu...">
                `;
                graella.appendChild(div);
            });
        }

        function actualitzarGraella() {
            const cols = document.getElementById('num-cols').value;
            document.documentElement.style.setProperty('--num-columnes', cols);
        }

        // --- DRAG AND DROP ---
        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev) {
            ev.preventDefault();
            const imgUrl = ev.dataTransfer.getData('imgUrl');
            const text = ev.dataTransfer.getData('text');
            if(imgUrl) afegirPictoTargeta(imgUrl, text);
        }

        // --- EDITOR DE TARGETES (CANVAS) ---
        function obrirEditor(id) {
            editorCurrentTargetId = id;
            const targeta = projecteActual.find(t => t.id === id);
            
            // Resetejar valors
            document.getElementById('ed-scale').value = 1;
            document.getElementById('ed-x').value = 0;
            document.getElementById('ed-y').value = 0;
            currentDrawings = [];
            currentTool = 'freehand';
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.tool-btn').classList.add('active'); // Freehand actiu per defecte
            
            const imgSrc = targeta.customImg || targeta.img;
            editorImgObj.src = imgSrc; 
            if(editorImgObj.complete) editorImgObj.onload();
            
            document.getElementById('editor-modal').style.display = 'flex';
        }

        function tancarEditor() {
            document.getElementById('editor-modal').style.display = 'none';
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function clearDrawings() {
            currentDrawings = [];
            drawEditorCanvas();
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) * (canvas.width / rect.width),
                y: (evt.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getMousePos(e.target, e);
            startX = currentX = pos.x;
            startY = currentY = pos.y;
            
            if (currentTool === 'freehand') {
                currentDrawings.push({ type: 'freehand', color: drawColor, points: [{x: startX, y: startY}] });
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getMousePos(e.target, e);
            currentX = pos.x;
            currentY = pos.y;

            if (currentTool === 'freehand') {
                currentDrawings[currentDrawings.length - 1].points.push({x: currentX, y: currentY});
            }
            drawEditorCanvas();
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            if (currentTool !== 'freehand') {
                currentDrawings.push({ type: currentTool, color: drawColor, start: {x: startX, y: startY}, end: {x: currentX, y: currentY} });
            }
            drawEditorCanvas();
        }

        function buildPath(ctx, shape) {
            ctx.beginPath();
            if (shape.type === 'freehand') {
                ctx.moveTo(shape.points[0].x, shape.points[0].y);
                for (let i = 1; i < shape.points.length; i++) {
                    ctx.lineTo(shape.points[i].x, shape.points[i].y);
                }
            } else if (shape.type === 'line') {
                ctx.moveTo(shape.start.x, shape.start.y);
                ctx.lineTo(shape.end.x, shape.end.y);
            } else if (shape.type === 'rect') {
                ctx.rect(shape.start.x, shape.start.y, shape.end.x - shape.start.x, shape.end.y - shape.start.y);
            } else if (shape.type === 'circle') {
                const r = Math.hypot(shape.end.x - shape.start.x, shape.end.y - shape.start.y);
                ctx.arc(shape.start.x, shape.start.y, r, 0, 2 * Math.PI);
            }
        }

        function drawEditorCanvas() {
            editorCtx.clearRect(0, 0, 300, 300);
            
            // Dibuixar la imatge de fons amb transformacions
            const scale = parseFloat(document.getElementById('ed-scale').value);
            const dx = parseFloat(document.getElementById('ed-x').value);
            const dy = parseFloat(document.getElementById('ed-y').value);
            
            editorCtx.save();
            editorCtx.translate(150 + dx, 150 + dy);
            editorCtx.scale(scale, scale);
            
            if (editorImgObj.src) {
                const aspect = editorImgObj.width / editorImgObj.height;
                let w = 280, h = 280;
                if (aspect > 1) h = w / aspect; else w = h * aspect;
                editorCtx.drawImage(editorImgObj, -w/2, -h/2, w, h);
            }
            editorCtx.restore();
            
            // Dibuixar formes
            editorCtx.lineCap = 'round';
            editorCtx.lineJoin = 'round';
            currentDrawings.forEach(shape => {
                editorCtx.strokeStyle = shape.color;
                editorCtx.lineWidth = 4;
                buildPath(editorCtx, shape);
                editorCtx.stroke();
            });
            
            // Dibuix actiu (no lliure)
            if(isDrawing && currentTool !== 'freehand') {
                editorCtx.strokeStyle = drawColor;
                editorCtx.lineWidth = 4;
                let tempShape = { type: currentTool, start: {x: startX, y: startY}, end: {x: currentX, y: currentY} };
                buildPath(editorCtx, tempShape);
                editorCtx.stroke();
            }
        }

        function desarEdicio() {
            const canvas = document.getElementById('editor-canvas');
            const dataURL = canvas.toDataURL('image/png');
            
            const targeta = projecteActual.find(t => t.id === editorCurrentTargetId);
            if(targeta) {
                targeta.customImg = dataURL;
                renderitzarProjecte();
            }
            tancarEditor();
        }

        // --- DESAR I CARREGAR (JSON) ---
        function desarProjecte() {
            if(projecteActual.length === 0) return alert("No hi ha targetes per desar!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projecteActual));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "picto_projecte.json");
            dlAnchorElem.click();
        }

        function carregarProjecte(event) {
            const file = event.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dades = JSON.parse(e.target.result);
                    if(Array.isArray(dades)) {
                        projecteActual = dades;
                        idCounter = dades.length; // per no repetir IDs
                        renderitzarProjecte();
                    }
                } catch(err) {
                    alert("Error en carregar l'arxiu. No √©s un format v√†lid.");
                }
            };
            reader.readAsText(file);
        }

        // --- CONFIGURACI√ì IA ---
        function obrirSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function desarSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            localStorage.setItem('openai_api_key', apiKey);
            document.getElementById('settings-modal').style.display = 'none';
            alert("Configuraci√≥ desada!");
        }
    </script>
</body>
</html>
